---------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/05_merge_fr
> ed_data.log
  log type:  text
 opened on:  12 Dec 2025, 17:31:05

. 
. ****************************************************
. * 1. Import 1-year Treasury yield (GS1)
. ****************************************************
. import delimited "$fred/GS1.csv", clear
(encoding automatically selected: ISO-8859-1)
(2 vars, 336 obs)

. 
. * Parse date and create quarterly date
. gen date = date(observation_date, "YMD")

. format date %td

. gen year = year(date)

. gen month = month(date)

. gen quarter = ceil(month/3)

. gen qdate = yq(year, quarter)

. format qdate %tq

. 
. * Rename variable
. rename GS1 treasury_1yr
variable GS1 not found
r(111);

end of do-file
r(111);

end of do-file

r(111);

. do "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/05_merge_fred_data
> .do"

. ****************************************************
. * 05_merge_fred_data.do
. * Import FRED data (industrial production, inflation, treasury yields)
. * Convert to quarterly and merge with Gini-BH shocks dataset
. ****************************************************
. 
. clear all

. set more off

. 
. global fred "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/FRED
> "

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. global code "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code"

. 
. * Start log file
. log using "$code/05_merge_fred_data.log", replace
log file already open
r(604);

end of do-file

r(604);

. do "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/05_merge_fred_data
> .do"

. ****************************************************
. * 05_merge_fred_data.do
. * Import FRED data (industrial production, inflation, treasury yields)
. * Convert to quarterly and merge with Gini-BH shocks dataset
. ****************************************************
. 
. clear all

. set more off

. 
. global fred "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/FRED
> "

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. global code "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code"

. 
. ****************************************************
. * 1. Import 1-year Treasury yield (GS1)
. ****************************************************
. import delimited "$fred/GS1.csv", clear
(encoding automatically selected: ISO-8859-1)
(2 vars, 336 obs)

. 
. * Parse date and create quarterly date
. gen date = date(observation_date, "YMD")

. format date %td

. gen year = year(date)

. gen month = month(date)

. gen quarter = ceil(month/3)

. gen qdate = yq(year, quarter)

. format qdate %tq

. 
. * Rename variable (Stata converts CSV headers to lowercase)
. rename gs1 treasury_1yr

. 
. * Collapse to quarterly (average monthly rates)
. collapse (mean) treasury_1yr, by(qdate year quarter)

. 
. * Save temporary file
. tempfile gs1

. save `gs1'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000001
    saved as .dta format

. 
. display "Imported GS1: " _N " quarterly observations"
Imported GS1: 112 quarterly observations

. 
. ****************************************************
. * 2. Import Industrial Production (INDPRO)
. ****************************************************
. import delimited "$fred/INDPRO.csv", clear
(encoding automatically selected: ISO-8859-1)
(2 vars, 336 obs)

. 
. * Parse date and create quarterly date
. gen date = date(observation_date, "YMD")

. format date %td

. gen year = year(date)

. gen month = month(date)

. gen quarter = ceil(month/3)

. gen qdate = yq(year, quarter)

. format qdate %tq

. 
. * Rename variable and take log (Stata converts CSV headers to lowercase)
. rename indpro indpro_raw

. gen log_indpro = log(indpro_raw)

. drop indpro_raw

. 
. * Collapse to quarterly (average of log levels)
. collapse (mean) log_indpro, by(qdate year quarter)

. 
. * Save temporary file
. tempfile indpro

. save `indpro'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. 
. display "Imported INDPRO: " _N " quarterly observations"
Imported INDPRO: 112 quarterly observations

. 
. ****************************************************
. * 3. Import Headline CPI (CPIAUCSL)
. ****************************************************
. import delimited "$fred/CPIAUCSL.csv", clear
(encoding automatically selected: ISO-8859-1)
(2 vars, 336 obs)

. 
. * Parse date and create quarterly date
. gen date = date(observation_date, "YMD")

. format date %td

. gen year = year(date)

. gen month = month(date)

. gen quarter = ceil(month/3)

. gen qdate = yq(year, quarter)

. format qdate %tq

. 
. * Rename variable and take log (Stata converts CSV headers to lowercase)
. rename cpiaucsl cpi_headline_raw

. gen log_cpi_headline = log(cpi_headline_raw)

. drop cpi_headline_raw

. 
. * Collapse to quarterly (average of log levels)
. collapse (mean) log_cpi_headline, by(qdate year quarter)

. 
. * Compute quarterly inflation as log difference
. sort qdate

. gen infl_headline = log_cpi_headline - log_cpi_headline[_n-1]
(1 missing value generated)

. 
. * Save temporary file
. tempfile cpi_headline

. save `cpi_headline'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000003
    saved as .dta format

. 
. display "Imported CPIAUCSL: " _N " quarterly observations"
Imported CPIAUCSL: 112 quarterly observations

. 
. ****************************************************
. * 4. Import Core CPI (CPILFESL)
. ****************************************************
. import delimited "$fred/CPILFESL.csv", clear
(encoding automatically selected: ISO-8859-1)
(2 vars, 336 obs)

. 
. * Parse date and create quarterly date
. gen date = date(observation_date, "YMD")

. format date %td

. gen year = year(date)

. gen month = month(date)

. gen quarter = ceil(month/3)

. gen qdate = yq(year, quarter)

. format qdate %tq

. 
. * Rename variable and take log (Stata converts CSV headers to lowercase)
. rename cpilfesl cpi_core_raw

. gen log_cpi_core = log(cpi_core_raw)

. drop cpi_core_raw

. 
. * Collapse to quarterly (average of log levels)
. collapse (mean) log_cpi_core, by(qdate year quarter)

. 
. * Compute quarterly inflation as log difference
. sort qdate

. gen infl_core = log_cpi_core - log_cpi_core[_n-1]
(1 missing value generated)

. 
. * Save temporary file
. tempfile cpi_core

. save `cpi_core'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000004
    saved as .dta format

. 
. display "Imported CPILFESL: " _N " quarterly observations"
Imported CPILFESL: 112 quarterly observations

. 
. ****************************************************
. * 5. Import Unemployment Rate (UNRATE)
. ****************************************************
. import delimited "$fred/UNRATE.csv", clear
(encoding automatically selected: ISO-8859-1)
(2 vars, 336 obs)

. 
. * Parse date and create quarterly date
. gen date = date(observation_date, "YMD")

. format date %td

. gen year = year(date)

. gen month = month(date)

. gen quarter = ceil(month/3)

. gen qdate = yq(year, quarter)

. format qdate %tq

. 
. * Variable is already lowercase (no rename needed)
. * unrate is the variable name
. 
. * Collapse to quarterly (average monthly rates)
. collapse (mean) unrate, by(qdate year quarter)

. 
. * Save temporary file
. tempfile unrate

. save `unrate'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000005
    saved as .dta format

. 
. display "Imported UNRATE: " _N " quarterly observations"
Imported UNRATE: 112 quarterly observations

. 
. ****************************************************
. * 6. Merge all FRED data together
. ****************************************************
. use `gs1', clear

. 
. merge 1:1 qdate using `indpro'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               112  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. merge 1:1 qdate using `cpi_headline'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               112  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. merge 1:1 qdate using `cpi_core'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               112  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. merge 1:1 qdate using `unrate'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               112  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Save combined FRED data
. save "$deriv/fred_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/fred_quarterly
    > .dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/fred_quarterly
    > .dta saved

. 
. display _n "=== FRED DATA SUMMARY ==="

=== FRED DATA SUMMARY ===

. describe

Contains data from /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/
> CEX/derived/fred_quarterly.dta
 Observations:           112                  
    Variables:            10                  12 Dec 2025 17:38
---------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------
year            float   %9.0g                 
quarter         float   %9.0g                 
qdate           float   %tq                   
treasury_1yr    float   %9.0g                 (mean) treasury_1yr
log_indpro      float   %9.0g                 (mean) log_indpro
log_cpi_headl~e float   %9.0g                 (mean) log_cpi_headline
infl_headline   float   %9.0g                 
log_cpi_core    float   %9.0g                 (mean) log_cpi_core
infl_core       float   %9.0g                 
unrate          float   %9.0g                 (mean) unrate
---------------------------------------------------------------------------
Sorted by: qdate

. summarize qdate

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
       qdate |        112       199.5    32.47563        144        255

. list in 1/10

     +----------------------------------------------------------+
  1. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1996 |       1 | 1996q1 | 5.123333 | 4.294415 | 5.043853 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |         .   |   5.100068   |          .   |   5.533333   |
     +----------------------------------------------------------+

     +----------------------------------------------------------+
  2. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1996 |       2 | 1996q2 | 5.663333 | 4.315837 | 5.052416 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |   .008563   |   5.105944   |   .0058756   |        5.5   |
     +----------------------------------------------------------+

     +----------------------------------------------------------+
  3. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1996 |       3 | 1996q3 | 5.783333 | 4.329019 | 5.058153 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |  .0057373   |   5.112387   |   .0064435   |   5.266666   |
     +----------------------------------------------------------+

     +----------------------------------------------------------+
  4. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1996 |       4 | 1996q4 |     5.48 | 4.343401 | 5.066803 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |  .0086498   |   5.118791   |   .0064034   |   5.333333   |
     +----------------------------------------------------------+

     +----------------------------------------------------------+
  5. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1997 |       1 | 1997q1 | 5.646667 | 4.362312 | 5.072879 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |  .0060759   |   5.124558   |   .0057673   |   5.233333   |
     +----------------------------------------------------------+

     +----------------------------------------------------------+
  6. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1997 |       2 | 1997q2 |     5.85 | 4.376868 | 5.075173 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |  .0022945   |   5.130884   |   .0063257   |          5   |
     +----------------------------------------------------------+

     +----------------------------------------------------------+
  7. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1997 |       3 | 1997q3 |     5.54 | 4.399949 | 5.080159 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |  .0049858   |   5.135209   |   .0043254   |   4.866667   |
     +----------------------------------------------------------+

     +----------------------------------------------------------+
  8. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1997 |       4 | 1997q4 | 5.483334 | 4.424819 | 5.085536 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |  .0053773   |   5.140882   |   .0056734   |   4.666667   |
     +----------------------------------------------------------+

     +----------------------------------------------------------+
  9. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1998 |       1 | 1998q1 | 5.313333 | 4.435836 | 5.087596 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |  .0020599   |   5.146912   |   .0060296   |   4.633333   |
     +----------------------------------------------------------+

     +----------------------------------------------------------+
 10. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1998 |       2 | 1998q2 |     5.41 | 4.442409 | 5.090882 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |  .0032854   |   5.152519   |   .0056071   |        4.4   |
     +----------------------------------------------------------+

. 
. ****************************************************
. * 7. Merge with existing Gini-BH shocks dataset
. ****************************************************
. use "$deriv/gini_bh_shocks_merged.dta", clear

. 
. display _n "=== GINI-BH SHOCKS DATA ==="

=== GINI-BH SHOCKS DATA ===

. count
  108

. summarize qdate

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
       qdate |        108    201.0556    32.02593        144        255

. 
. * Merge with FRED data
. merge 1:1 qdate using "$deriv/fred_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             4
        from master                         0  (_merge==1)
        from using                          4  (_merge==2)

    Matched                               108  (_merge==3)
    -----------------------------------------

. 
. display _n "=== MERGE RESULTS ==="

=== MERGE RESULTS ===

. tab _merge

   Matching result from |
                  merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
         Using only (2) |          4        3.57        3.57
            Matched (3) |        108       96.43      100.00
------------------------+-----------------------------------
                  Total |        112      100.00

. 
. * Keep only matched observations (or adjust as needed)
. keep if _merge == 3
(4 observations deleted)

. drop _merge

. 
. * Sort and order variables
. sort qdate

. order qdate year quarter gini_core gini_broad demand_shock_agg demand_sho
> ck_oil supply_shock ///
>     treasury_1yr log_indpro log_cpi_headline log_cpi_core infl_headline i
> nfl_core unrate

. 
. * Add variable labels
. label var treasury_1yr "1-year Treasury yield (%)"

. label var log_indpro "Log Industrial Production (quarterly average)"

. label var log_cpi_headline "Log Headline CPI (quarterly average)"

. label var log_cpi_core "Log Core CPI (quarterly average)"

. label var infl_headline "Headline inflation (quarterly, log difference)"

. label var infl_core "Core inflation (quarterly, log difference)"

. label var unrate "Unemployment rate (%)"

. 
. * Save final merged dataset
. save "$deriv/gini_bh_shocks_fred_merged.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_bh_shocks
    > _fred_merged.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_bh_shocks
    > _fred_merged.dta saved

. 
. display _n "=== FINAL MERGED DATASET ==="

=== FINAL MERGED DATASET ===

. describe

Contains data from /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/
> CEX/derived/gini_bh_shocks_fred_merged.dta
 Observations:           108                  
    Variables:            15                  12 Dec 2025 17:38
---------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------
qdate           float   %tq                   Stata quarterly date
year            float   %8.0g                 Year
quarter         float   %8.0g                 Quarter (. = annual)
gini_core       double  %10.0g                Gini coefficient - core
                                                consumption
gini_broad      double  %10.0g                Gini coefficient - broad
                                                consumption
demand_shock_~g double  %10.0g                BH aggregate demand shock
                                                (economic activity)
demand_shock_~l double  %10.0g                BH oil consumption demand
                                                shock (oil market)
supply_shock    double  %10.0g                BH supply shock
treasury_1yr    float   %9.0g                 1-year Treasury yield (%)
log_indpro      float   %9.0g                 Log Industrial Production
                                                (quarterly average)
log_cpi_headl~e float   %9.0g                 Log Headline CPI (quarterly
                                                average)
log_cpi_core    float   %9.0g                 Log Core CPI (quarterly
                                                average)
infl_headline   float   %9.0g                 Headline inflation
                                                (quarterly, log difference)
infl_core       float   %9.0g                 Core inflation (quarterly,
                                                log difference)
unrate          float   %9.0g                 Unemployment rate (%)
---------------------------------------------------------------------------
Sorted by: qdate

. count
  108

. local n_final = r(N)

. display _n "First 10 observations:"

First 10 observations:

. list in 1/10

     +--------------------------------------------------------------+
  1. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1996q1 | 1996 |       1 | .55468213 | .49419832 | -.22148647 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     |  .46885808 | -.32788254  | 5.123333  | 4.294415  | 5.043853  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.100068   |          .    |          .    |   5.533333    |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
  2. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1996q2 | 1996 |       2 | .56675941 | .50503184 |  .12724921 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     | -.83489113 | -.01555055  | 5.663333  | 4.315837  | 5.052416  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.105944   |    .008563    |   .0058756    |        5.5    |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
  3. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1996q3 | 1996 |       3 | .57520928 | .51438453 |   .1036368 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     |  2.4496306 | -.46768384  | 5.783333  | 4.329019  | 5.058153  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.112387   |   .0057373    |   .0064435    |   5.266666    |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
  4. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1996q4 | 1996 |       4 | .55639912 | .49887649 |  .15237911 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     |  .80256418 |  .15828993  |     5.48  | 4.343401  | 5.066803  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.118791   |   .0086498    |   .0064034    |   5.333333    |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
  5. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1997q1 | 1997 |       1 | .54642597 | .48424696 |  .33321874 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     | -4.4526498 |   .3023814  | 5.646667  | 4.362312  | 5.072879  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.124558   |   .0060759    |   .0057673    |   5.233333    |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
  6. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1997q2 | 1997 |       2 | .55785435 | .49735394 |  .19591498 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     | -.53291956 | -.07923579  |     5.85  | 4.376868  | 5.075173  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.130884   |   .0022945    |   .0063257    |          5    |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
  7. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1997q3 | 1997 |       3 | .56695318 | .50885453 |  .14971218 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     |  .57474204 | -.12677552  |     5.54  | 4.399949  | 5.080159  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.135209   |   .0049858    |   .0043254    |   4.866667    |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
  8. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1997q4 | 1997 |       4 | .54984284 | .49451624 | -.22458995 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     | -2.5309945 |  -.2951791  | 5.483334  | 4.424819  | 5.085536  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.140882   |   .0053773    |   .0056734    |   4.666667    |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
  9. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1998q1 | 1998 |       1 | .55603067 | .49286135 |  .04669203 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     | -1.7266199 |  1.4935128  | 5.313333  | 4.435836  | 5.087596  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.146912   |   .0020599    |   .0060296    |   4.633333    |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
 10. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1998q2 | 1998 |       2 | .57069699 | .50973879 | -.35200908 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     | -.43573239 |  .15393381  |     5.41  | 4.442409  | 5.090882  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.152519   |   .0032854    |   .0056071    |        4.4    |
     +--------------------------------------------------------------+

. if `n_final' > 10 {
.     display _n "Last 10 observations:"

Last 10 observations:
.     list in `=`n_final'-9'/`n_final'

     +--------------------------------------------------------------+
 99. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2021q3 | 2021 |       3 | .58081106 | .51128158 | -.27989836 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     |  2.5936906 | -.71784132  | .0766667  | 4.602325  | 5.609051  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.631673   |   .0159225    |   .0128717    |   5.066667    |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
100. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2021q4 | 2021 |       4 | .56104589 |  .4941321 |  .91520046 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     |  .05333804 |   .1080382  | .1966667  | 4.610566  | 5.630186  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.646942   |   .0211349    |   .0152688    |        4.2    |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
101. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2022q1 | 2022 |       1 | .56151048 |  .4920461 | -.37518262 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     |    5.75685 | -.81347367  | .9633334  | 4.613069  | 5.651919  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |    5.66307   |   .0217333    |   .0161281    |   3.833333    |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
102. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2022q2 | 2022 |       2 | .55958433 | .49410154 | -.03607096 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     |  1.6260728 | -.83130764  |      2.2  | 4.617728  | 5.675516  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.677337   |   .0235972    |   .0142674    |   3.633333    |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
103. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2022q3 | 2022 |       3 | .56590725 | .49909802 |  .16599138 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     | -1.1559269 |  .57953785  | 3.396667  | 4.617135  | 5.688692  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.692535   |    .013176    |   .0151982    |   3.533333    |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
104. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2022q4 | 2022 |       4 |  .5648933 | .49522039 | -.46528938 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     | -.56327645 |  -.5842276  | 4.613333  |  4.61171  | 5.698764  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.705033   |   .0100718    |   .0124979    |   3.566667    |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
105. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2023q1 | 2023 |       1 |  .5637275 | .49166846 |  .42797086 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     |  -1.471965 |  .09826106  | 4.766666  | 4.612366  | 5.707746  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.716918   |   .0089817    |   .0118847    |   3.533333    |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
106. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2023q2 | 2023 |       2 | .57187048 | .50254818 | -.25151829 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     |   .6693601 | -.23768009  | 4.943333  | 4.612801  | 5.715131  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.728368   |   .0073853    |   .0114503    |   3.533333    |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
107. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2023q3 | 2023 |       3 | .58067498 | .50861322 | -.28728549 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     |  2.5030403 | -1.0854051  | 5.393333  | 4.614351  | 5.723717  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.735732   |   .0085859    |   .0073638    |   3.666667    |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
108. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2023q4 | 2023 |       4 | .56300383 | .49200142 |  .03643316 |
     |--------------------------------------------------------------|
     | demand_s~l | supply_s~k  | treasu~r  | log_in~o  | log_c~ne  |
     | -2.9591179 |  .24835329  |     5.22  | 4.611601  | 5.730613  |
     |--------------------------------------------------------------|
     |   log_c~re   |   infl_h~e    |   infl_c~e    |     unrate    |
     |   5.744107   |    .006896    |   .0083747    |        3.8    |
     +--------------------------------------------------------------+
. }

. 
. display _n "Final dataset saved: $deriv/gini_bh_shocks_fred_merged.dta"

Final dataset saved: /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Dat
> a/CEX/derived/gini_bh_shocks_fred_merged.dta

. 
. 
end of do-file

. use "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw23
> /fmli234.dta"

. summarize FSALARYX

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
    FSALARYX |      4,662    66981.02    95582.38          0     825138

. summarize FINCBTAX

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
    FINCBTAX |      4,662    89183.93    106387.6      -9284    1149265

. do "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/00_run_all.do"

. ****************************************************
. * 00_run_all.do
. * Master file - runs entire Gini pipeline
. ****************************************************
. 
. clear all

. set more off

. 
. global code "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code"

. 
. * Step 1: Build all UCC maps
. display _n "=== Building UCC maps ===" _n

=== Building UCC maps ===


. do "$code/01_build_ucc_map.do"

. ****************************************************
. * 01_build_ucc_map.do
. * Build UCC mappings for all years 1996-2023
. ****************************************************
. 
. clear all

. set more off

. 
. global stubs "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /stubs"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture mkdir "$deriv"

. 
. ****************************************************
. * Loop through all years and build UCC maps
. ****************************************************
. forvalues year = 1996/2023 {
  2.     
.     display _n "Processing year `year'..."
  3.     
.     cd "$stubs"
  4.     
.     quietly {
  5.         infix ///
>             str1 line_type      1       ///
>             byte level          4       ///
>             str59 name          11-69   ///
>             str6 ucc_code       70-75   ///
>             str1 source         80      ///
>             byte factor         83      ///
>             str7 section        86-92   ///
>             using "CE-HG-Integ-`year'.txt", clear
  6.         
.         * Drop comment lines
.         drop if line_type=="*"
  7.         
.         * Drop empty ucc_code rows
.         drop if trim(ucc_code)==""
  8.         
.         * Keep only rows where ucc_code is all digits (real UCCs)
.         gen byte ucc_isnum = regexm(ucc_code, "^[0-9]+$")
  9.         keep if ucc_isnum
 10.         drop ucc_isnum
 11.         
.         * Extract section name (handles both "FOOD" and "1  FOOD" formats
> )
.         gen section_clean = word(section, -1)  // gets last word
 12.         
.         * Map abbreviations to full names
.         replace section_clean = "EXPEND" if section_clean == "EXPE"
 13.         replace section_clean = "ADDENDA" if section_clean == "ADDE"
 14.         replace section_clean = "ASSETS" if section_clean == "ASSE"
 15.         replace section_clean = "CUCHARS" if section_clean == "CUCH"
 16.         replace section_clean = "INCOME" if section_clean == "INCO"
 17.         
.         * Keep only expenditure sections
.         keep if inlist(section_clean, "FOOD", "EXPEND")
 18.         drop section
 19.         rename section_clean section
 20.         
.         * Make numeric UCC
.         destring ucc_code, gen(UCC) ignore(" ")
 21.         
.         keep UCC section name
 22.         compress
 23.         save "$deriv/ucc_map_`year'.dta", replace
 24.     }
 25.     
.     display "  Saved: ucc_map_`year'.dta"
 26. }

Processing year 1996...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_1996.dta

Processing year 1997...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_1997.dta

Processing year 1998...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_1998.dta

Processing year 1999...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_1999.dta

Processing year 2000...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2000.dta

Processing year 2001...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2001.dta

Processing year 2002...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2002.dta

Processing year 2003...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2003.dta

Processing year 2004...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2004.dta

Processing year 2005...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2005.dta

Processing year 2006...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2006.dta

Processing year 2007...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2007.dta

Processing year 2008...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2008.dta

Processing year 2009...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2009.dta

Processing year 2010...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2010.dta

Processing year 2011...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2011.dta

Processing year 2012...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2012.dta

Processing year 2013...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2013.dta

Processing year 2014...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2014.dta

Processing year 2015...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2015.dta

Processing year 2016...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2016.dta

Processing year 2017...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2017.dta

Processing year 2018...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2018.dta

Processing year 2019...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2019.dta

Processing year 2020...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2020.dta

Processing year 2021...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2021.dta

Processing year 2022...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2022.dta

Processing year 2023...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2023.dta

. 
. display _n "Done. UCC maps saved for 1996-2023."

Done. UCC maps saved for 1996-2023.

. 
end of do-file

. 
. * Step 2: Run each year's Gini computation
. display _n "=== Computing yearly Ginis ===" _n

=== Computing yearly Ginis ===


. forvalues y = 1996/2023 {
  2.     if `y' != 1999 {
  3.         display _n "Processing `y'..."
  4.         do "$code/02_gini_`y'.do"
  5.     }
  6. }

Processing 1996...

. ****************************************************
. * 02_gini_1996.do
. * Build 1996 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw96/intrvw96"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw96/intrvw
> 96

. 
. use mtbi961x.dta, clear

. foreach f in mtbi962 mtbi963 mtbi964 mtbi971 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_1996.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       601,279
        from master                   601,091  (_merge==1)
        from using                        188  (_merge==2)

    Matched                         1,735,121  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(601,279 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(200,853 real changes made, 200,853 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_1996_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_1996_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw96/intrvw
> 96

. preserve

. * Load first FMLI file and assign quarter
. use fmli961x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli962 fmli963 fmli964 fmli971 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable chldsupx was int, now long to accommodate using data's values)
(variable cshcntbx was int, now long to accommodate using data's values)
(variable finlwt21 was float, now double to accommodate using data's
       values)
(variable inclossb was int, now long to accommodate using data's values)
(variable othrincx was int, now long to accommodate using data's values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable cartkupq was int, now long to accommodate using data's values)
(variable trntrpcq was int, now long to accommodate using data's values)
(variable perscapq was int, now float to accommodate using data's values)
(variable perscacq was int, now float to accommodate using data's values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(5,437 real changes made)
(variable cbsgftx was int, now long to accommodate using data's values)
(variable collexpx was int, now long to accommodate using data's values)
(variable totexppq was float, now double to accommodate using data's
       values)
(variable trntrppq was int, now long to accommodate using data's values)
(variable entertpq was float, now double to accommodate using data's
       values)
(variable entertcq was float, now double to accommodate using data's
       values)
(variable otheqppq was float, now double to accommodate using data's
       values)
(variable otheqpcq was float, now double to accommodate using data's
       values)
(variable othentpq was float, now double to accommodate using data's
       values)
(variable othentcq was float, now double to accommodate using data's
       values)
(variable totex4pq was float, now double to accommodate using data's
       values)
(5,295 real changes made)
(variable alimox was int, now long to accommodate using data's values)
(5,480 real changes made)
(5,584 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 1996

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_1996_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_1996_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_1996_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_1996_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 1996

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             4
        from master                         0  (_merge==1)
        from using                          4  (_merge==2)

    Matched                            43,455  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(4 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(46 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_1996_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1996_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 1996

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_1996_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1996_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_1996_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_1996_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (1996) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_1996_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_1996_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (1996) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_1996_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.778       3.121       0.265       3.411
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.98398     0.46490     0.45439     0.76392     0.49600
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20376     0.37180     0.66307
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.334       2.712       0.370       2.777
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.49024     0.32835     0.33927     0.53221     0.43243
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15294     0.27989     0.49507
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 1996

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_1996_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_1996_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_1996_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_1996_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_1996_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_1996_quarterly.dta"

. erase "$deriv/gini_1996_income_quarterly.dta"

. erase "$deriv/gini_1996_annual.dta"

. 
. display _n "Saved: gini_1996_all.dta"

Saved: gini_1996_all.dta

. 
. 
end of do-file

Processing 1997...

. ****************************************************
. * 02_gini_1997.do
. * Build 1997 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw97/intrvw97/intrvw97"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw97/intrvw
> 97/intrvw97

. 
. use mtbi971x.dta, clear

. foreach f in mtbi972 mtbi973 mtbi974 mtbi981 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_1997.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       664,193
        from master                   664,009  (_merge==1)
        from using                        184  (_merge==2)

    Matched                         1,915,973  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(664,193 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(218,325 real changes made, 218,325 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_1997_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_1997_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw97/intrvw
> 97/intrvw97

. preserve

. * Load first FMLI file and assign quarter
. use fmli971x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli972 fmli973 fmli974 fmli981 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable cntrchrx was int, now long to accommodate using data's values)
(variable compowdx was int, now long to accommodate using data's values)
(variable wtrep01 was float, now double to accommodate using data's
       values)
(variable wtrep08 was float, now double to accommodate using data's
       values)
(variable wtrep21 was float, now double to accommodate using data's
       values)
(variable wtrep27 was float, now double to accommodate using data's
       values)
(variable wtrep40 was float, now double to accommodate using data's
       values)
(variable cartkncq was int, now long to accommodate using data's values)
(5,502 real changes made)
(variable compensx was int, now long to accommodate using data's values)
(variable fssix was int, now long to accommodate using data's values)
(variable wtrep06 was float, now double to accommodate using data's
       values)
(variable wtrep09 was float, now double to accommodate using data's
       values)
(variable wtrep13 was float, now double to accommodate using data's
       values)
(variable wtrep30 was float, now double to accommodate using data's
       values)
(variable wtrep31 was float, now double to accommodate using data's
       values)
(variable wtrep34 was float, now double to accommodate using data's
       values)
(variable wtrep43 was float, now double to accommodate using data's
       values)
(5,488 real changes made)
(variable alimox was int, now long to accommodate using data's values)
(variable chldsupx was int, now long to accommodate using data's values)
(variable collexpx was int, now long to accommodate using data's values)
(variable cshcntbx was int, now long to accommodate using data's values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable erankmth was float, now double to accommodate using data's
       values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(5,609 real changes made)
(variable cntrelgx was int, now long to accommodate using data's values)
(variable medsuppq was int, now float to accommodate using data's values)
(variable totex4pq was float, now double to accommodate using data's
       values)
(5,614 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 1997

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_1997_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_1997_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_1997_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_1997_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 1997

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         0  (_merge==1)
        from using                          2  (_merge==2)

    Matched                            46,245  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(2 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(51 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_1997_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1997_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 1997

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_1997_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1997_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_1997_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_1997_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (1997) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_1997_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_1997_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (1997) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_1997_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.467       3.053       0.266       3.319
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.04453     0.44984     0.42889     0.65831     0.48650
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.19572     0.36227     0.67628
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.223       2.657       0.368       2.710
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.49211     0.31838     0.32095     0.46320     0.42447
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14710     0.27268     0.49602
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 1997

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_1997_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_1997_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_1997_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_1997_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_1997_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_1997_quarterly.dta"

. erase "$deriv/gini_1997_income_quarterly.dta"

. erase "$deriv/gini_1997_annual.dta"

. 
. display _n "Saved: gini_1997_all.dta"

Saved: gini_1997_all.dta

. 
. 
end of do-file

Processing 1998...

. ****************************************************
. * 02_gini_1998.do
. * Build 1998 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw98/intrvw98/intrvw98"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw98/intrvw
> 98/intrvw98

. 
. use mtbi981x.dta, clear

. foreach f in mtbi982 mtbi983 mtbi984 mtbi991 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_1998.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       700,664
        from master                   700,453  (_merge==1)
        from using                        211  (_merge==2)

    Matched                         1,992,549  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(700,664 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(227,221 real changes made, 227,221 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_1998_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_1998_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw98/intrvw
> 98/intrvw98

. preserve

. * Load first FMLI file and assign quarter
. use fmli981x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli982 fmli983 fmli984 fmli991 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable inclossa was int, now long to accommodate using data's values)
(variable wdbsastx was int, now long to accommodate using data's values)
(variable wdbsgdsx was int, now long to accommodate using data's values)
(variable wtrep01 was float, now double to accommodate using data's
       values)
(variable wtrep04 was float, now double to accommodate using data's
       values)
(variable wtrep06 was float, now double to accommodate using data's
       values)
(variable wtrep13 was float, now double to accommodate using data's
       values)
(variable wtrep23 was float, now double to accommodate using data's
       values)
(variable wtrep27 was float, now double to accommodate using data's
       values)
(variable wtrep28 was float, now double to accommodate using data's
       values)
(variable wtrep30 was float, now double to accommodate using data's
       values)
(variable wtrep31 was float, now double to accommodate using data's
       values)
(variable wtrep38 was float, now double to accommodate using data's
       values)
(variable wtrep40 was float, now double to accommodate using data's
       values)
(variable wtrep43 was float, now double to accommodate using data's
       values)
(variable totexppq was float, now double to accommodate using data's
       values)
(variable cartkupq was int, now long to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(5,467 real changes made)
(variable cshcntbx was int, now long to accommodate using data's values)
(variable trntrppq was int, now long to accommodate using data's values)
(5,527 real changes made)
(variable collexpx was int, now long to accommodate using data's values)
(variable frretirx was int, now long to accommodate using data's values)
(variable fssix was int, now long to accommodate using data's values)
(variable wtrep03 was float, now double to accommodate using data's
       values)
(variable wtrep20 was float, now double to accommodate using data's
       values)
(variable wtrep35 was float, now double to accommodate using data's
       values)
(5,569 real changes made)
(variable cntrchrx was int, now long to accommodate using data's values)
(variable wtrep19 was float, now double to accommodate using data's
       values)
(variable medsupcq was int, now float to accommodate using data's values)
(7,015 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 1998

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_1998_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_1998_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_1998_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_1998_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 1998

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             1
        from master                         0  (_merge==1)
        from using                          1  (_merge==2)

    Matched                            49,150  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(1 observation deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(33 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_1998_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1998_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 1998

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_1998_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1998_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_1998_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_1998_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (1998) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_1998_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_1998_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (1998) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_1998_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.742       3.078       0.262       3.370
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.00055     0.46213     0.44550     0.70341     0.49368
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20162     0.37006     0.66679
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.416       2.721       0.367       2.732
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.50680     0.32570     0.33243     0.49523     0.42992
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15105     0.27798     0.50338
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 1998

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_1998_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_1998_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_1998_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_1998_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_1998_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_1998_quarterly.dta"

. erase "$deriv/gini_1998_income_quarterly.dta"

. erase "$deriv/gini_1998_annual.dta"

. 
. display _n "Saved: gini_1998_all.dta"

Saved: gini_1998_all.dta

. 
. 
end of do-file

Processing 2000...

. ****************************************************
. * 02_gini_2000.do
. * Build 2000 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw00/intrvw00"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw00/intrvw
> 00

. 
. use mtbi001x.dta, clear

. foreach f in mtbi002 mtbi003 mtbi004 mtbi011 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2000.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       911,332
        from master                   911,117  (_merge==1)
        from using                        215  (_merge==2)

    Matched                         2,507,936  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(911,332 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(287,234 real changes made, 287,234 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2000_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2000_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw00/intrvw
> 00

. preserve

. * Load first FMLI file and assign quarter
. use fmli001x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli002 fmli003 fmli004 fmli011 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable wtrep06 was float, now double to accommodate using data's
       values)
(variable wtrep08 was float, now double to accommodate using data's
       values)
(variable wtrep16 was float, now double to accommodate using data's
       values)
(variable wtrep21 was float, now double to accommodate using data's
       values)
(variable wtrep42 was float, now double to accommodate using data's
       values)
(variable wtrep44 was float, now double to accommodate using data's
       values)
(variable compensx was int, now long to accommodate using data's values)
(variable cntrchrx was int, now long to accommodate using data's values)
(variable fssix was int, now long to accommodate using data's values)
(variable rfueloip was byte, now int to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(variable ecartknp was int, now long to accommodate using data's values)
(7,809 real changes made)
(variable wtrep10 was float, now double to accommodate using data's
       values)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable wtrep29 was float, now double to accommodate using data's
       values)
(variable wtrep41 was float, now double to accommodate using data's
       values)
(variable cartkucq was int, now long to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable enomotrp was int, now long to accommodate using data's values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(variable etotacx4 was float, now double to accommodate using data's
       values)
(7,624 real changes made)
(variable alimox was int, now long to accommodate using data's values)
(variable furntrpq was int, now long to accommodate using data's values)
(variable rwaterpp was byte, now int to accommodate using data's values)
(variable eothvehp was int, now long to accommodate using data's values)
(7,717 real changes made)
(variable misc1cq was float, now double to accommodate using data's
       values)
(variable misccq was float, now double to accommodate using data's
       values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable miscx4cq was float, now double to accommodate using data's
       values)
(variable emiscelc was float, now double to accommodate using data's
       values)
(variable etotalc was float, now double to accommodate using data's
       values)
(7,712 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. capture rename fincbtax fincbtax

. capture rename fsalaryx fsalaryx

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 2000

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_2000_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2000_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2000_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2000_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2000

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             3
        from master                         0  (_merge==1)
        from using                          3  (_merge==2)

    Matched                            64,586  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(3 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(42 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2000_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2000_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2000

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2000_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2000_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2000_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2000_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2000) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2000_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2000_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2000) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2000_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.604       3.195       0.275       3.365
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.04806     0.47269     0.46134     0.75383     0.50097
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20697     0.37668     0.67701
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.612       2.797       0.367       2.806
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.58787     0.34338     0.34919     0.53068     0.44022
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15823     0.29063     0.54038
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2000

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2000_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2000_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2000_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2000_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2000_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2000_quarterly.dta"

. erase "$deriv/gini_2000_income_quarterly.dta"

. erase "$deriv/gini_2000_annual.dta"

. 
. display _n "Saved: gini_2000_all.dta"

Saved: gini_2000_all.dta

. 
end of do-file

Processing 2001...

. ****************************************************
. * 02_gini_2001.do
. * Build 2001 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw01/intrvw01"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw01/intrvw
> 01

. 
. use mtbi011x.dta, clear

. foreach f in mtbi012 mtbi013 mtbi014 mtbi021 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2001.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       854,573
        from master                   854,362  (_merge==1)
        from using                        211  (_merge==2)

    Matched                         2,554,552  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(854,573 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(284,024 real changes made, 284,024 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2001_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2001_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw01/intrvw
> 01

. preserve

. * Load first FMLI file and assign quarter
. use fmli011x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli012 fmli013 fmli014 fmli021 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable wtrep03 was float, now double to accommodate using data's
       values)
(variable wtrep04 was float, now double to accommodate using data's
       values)
(variable wtrep11 was float, now double to accommodate using data's
       values)
(variable wtrep14 was float, now double to accommodate using data's
       values)
(variable wtrep15 was float, now double to accommodate using data's
       values)
(variable wtrep17 was float, now double to accommodate using data's
       values)
(variable wtrep19 was float, now double to accommodate using data's
       values)
(variable wtrep22 was float, now double to accommodate using data's
       values)
(variable wtrep24 was float, now double to accommodate using data's
       values)
(variable wtrep27 was float, now double to accommodate using data's
       values)
(variable wtrep31 was float, now double to accommodate using data's
       values)
(variable wtrep33 was float, now double to accommodate using data's
       values)
(variable wtrep35 was float, now double to accommodate using data's
       values)
(variable wtrep36 was float, now double to accommodate using data's
       values)
(variable wtrep40 was float, now double to accommodate using data's
       values)
(variable fssix was int, now long to accommodate using data's values)
(variable fpripenx was int, now long to accommodate using data's values)
(variable perscacq was int, now float to accommodate using data's values)
(variable perscapq was int, now float to accommodate using data's values)
(variable educapq was int, now long to accommodate using data's values)
(variable mrtprnoc was int, now float to accommodate using data's values)
(variable vothrflc was byte, now int to accommodate using data's values)
(variable rfueloip was byte, now int to accommodate using data's values)
(variable emrtpnvc was int, now float to accommodate using data's values)
(variable emiscmtc was int, now float to accommodate using data's values)
(variable houscq was float, now double to accommodate using data's
       values)
(variable ehousngc was float, now double to accommodate using data's
       values)
(7,579 real changes made)
(variable wtrep02 was float, now double to accommodate using data's
       values)
(variable wtrep09 was float, now double to accommodate using data's
       values)
(variable wtrep10 was float, now double to accommodate using data's
       values)
(variable wtrep20 was float, now double to accommodate using data's
       values)
(variable wtrep21 was float, now double to accommodate using data's
       values)
(variable wtrep23 was float, now double to accommodate using data's
       values)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable wtrep32 was float, now double to accommodate using data's
       values)
(variable wtrep38 was float, now double to accommodate using data's
       values)
(variable hlfbathq was byte, now int to accommodate using data's values)
(variable inclsabx was int, now long to accommodate using data's values)
(variable othentpq was float, now double to accommodate using data's
       values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable otheqppq was float, now double to accommodate using data's
       values)
(variable entertpq was float, now double to accommodate using data's
       values)
(variable eothentp was float, now double to accommodate using data's
       values)
(variable eentrmtp was float, now double to accommodate using data's
       values)
(7,398 real changes made)
(variable salincbx was int, now long to accommodate using data's values)
(variable furntrcq was int, now long to accommodate using data's values)
(variable lifinscq was int, now long to accommodate using data's values)
(variable elctrcpq was int, now float to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable ecartknc was int, now long to accommodate using data's values)
(variable houseqcq was float, now double to accommodate using data's
       values)
(7,624 real changes made)
(7,691 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 2001

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_2001_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2001_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2001_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2001_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2001

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         0  (_merge==1)
        from using                          2  (_merge==2)

    Matched                            63,130  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(2 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(76 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2001_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2001_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2001

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2001_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2001_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2001_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2001_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2001) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2001_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2001_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2001) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2001_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     12.029       3.228       0.268       3.432
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.20772     0.48709     0.47779     0.96095     0.50531
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.21189     0.38559     0.70721
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.908       2.831       0.358       2.847
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.60286     0.35195     0.36099     0.65648     0.44388
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.16179     0.29668     0.54663
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2001

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2001_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2001_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2001_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2001_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2001_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2001_quarterly.dta"

. erase "$deriv/gini_2001_income_quarterly.dta"

. erase "$deriv/gini_2001_annual.dta"

. 
. display _n "Saved: gini_2001_all.dta"

Saved: gini_2001_all.dta

. 
end of do-file

Processing 2002...

. ****************************************************
. * 02_gini_2002.do
. * Build 2002 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw02/intrvw02"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw02/intrvw
> 02

. 
. use mtbi021x.dta, clear

. foreach f in mtbi022 mtbi023 mtbi024 mtbi031 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2002.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       878,637
        from master                   878,429  (_merge==1)
        from using                        208  (_merge==2)

    Matched                         2,673,644  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(878,637 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(293,262 real changes made, 293,262 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2002_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2002_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw02/intrvw
> 02

. preserve

. * Load first FMLI file and assign quarter
. use fmli021x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli022 fmli023 fmli024 fmli031 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable compbndx was int, now long to accommodate using data's values)
(variable compowdx was int, now long to accommodate using data's values)
(variable fpripenx was int, now long to accommodate using data's values)
(variable wdbsgdsx was int, now long to accommodate using data's values)
(variable wtrep02 was float, now double to accommodate using data's
       values)
(variable wtrep10 was float, now double to accommodate using data's
       values)
(variable wtrep20 was float, now double to accommodate using data's
       values)
(variable wtrep23 was float, now double to accommodate using data's
       values)
(variable wtrep26 was float, now double to accommodate using data's
       values)
(variable wtrep28 was float, now double to accommodate using data's
       values)
(variable wtrep32 was float, now double to accommodate using data's
       values)
(variable wtrep37 was float, now double to accommodate using data's
       values)
(variable wtrep38 was float, now double to accommodate using data's
       values)
(variable wtrep39 was float, now double to accommodate using data's
       values)
(variable wtrep43 was float, now double to accommodate using data's
       values)
(variable medsupcq was int, now float to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable tothentc was byte, now int to accommodate using data's values)
(variable utilrntc was byte, now int to accommodate using data's values)
(variable relectrc was byte, now int to accommodate using data's values)
(variable rnatlgap was byte, now int to accommodate using data's values)
(variable rnatlgac was byte, now int to accommodate using data's values)
(variable rwaterpp was byte, now int to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable unemplbx was int, now long to accommodate using data's values)
(7,778 real changes made)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable lifinscq was int, now long to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(variable compnsbx was int, now long to accommodate using data's values)
(variable inclsabx was int, now long to accommodate using data's values)
(7,833 real changes made)
(variable totexppq was float, now double to accommodate using data's
       values)
(variable furntrcq was int, now long to accommodate using data's values)
(variable totex4pq was float, now double to accommodate using data's
       values)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable otrincbx was int, now long to accommodate using data's values)
(8,024 real changes made)
(variable unemplx was int, now long to accommodate using data's values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable entertcq was float, now double to accommodate using data's
       values)
(variable otheqpcq was float, now double to accommodate using data's
       values)
(variable othentcq was float, now double to accommodate using data's
       values)
(variable miscpq was float, now double to accommodate using data's
       values)
(variable misc1pq was float, now double to accommodate using data's
       values)
(variable cashcopq was float, now double to accommodate using data's
       values)
(variable cashcocq was float, now double to accommodate using data's
       values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(variable miscx4pq was float, now double to accommodate using data's
       values)
(variable rothrflc was byte, now int to accommodate using data's values)
(variable rwaterpc was byte, now int to accommodate using data's values)
(variable etotalp was float, now double to accommodate using data's
       values)
(variable etotalc was float, now double to accommodate using data's
       values)
(variable etotapx4 was float, now double to accommodate using data's
       values)
(variable etotacx4 was float, now double to accommodate using data's
       values)
(variable emiscelp was float, now double to accommodate using data's
       values)
(8,086 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 2002

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_2002_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2002_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2002_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2002_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2002

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         0  (_merge==1)
        from using                          2  (_merge==2)

    Matched                            65,781  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(2 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(62 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2002_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2002_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2002

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2002_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2002_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2002_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2002_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2002) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2002_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2002_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2002) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2002_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     12.715       3.268       0.257       3.453
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.21721     0.48755     0.46471     0.77913     0.50375
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20999     0.38587     0.70883
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      8.017       2.839       0.354       2.840
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.69083     0.35293     0.35249     0.54950     0.44276
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.16055     0.29737     0.58013
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2002

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2002_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2002_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2002_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2002_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2002_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2002_quarterly.dta"

. erase "$deriv/gini_2002_income_quarterly.dta"

. erase "$deriv/gini_2002_annual.dta"

. 
. display _n "Saved: gini_2002_all.dta"

Saved: gini_2002_all.dta

. 
end of do-file

Processing 2003...

. ****************************************************
. * 02_gini_2003.do
. * Build 2003 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw03/intrvw03"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw03/intrvw
> 03

. 
. use mtbi031x.dta, clear

. foreach f in mtbi032 mtbi033 mtbi034 mtbi041 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2003.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       876,689
        from master                   876,479  (_merge==1)
        from using                        210  (_merge==2)

    Matched                         2,559,299  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(876,689 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(293,044 real changes made, 293,044 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2003_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2003_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw03/intrvw
> 03

. preserve

. * Load first FMLI file and assign quarter
. use fmli031x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli032 fmli033 fmli034 fmli041 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable compbndx was int, now long to accommodate using data's values)
(variable setlinsx was int, now long to accommodate using data's values)
(variable cartkucq was int, now long to accommodate using data's values)
(variable predrgpq was int, now float to accommodate using data's values)
(variable predrgcq was int, now float to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(variable rnatlgap was byte, now int to accommodate using data's values)
(variable rnatlgac was byte, now int to accommodate using data's values)
(variable ecartkup was int, now long to accommodate using data's values)
(8,196 real changes made)
(variable finlwt21 was float, now double to accommodate using data's
       values)
(variable othrincx was int, now long to accommodate using data's values)
(variable educapq was int, now long to accommodate using data's values)
(variable educacq was int, now long to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable salincbx was int, now long to accommodate using data's values)
(8,072 real changes made)
(variable fpripenx was int, now long to accommodate using data's values)
(variable fssix was int, now long to accommodate using data's values)
(variable rfueloic was byte, now int to accommodate using data's values)
(variable ecartkuc was int, now long to accommodate using data's values)
(8,044 real changes made)
(variable wtrep06 was float, now double to accommodate using data's
       values)
(variable wtrep08 was float, now double to accommodate using data's
       values)
(variable houspq was float, now double to accommodate using data's
       values)
(variable entertpq was float, now double to accommodate using data's
       values)
(variable otheqppq was float, now double to accommodate using data's
       values)
(variable othentpq was float, now double to accommodate using data's
       values)
(variable ehousngp was float, now double to accommodate using data's
       values)
(variable eentrmtp was float, now double to accommodate using data's
       values)
(variable eothentp was float, now double to accommodate using data's
       values)
(variable inclsabx was int, now long to accommodate using data's values)
(7,976 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 2003

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_2003_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2003_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2003_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2003_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2003

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            10
        from master                         0  (_merge==1)
        from using                         10  (_merge==2)

    Matched                            67,309  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(10 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(47 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2003_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2003_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2003

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2003_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2003_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2003_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2003_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2003) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2003_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2003_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2003) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2003_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     12.778       3.267       0.256       3.469
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.43523     0.50389     0.48988     0.86519     0.51226
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.21791     0.39582     0.74163
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.893       2.803       0.355       2.800
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.74392     0.35867     0.36893     0.61061     0.44753
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.16500     0.30139     0.59805
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2003

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2003_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2003_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2003_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2003_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2003_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2003_quarterly.dta"

. erase "$deriv/gini_2003_income_quarterly.dta"

. erase "$deriv/gini_2003_annual.dta"

. 
. display _n "Saved: gini_2003_all.dta"

Saved: gini_2003_all.dta

. 
end of do-file

Processing 2004...

. ****************************************************
. * 02_gini_2004.do
. * Build 2004 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw04/intrvw04"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw04/intrvw
> 04

. 
. use mtbi041x.dta, clear

. foreach f in mtbi042 mtbi043 mtbi044 mtbi051 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2004.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       847,738
        from master                   847,539  (_merge==1)
        from using                        199  (_merge==2)

    Matched                         2,450,047  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(847,738 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(280,276 real changes made, 280,276 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2004_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2004_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw04/intrvw
> 04

. preserve

. * Load first FMLI file and assign quarter
. use fmli041x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli042 fmli043 fmli044 fmli051 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable wtrep09 was float, now double to accommodate using data's
       values)
(variable wtrep10 was float, now double to accommodate using data's
       values)
(variable wtrep16 was float, now double to accommodate using data's
       values)
(variable wtrep23 was float, now double to accommodate using data's
       values)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable wtrep38 was float, now double to accommodate using data's
       values)
(variable wtrep41 was float, now double to accommodate using data's
       values)
(variable wtrep42 was float, now double to accommodate using data's
       values)
(variable wtrep43 was float, now double to accommodate using data's
       values)
(variable wtrep44 was float, now double to accommodate using data's
       values)
(variable transpq was float, now double to accommodate using data's
       values)
(variable educapq was int, now float to accommodate using data's values)
(variable educacq was int, now float to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable rfueloip was byte, now int to accommodate using data's values)
(variable rfueloic was byte, now int to accommodate using data's values)
(variable lmpsumbx was int, now long to accommodate using data's values)
(variable compens1 was int, now long to accommodate using data's values)
(variable compens2 was int, now long to accommodate using data's values)
(variable compens3 was int, now long to accommodate using data's values)
(variable compens4 was int, now long to accommodate using data's values)
(variable compens5 was int, now long to accommodate using data's values)
(7,779 real changes made)
(variable compbndx was int, now long to accommodate using data's values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable cashcocq was float, now double to accommodate using data's
       values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(variable etotalc was float, now double to accommodate using data's
       values)
(variable etotacx4 was float, now double to accommodate using data's
       values)
(variable enomotrp was int, now long to accommodate using data's values)
(7,643 real changes made)
(variable wtrep02 was float, now double to accommodate using data's
       values)
(variable wtrep20 was float, now double to accommodate using data's
       values)
(variable wtrep28 was float, now double to accommodate using data's
       values)
(variable wtrep32 was float, now double to accommodate using data's
       values)
(variable wtrep37 was float, now double to accommodate using data's
       values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(7,687 real changes made)
(variable trntrppq was int, now long to accommodate using data's values)
(variable ttranprp was int, now long to accommodate using data's values)
(variable ttrntrip was int, now long to accommodate using data's values)
(variable tfarep was int, now long to accommodate using data's values)
(variable chdlmpb was str1, now str2 to accommodate using data's values)
(variable chdlmpbx was byte, now int to accommodate using data's values)
(variable aliothbx was int, now long to accommodate using data's values)
(7,759 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter
variable fincbtax not found
r(111);

end of do-file
r(111);

end of do-file

r(111);

. use "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw19
> /intrvw19/fmli191x.dta"

. use "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw21
> /fmli212.dta"

. use "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw20
> /fmli202.dta"

. do "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/00_run_all.do"

. ****************************************************
. * 00_run_all.do
. * Master file - runs entire Gini pipeline
. ****************************************************
. 
. clear all

. set more off

. 
. global code "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code"

. 
. * Step 1: Build all UCC maps
. display _n "=== Building UCC maps ===" _n

=== Building UCC maps ===


. do "$code/01_build_ucc_map.do"

. ****************************************************
. * 01_build_ucc_map.do
. * Build UCC mappings for all years 1996-2023
. ****************************************************
. 
. clear all

. set more off

. 
. global stubs "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /stubs"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture mkdir "$deriv"

. 
. ****************************************************
. * Loop through all years and build UCC maps
. ****************************************************
. forvalues year = 1996/2023 {
  2.     
.     display _n "Processing year `year'..."
  3.     
.     cd "$stubs"
  4.     
.     quietly {
  5.         infix ///
>             str1 line_type      1       ///
>             byte level          4       ///
>             str59 name          11-69   ///
>             str6 ucc_code       70-75   ///
>             str1 source         80      ///
>             byte factor         83      ///
>             str7 section        86-92   ///
>             using "CE-HG-Integ-`year'.txt", clear
  6.         
.         * Drop comment lines
.         drop if line_type=="*"
  7.         
.         * Drop empty ucc_code rows
.         drop if trim(ucc_code)==""
  8.         
.         * Keep only rows where ucc_code is all digits (real UCCs)
.         gen byte ucc_isnum = regexm(ucc_code, "^[0-9]+$")
  9.         keep if ucc_isnum
 10.         drop ucc_isnum
 11.         
.         * Extract section name (handles both "FOOD" and "1  FOOD" formats
> )
.         gen section_clean = word(section, -1)  // gets last word
 12.         
.         * Map abbreviations to full names
.         replace section_clean = "EXPEND" if section_clean == "EXPE"
 13.         replace section_clean = "ADDENDA" if section_clean == "ADDE"
 14.         replace section_clean = "ASSETS" if section_clean == "ASSE"
 15.         replace section_clean = "CUCHARS" if section_clean == "CUCH"
 16.         replace section_clean = "INCOME" if section_clean == "INCO"
 17.         
.         * Keep only expenditure sections
.         keep if inlist(section_clean, "FOOD", "EXPEND")
 18.         drop section
 19.         rename section_clean section
 20.         
.         * Make numeric UCC
.         destring ucc_code, gen(UCC) ignore(" ")
 21.         
.         keep UCC section name
 22.         compress
 23.         save "$deriv/ucc_map_`year'.dta", replace
 24.     }
 25.     
.     display "  Saved: ucc_map_`year'.dta"
 26. }

Processing year 1996...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_1996.dta

Processing year 1997...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_1997.dta

Processing year 1998...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_1998.dta

Processing year 1999...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_1999.dta

Processing year 2000...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2000.dta

Processing year 2001...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2001.dta

Processing year 2002...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2002.dta

Processing year 2003...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2003.dta

Processing year 2004...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2004.dta

Processing year 2005...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2005.dta

Processing year 2006...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2006.dta

Processing year 2007...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2007.dta

Processing year 2008...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2008.dta

Processing year 2009...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2009.dta

Processing year 2010...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2010.dta

Processing year 2011...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2011.dta

Processing year 2012...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2012.dta

Processing year 2013...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2013.dta

Processing year 2014...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2014.dta

Processing year 2015...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2015.dta

Processing year 2016...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2016.dta

Processing year 2017...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2017.dta

Processing year 2018...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2018.dta

Processing year 2019...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2019.dta

Processing year 2020...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2020.dta

Processing year 2021...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2021.dta

Processing year 2022...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2022.dta

Processing year 2023...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2023.dta

. 
. display _n "Done. UCC maps saved for 1996-2023."

Done. UCC maps saved for 1996-2023.

. 
end of do-file

. 
. * Step 2: Run each year's Gini computation
. display _n "=== Computing yearly Ginis ===" _n

=== Computing yearly Ginis ===


. forvalues y = 1996/2023 {
  2.     if `y' != 1999 {
  3.         display _n "Processing `y'..."
  4.         do "$code/02_gini_`y'.do"
  5.     }
  6. }

Processing 1996...

. ****************************************************
. * 02_gini_1996.do
. * Build 1996 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw96/intrvw96"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw96/intrvw
> 96

. 
. use mtbi961x.dta, clear

. foreach f in mtbi962 mtbi963 mtbi964 mtbi971 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_1996.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       601,279
        from master                   601,091  (_merge==1)
        from using                        188  (_merge==2)

    Matched                         1,735,121  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(601,279 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(200,853 real changes made, 200,853 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_1996_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_1996_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw96/intrvw
> 96

. preserve

. * Load first FMLI file and assign quarter
. use fmli961x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli962 fmli963 fmli964 fmli971 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable chldsupx was int, now long to accommodate using data's values)
(variable cshcntbx was int, now long to accommodate using data's values)
(variable finlwt21 was float, now double to accommodate using data's
       values)
(variable inclossb was int, now long to accommodate using data's values)
(variable othrincx was int, now long to accommodate using data's values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable cartkupq was int, now long to accommodate using data's values)
(variable trntrpcq was int, now long to accommodate using data's values)
(variable perscapq was int, now float to accommodate using data's values)
(variable perscacq was int, now float to accommodate using data's values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(5,437 real changes made)
(variable cbsgftx was int, now long to accommodate using data's values)
(variable collexpx was int, now long to accommodate using data's values)
(variable totexppq was float, now double to accommodate using data's
       values)
(variable trntrppq was int, now long to accommodate using data's values)
(variable entertpq was float, now double to accommodate using data's
       values)
(variable entertcq was float, now double to accommodate using data's
       values)
(variable otheqppq was float, now double to accommodate using data's
       values)
(variable otheqpcq was float, now double to accommodate using data's
       values)
(variable othentpq was float, now double to accommodate using data's
       values)
(variable othentcq was float, now double to accommodate using data's
       values)
(variable totex4pq was float, now double to accommodate using data's
       values)
(5,295 real changes made)
(variable alimox was int, now long to accommodate using data's values)
(5,480 real changes made)
(5,584 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 1996

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_1996_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_1996_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_1996_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 1996

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             4
        from master                         0  (_merge==1)
        from using                          4  (_merge==2)

    Matched                            43,455  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(4 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(46 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_1996_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1996_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 1996

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_1996_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1996_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_1996_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_1996_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (1996) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_1996_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_1996_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (1996) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_1996_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.778       3.121       0.265       3.411
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.98398     0.46490     0.45439     0.76392     0.49600
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20376     0.37180     0.66307
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.334       2.712       0.370       2.777
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.49024     0.32835     0.33927     0.53221     0.43243
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15294     0.27989     0.49507
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 1996

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_1996_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_1996_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_1996_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_1996_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_1996_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_1996_quarterly.dta"

. erase "$deriv/gini_1996_income_quarterly.dta"

. erase "$deriv/gini_1996_annual.dta"

. 
. display _n "Saved: gini_1996_all.dta"

Saved: gini_1996_all.dta

. 
. 
end of do-file

Processing 1997...

. ****************************************************
. * 02_gini_1997.do
. * Build 1997 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw97/intrvw97/intrvw97"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw97/intrvw
> 97/intrvw97

. 
. use mtbi971x.dta, clear

. foreach f in mtbi972 mtbi973 mtbi974 mtbi981 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_1997.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       664,193
        from master                   664,009  (_merge==1)
        from using                        184  (_merge==2)

    Matched                         1,915,973  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(664,193 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(218,325 real changes made, 218,325 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_1997_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_1997_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw97/intrvw
> 97/intrvw97

. preserve

. * Load first FMLI file and assign quarter
. use fmli971x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli972 fmli973 fmli974 fmli981 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable cntrchrx was int, now long to accommodate using data's values)
(variable compowdx was int, now long to accommodate using data's values)
(variable wtrep01 was float, now double to accommodate using data's
       values)
(variable wtrep08 was float, now double to accommodate using data's
       values)
(variable wtrep21 was float, now double to accommodate using data's
       values)
(variable wtrep27 was float, now double to accommodate using data's
       values)
(variable wtrep40 was float, now double to accommodate using data's
       values)
(variable cartkncq was int, now long to accommodate using data's values)
(5,502 real changes made)
(variable compensx was int, now long to accommodate using data's values)
(variable fssix was int, now long to accommodate using data's values)
(variable wtrep06 was float, now double to accommodate using data's
       values)
(variable wtrep09 was float, now double to accommodate using data's
       values)
(variable wtrep13 was float, now double to accommodate using data's
       values)
(variable wtrep30 was float, now double to accommodate using data's
       values)
(variable wtrep31 was float, now double to accommodate using data's
       values)
(variable wtrep34 was float, now double to accommodate using data's
       values)
(variable wtrep43 was float, now double to accommodate using data's
       values)
(5,488 real changes made)
(variable alimox was int, now long to accommodate using data's values)
(variable chldsupx was int, now long to accommodate using data's values)
(variable collexpx was int, now long to accommodate using data's values)
(variable cshcntbx was int, now long to accommodate using data's values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable erankmth was float, now double to accommodate using data's
       values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(5,609 real changes made)
(variable cntrelgx was int, now long to accommodate using data's values)
(variable medsuppq was int, now float to accommodate using data's values)
(variable totex4pq was float, now double to accommodate using data's
       values)
(5,614 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 1997

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_1997_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_1997_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_1997_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 1997

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         0  (_merge==1)
        from using                          2  (_merge==2)

    Matched                            46,245  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(2 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(51 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_1997_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1997_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 1997

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_1997_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1997_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_1997_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_1997_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (1997) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_1997_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_1997_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (1997) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_1997_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.467       3.053       0.266       3.319
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.04453     0.44984     0.42889     0.65831     0.48650
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.19572     0.36227     0.67628
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.223       2.657       0.368       2.710
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.49211     0.31838     0.32095     0.46320     0.42447
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14710     0.27268     0.49602
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 1997

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_1997_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_1997_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_1997_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_1997_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_1997_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_1997_quarterly.dta"

. erase "$deriv/gini_1997_income_quarterly.dta"

. erase "$deriv/gini_1997_annual.dta"

. 
. display _n "Saved: gini_1997_all.dta"

Saved: gini_1997_all.dta

. 
. 
end of do-file

Processing 1998...

. ****************************************************
. * 02_gini_1998.do
. * Build 1998 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw98/intrvw98/intrvw98"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw98/intrvw
> 98/intrvw98

. 
. use mtbi981x.dta, clear

. foreach f in mtbi982 mtbi983 mtbi984 mtbi991 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_1998.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       700,664
        from master                   700,453  (_merge==1)
        from using                        211  (_merge==2)

    Matched                         1,992,549  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(700,664 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(227,221 real changes made, 227,221 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_1998_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_1998_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw98/intrvw
> 98/intrvw98

. preserve

. * Load first FMLI file and assign quarter
. use fmli981x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli982 fmli983 fmli984 fmli991 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable inclossa was int, now long to accommodate using data's values)
(variable wdbsastx was int, now long to accommodate using data's values)
(variable wdbsgdsx was int, now long to accommodate using data's values)
(variable wtrep01 was float, now double to accommodate using data's
       values)
(variable wtrep04 was float, now double to accommodate using data's
       values)
(variable wtrep06 was float, now double to accommodate using data's
       values)
(variable wtrep13 was float, now double to accommodate using data's
       values)
(variable wtrep23 was float, now double to accommodate using data's
       values)
(variable wtrep27 was float, now double to accommodate using data's
       values)
(variable wtrep28 was float, now double to accommodate using data's
       values)
(variable wtrep30 was float, now double to accommodate using data's
       values)
(variable wtrep31 was float, now double to accommodate using data's
       values)
(variable wtrep38 was float, now double to accommodate using data's
       values)
(variable wtrep40 was float, now double to accommodate using data's
       values)
(variable wtrep43 was float, now double to accommodate using data's
       values)
(variable totexppq was float, now double to accommodate using data's
       values)
(variable cartkupq was int, now long to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(5,467 real changes made)
(variable cshcntbx was int, now long to accommodate using data's values)
(variable trntrppq was int, now long to accommodate using data's values)
(5,527 real changes made)
(variable collexpx was int, now long to accommodate using data's values)
(variable frretirx was int, now long to accommodate using data's values)
(variable fssix was int, now long to accommodate using data's values)
(variable wtrep03 was float, now double to accommodate using data's
       values)
(variable wtrep20 was float, now double to accommodate using data's
       values)
(variable wtrep35 was float, now double to accommodate using data's
       values)
(5,569 real changes made)
(variable cntrchrx was int, now long to accommodate using data's values)
(variable wtrep19 was float, now double to accommodate using data's
       values)
(variable medsupcq was int, now float to accommodate using data's values)
(7,015 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 1998

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_1998_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_1998_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_1998_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 1998

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             1
        from master                         0  (_merge==1)
        from using                          1  (_merge==2)

    Matched                            49,150  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(1 observation deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(33 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_1998_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1998_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 1998

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_1998_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1998_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_1998_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_1998_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (1998) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_1998_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_1998_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (1998) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_1998_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.742       3.078       0.262       3.370
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.00055     0.46213     0.44550     0.70341     0.49368
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20162     0.37006     0.66679
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.416       2.721       0.367       2.732
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.50680     0.32570     0.33243     0.49523     0.42992
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15105     0.27798     0.50338
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 1998

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_1998_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_1998_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_1998_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_1998_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_1998_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_1998_quarterly.dta"

. erase "$deriv/gini_1998_income_quarterly.dta"

. erase "$deriv/gini_1998_annual.dta"

. 
. display _n "Saved: gini_1998_all.dta"

Saved: gini_1998_all.dta

. 
. 
end of do-file

Processing 2000...

. ****************************************************
. * 02_gini_2000.do
. * Build 2000 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw00/intrvw00"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw00/intrvw
> 00

. 
. use mtbi001x.dta, clear

. foreach f in mtbi002 mtbi003 mtbi004 mtbi011 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2000.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       911,332
        from master                   911,117  (_merge==1)
        from using                        215  (_merge==2)

    Matched                         2,507,936  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(911,332 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(287,234 real changes made, 287,234 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2000_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2000_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw00/intrvw
> 00

. preserve

. * Load first FMLI file and assign quarter
. use fmli001x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli002 fmli003 fmli004 fmli011 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable wtrep06 was float, now double to accommodate using data's
       values)
(variable wtrep08 was float, now double to accommodate using data's
       values)
(variable wtrep16 was float, now double to accommodate using data's
       values)
(variable wtrep21 was float, now double to accommodate using data's
       values)
(variable wtrep42 was float, now double to accommodate using data's
       values)
(variable wtrep44 was float, now double to accommodate using data's
       values)
(variable compensx was int, now long to accommodate using data's values)
(variable cntrchrx was int, now long to accommodate using data's values)
(variable fssix was int, now long to accommodate using data's values)
(variable rfueloip was byte, now int to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(variable ecartknp was int, now long to accommodate using data's values)
(7,809 real changes made)
(variable wtrep10 was float, now double to accommodate using data's
       values)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable wtrep29 was float, now double to accommodate using data's
       values)
(variable wtrep41 was float, now double to accommodate using data's
       values)
(variable cartkucq was int, now long to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable enomotrp was int, now long to accommodate using data's values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(variable etotacx4 was float, now double to accommodate using data's
       values)
(7,624 real changes made)
(variable alimox was int, now long to accommodate using data's values)
(variable furntrpq was int, now long to accommodate using data's values)
(variable rwaterpp was byte, now int to accommodate using data's values)
(variable eothvehp was int, now long to accommodate using data's values)
(7,717 real changes made)
(variable misc1cq was float, now double to accommodate using data's
       values)
(variable misccq was float, now double to accommodate using data's
       values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable miscx4cq was float, now double to accommodate using data's
       values)
(variable emiscelc was float, now double to accommodate using data's
       values)
(variable etotalc was float, now double to accommodate using data's
       values)
(7,712 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. capture rename fincbtax fincbtax

. capture rename fsalaryx fsalaryx

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 2000

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_2000_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2000_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2000_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2000

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             3
        from master                         0  (_merge==1)
        from using                          3  (_merge==2)

    Matched                            64,586  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(3 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(42 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2000_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2000_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2000

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2000_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2000_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2000_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2000_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2000) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2000_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2000_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2000) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2000_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.604       3.195       0.275       3.365
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.04806     0.47269     0.46134     0.75383     0.50097
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20697     0.37668     0.67701
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.612       2.797       0.367       2.806
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.58787     0.34338     0.34919     0.53068     0.44022
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15823     0.29063     0.54038
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2000

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2000_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2000_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2000_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2000_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2000_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2000_quarterly.dta"

. erase "$deriv/gini_2000_income_quarterly.dta"

. erase "$deriv/gini_2000_annual.dta"

. 
. display _n "Saved: gini_2000_all.dta"

Saved: gini_2000_all.dta

. 
end of do-file

Processing 2001...

. ****************************************************
. * 02_gini_2001.do
. * Build 2001 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw01/intrvw01"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw01/intrvw
> 01

. 
. use mtbi011x.dta, clear

. foreach f in mtbi012 mtbi013 mtbi014 mtbi021 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2001.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       854,573
        from master                   854,362  (_merge==1)
        from using                        211  (_merge==2)

    Matched                         2,554,552  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(854,573 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(284,024 real changes made, 284,024 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2001_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2001_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw01/intrvw
> 01

. preserve

. * Load first FMLI file and assign quarter
. use fmli011x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli012 fmli013 fmli014 fmli021 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable wtrep03 was float, now double to accommodate using data's
       values)
(variable wtrep04 was float, now double to accommodate using data's
       values)
(variable wtrep11 was float, now double to accommodate using data's
       values)
(variable wtrep14 was float, now double to accommodate using data's
       values)
(variable wtrep15 was float, now double to accommodate using data's
       values)
(variable wtrep17 was float, now double to accommodate using data's
       values)
(variable wtrep19 was float, now double to accommodate using data's
       values)
(variable wtrep22 was float, now double to accommodate using data's
       values)
(variable wtrep24 was float, now double to accommodate using data's
       values)
(variable wtrep27 was float, now double to accommodate using data's
       values)
(variable wtrep31 was float, now double to accommodate using data's
       values)
(variable wtrep33 was float, now double to accommodate using data's
       values)
(variable wtrep35 was float, now double to accommodate using data's
       values)
(variable wtrep36 was float, now double to accommodate using data's
       values)
(variable wtrep40 was float, now double to accommodate using data's
       values)
(variable fssix was int, now long to accommodate using data's values)
(variable fpripenx was int, now long to accommodate using data's values)
(variable perscacq was int, now float to accommodate using data's values)
(variable perscapq was int, now float to accommodate using data's values)
(variable educapq was int, now long to accommodate using data's values)
(variable mrtprnoc was int, now float to accommodate using data's values)
(variable vothrflc was byte, now int to accommodate using data's values)
(variable rfueloip was byte, now int to accommodate using data's values)
(variable emrtpnvc was int, now float to accommodate using data's values)
(variable emiscmtc was int, now float to accommodate using data's values)
(variable houscq was float, now double to accommodate using data's
       values)
(variable ehousngc was float, now double to accommodate using data's
       values)
(7,579 real changes made)
(variable wtrep02 was float, now double to accommodate using data's
       values)
(variable wtrep09 was float, now double to accommodate using data's
       values)
(variable wtrep10 was float, now double to accommodate using data's
       values)
(variable wtrep20 was float, now double to accommodate using data's
       values)
(variable wtrep21 was float, now double to accommodate using data's
       values)
(variable wtrep23 was float, now double to accommodate using data's
       values)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable wtrep32 was float, now double to accommodate using data's
       values)
(variable wtrep38 was float, now double to accommodate using data's
       values)
(variable hlfbathq was byte, now int to accommodate using data's values)
(variable inclsabx was int, now long to accommodate using data's values)
(variable othentpq was float, now double to accommodate using data's
       values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable otheqppq was float, now double to accommodate using data's
       values)
(variable entertpq was float, now double to accommodate using data's
       values)
(variable eothentp was float, now double to accommodate using data's
       values)
(variable eentrmtp was float, now double to accommodate using data's
       values)
(7,398 real changes made)
(variable salincbx was int, now long to accommodate using data's values)
(variable furntrcq was int, now long to accommodate using data's values)
(variable lifinscq was int, now long to accommodate using data's values)
(variable elctrcpq was int, now float to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable ecartknc was int, now long to accommodate using data's values)
(variable houseqcq was float, now double to accommodate using data's
       values)
(7,624 real changes made)
(7,691 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 2001

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_2001_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2001_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2001_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2001

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         0  (_merge==1)
        from using                          2  (_merge==2)

    Matched                            63,130  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(2 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(76 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2001_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2001_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2001

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2001_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2001_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2001_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2001_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2001) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2001_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2001_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2001) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2001_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     12.029       3.228       0.268       3.432
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.20772     0.48709     0.47779     0.96095     0.50531
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.21189     0.38559     0.70721
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.908       2.831       0.358       2.847
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.60286     0.35195     0.36099     0.65648     0.44388
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.16179     0.29668     0.54663
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2001

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2001_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2001_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2001_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2001_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2001_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2001_quarterly.dta"

. erase "$deriv/gini_2001_income_quarterly.dta"

. erase "$deriv/gini_2001_annual.dta"

. 
. display _n "Saved: gini_2001_all.dta"

Saved: gini_2001_all.dta

. 
end of do-file

Processing 2002...

. ****************************************************
. * 02_gini_2002.do
. * Build 2002 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw02/intrvw02"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw02/intrvw
> 02

. 
. use mtbi021x.dta, clear

. foreach f in mtbi022 mtbi023 mtbi024 mtbi031 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2002.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       878,637
        from master                   878,429  (_merge==1)
        from using                        208  (_merge==2)

    Matched                         2,673,644  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(878,637 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(293,262 real changes made, 293,262 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2002_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2002_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw02/intrvw
> 02

. preserve

. * Load first FMLI file and assign quarter
. use fmli021x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli022 fmli023 fmli024 fmli031 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable compbndx was int, now long to accommodate using data's values)
(variable compowdx was int, now long to accommodate using data's values)
(variable fpripenx was int, now long to accommodate using data's values)
(variable wdbsgdsx was int, now long to accommodate using data's values)
(variable wtrep02 was float, now double to accommodate using data's
       values)
(variable wtrep10 was float, now double to accommodate using data's
       values)
(variable wtrep20 was float, now double to accommodate using data's
       values)
(variable wtrep23 was float, now double to accommodate using data's
       values)
(variable wtrep26 was float, now double to accommodate using data's
       values)
(variable wtrep28 was float, now double to accommodate using data's
       values)
(variable wtrep32 was float, now double to accommodate using data's
       values)
(variable wtrep37 was float, now double to accommodate using data's
       values)
(variable wtrep38 was float, now double to accommodate using data's
       values)
(variable wtrep39 was float, now double to accommodate using data's
       values)
(variable wtrep43 was float, now double to accommodate using data's
       values)
(variable medsupcq was int, now float to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable tothentc was byte, now int to accommodate using data's values)
(variable utilrntc was byte, now int to accommodate using data's values)
(variable relectrc was byte, now int to accommodate using data's values)
(variable rnatlgap was byte, now int to accommodate using data's values)
(variable rnatlgac was byte, now int to accommodate using data's values)
(variable rwaterpp was byte, now int to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable unemplbx was int, now long to accommodate using data's values)
(7,778 real changes made)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable lifinscq was int, now long to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(variable compnsbx was int, now long to accommodate using data's values)
(variable inclsabx was int, now long to accommodate using data's values)
(7,833 real changes made)
(variable totexppq was float, now double to accommodate using data's
       values)
(variable furntrcq was int, now long to accommodate using data's values)
(variable totex4pq was float, now double to accommodate using data's
       values)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable otrincbx was int, now long to accommodate using data's values)
(8,024 real changes made)
(variable unemplx was int, now long to accommodate using data's values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable entertcq was float, now double to accommodate using data's
       values)
(variable otheqpcq was float, now double to accommodate using data's
       values)
(variable othentcq was float, now double to accommodate using data's
       values)
(variable miscpq was float, now double to accommodate using data's
       values)
(variable misc1pq was float, now double to accommodate using data's
       values)
(variable cashcopq was float, now double to accommodate using data's
       values)
(variable cashcocq was float, now double to accommodate using data's
       values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(variable miscx4pq was float, now double to accommodate using data's
       values)
(variable rothrflc was byte, now int to accommodate using data's values)
(variable rwaterpc was byte, now int to accommodate using data's values)
(variable etotalp was float, now double to accommodate using data's
       values)
(variable etotalc was float, now double to accommodate using data's
       values)
(variable etotapx4 was float, now double to accommodate using data's
       values)
(variable etotacx4 was float, now double to accommodate using data's
       values)
(variable emiscelp was float, now double to accommodate using data's
       values)
(8,086 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 2002

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_2002_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2002_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2002_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2002

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         0  (_merge==1)
        from using                          2  (_merge==2)

    Matched                            65,781  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(2 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(62 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2002_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2002_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2002

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2002_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2002_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2002_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2002_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2002) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2002_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2002_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2002) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2002_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     12.715       3.268       0.257       3.453
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.21721     0.48755     0.46471     0.77913     0.50375
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20999     0.38587     0.70883
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      8.017       2.839       0.354       2.840
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.69083     0.35293     0.35249     0.54950     0.44276
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.16055     0.29737     0.58013
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2002

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2002_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2002_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2002_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2002_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2002_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2002_quarterly.dta"

. erase "$deriv/gini_2002_income_quarterly.dta"

. erase "$deriv/gini_2002_annual.dta"

. 
. display _n "Saved: gini_2002_all.dta"

Saved: gini_2002_all.dta

. 
end of do-file

Processing 2003...

. ****************************************************
. * 02_gini_2003.do
. * Build 2003 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw03/intrvw03"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw03/intrvw
> 03

. 
. use mtbi031x.dta, clear

. foreach f in mtbi032 mtbi033 mtbi034 mtbi041 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2003.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       876,689
        from master                   876,479  (_merge==1)
        from using                        210  (_merge==2)

    Matched                         2,559,299  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(876,689 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(293,044 real changes made, 293,044 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2003_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2003_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw03/intrvw
> 03

. preserve

. * Load first FMLI file and assign quarter
. use fmli031x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli032 fmli033 fmli034 fmli041 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable compbndx was int, now long to accommodate using data's values)
(variable setlinsx was int, now long to accommodate using data's values)
(variable cartkucq was int, now long to accommodate using data's values)
(variable predrgpq was int, now float to accommodate using data's values)
(variable predrgcq was int, now float to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(variable rnatlgap was byte, now int to accommodate using data's values)
(variable rnatlgac was byte, now int to accommodate using data's values)
(variable ecartkup was int, now long to accommodate using data's values)
(8,196 real changes made)
(variable finlwt21 was float, now double to accommodate using data's
       values)
(variable othrincx was int, now long to accommodate using data's values)
(variable educapq was int, now long to accommodate using data's values)
(variable educacq was int, now long to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable salincbx was int, now long to accommodate using data's values)
(8,072 real changes made)
(variable fpripenx was int, now long to accommodate using data's values)
(variable fssix was int, now long to accommodate using data's values)
(variable rfueloic was byte, now int to accommodate using data's values)
(variable ecartkuc was int, now long to accommodate using data's values)
(8,044 real changes made)
(variable wtrep06 was float, now double to accommodate using data's
       values)
(variable wtrep08 was float, now double to accommodate using data's
       values)
(variable houspq was float, now double to accommodate using data's
       values)
(variable entertpq was float, now double to accommodate using data's
       values)
(variable otheqppq was float, now double to accommodate using data's
       values)
(variable othentpq was float, now double to accommodate using data's
       values)
(variable ehousngp was float, now double to accommodate using data's
       values)
(variable eentrmtp was float, now double to accommodate using data's
       values)
(variable eothentp was float, now double to accommodate using data's
       values)
(variable inclsabx was int, now long to accommodate using data's values)
(7,976 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 2003

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_2003_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2003_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2003_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2003

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            10
        from master                         0  (_merge==1)
        from using                         10  (_merge==2)

    Matched                            67,309  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(10 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(47 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2003_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2003_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2003

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2003_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2003_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2003_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2003_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2003) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2003_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2003_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2003) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2003_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     12.778       3.267       0.256       3.469
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.43523     0.50389     0.48988     0.86519     0.51226
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.21791     0.39582     0.74163
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.893       2.803       0.355       2.800
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.74392     0.35867     0.36893     0.61061     0.44753
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.16500     0.30139     0.59805
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2003

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2003_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2003_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2003_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2003_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2003_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2003_quarterly.dta"

. erase "$deriv/gini_2003_income_quarterly.dta"

. erase "$deriv/gini_2003_annual.dta"

. 
. display _n "Saved: gini_2003_all.dta"

Saved: gini_2003_all.dta

. 
end of do-file

Processing 2004...

. ****************************************************
. * 02_gini_2004.do
. * Build 2004 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw04/intrvw04"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw04/intrvw
> 04

. 
. use mtbi041x.dta, clear

. foreach f in mtbi042 mtbi043 mtbi044 mtbi051 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2004.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       847,738
        from master                   847,539  (_merge==1)
        from using                        199  (_merge==2)

    Matched                         2,450,047  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(847,738 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(280,276 real changes made, 280,276 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2004_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2004_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw04/intrvw
> 04

. preserve

. * Load first FMLI file and assign quarter
. use fmli041x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli042 fmli043 fmli044 fmli051 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable wtrep09 was float, now double to accommodate using data's
       values)
(variable wtrep10 was float, now double to accommodate using data's
       values)
(variable wtrep16 was float, now double to accommodate using data's
       values)
(variable wtrep23 was float, now double to accommodate using data's
       values)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable wtrep38 was float, now double to accommodate using data's
       values)
(variable wtrep41 was float, now double to accommodate using data's
       values)
(variable wtrep42 was float, now double to accommodate using data's
       values)
(variable wtrep43 was float, now double to accommodate using data's
       values)
(variable wtrep44 was float, now double to accommodate using data's
       values)
(variable transpq was float, now double to accommodate using data's
       values)
(variable educapq was int, now float to accommodate using data's values)
(variable educacq was int, now float to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable rfueloip was byte, now int to accommodate using data's values)
(variable rfueloic was byte, now int to accommodate using data's values)
(variable lmpsumbx was int, now long to accommodate using data's values)
(variable compens1 was int, now long to accommodate using data's values)
(variable compens2 was int, now long to accommodate using data's values)
(variable compens3 was int, now long to accommodate using data's values)
(variable compens4 was int, now long to accommodate using data's values)
(variable compens5 was int, now long to accommodate using data's values)
(7,779 real changes made)
(variable compbndx was int, now long to accommodate using data's values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable cashcocq was float, now double to accommodate using data's
       values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(variable etotalc was float, now double to accommodate using data's
       values)
(variable etotacx4 was float, now double to accommodate using data's
       values)
(variable enomotrp was int, now long to accommodate using data's values)
(7,643 real changes made)
(variable wtrep02 was float, now double to accommodate using data's
       values)
(variable wtrep20 was float, now double to accommodate using data's
       values)
(variable wtrep28 was float, now double to accommodate using data's
       values)
(variable wtrep32 was float, now double to accommodate using data's
       values)
(variable wtrep37 was float, now double to accommodate using data's
       values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(7,687 real changes made)
(variable trntrppq was int, now long to accommodate using data's values)
(variable ttranprp was int, now long to accommodate using data's values)
(variable ttrntrip was int, now long to accommodate using data's values)
(variable tfarep was int, now long to accommodate using data's values)
(variable chdlmpb was str1, now str2 to accommodate using data's values)
(variable chdlmpbx was byte, now int to accommodate using data's values)
(variable aliothbx was int, now long to accommodate using data's values)
(7,759 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter
variable fincbtax not found
r(111);

end of do-file
r(111);

end of do-file

r(111);

. use "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw04
> /intrvw04/fmli041x.dta"

. use "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw05
> /intrvw05/fmli051x.dta"

. summarize fincbtxm fincbtxi

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
    fincbtxm |      5,081    58202.14    59195.85   -30205.4   648850.9
    fincbtxi |      5,081    182.6144     103.663        100        505

. summarize fsalaryx
variable fsalaryx not found
r(111);

. summarize fsalarym

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
    fsalarym |      5,081    45882.04    53831.07          0   591432.4

. use "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw23
> /fmli232.dta"

. summarize FINCBTAX FINCBTXM

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
    FINCBTAX |      4,751    86973.86    103801.2     -82067    1375475
    FINCBTXM |      4,751    100617.5    104939.8   -46732.3    1195061

. use "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw96
> /intrvw96/fmli962.dta"

. use "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw04
> /intrvw04/fmli043.dta"

. use "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw22
> /fmli223.dta"

. use "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw03
> /intrvw03/fmli032.dta"

. use "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw96
> /intrvw96/fmli963.dta"

. use "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw04
> /intrvw04/fmli043.dta"

. use "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw22
> /fmli223.dta"

. summarize FINCBTAX FINCBTXI

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
    FINCBTAX |      4,580    82242.75    93325.26     -64432     879773
    FINCBTXI |      4,580    174.2572    101.0553        100        507

. summarize FINCBTXM

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
    FINCBTXM |      4,580    95259.31    97008.97   -26192.1     861275

. do "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/00_run_all.do"

. ****************************************************
. * 00_run_all.do
. * Master file - runs entire Gini pipeline
. ****************************************************
. 
. clear all

. set more off

. 
. global code "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code"

. 
. * Step 1: Build all UCC maps
. display _n "=== Building UCC maps ===" _n

=== Building UCC maps ===


. do "$code/01_build_ucc_map.do"

. ****************************************************
. * 01_build_ucc_map.do
. * Build UCC mappings for all years 1996-2023
. ****************************************************
. 
. clear all

. set more off

. 
. global stubs "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /stubs"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture mkdir "$deriv"

. 
. ****************************************************
. * Loop through all years and build UCC maps
. ****************************************************
. forvalues year = 1996/2023 {
  2.     
.     display _n "Processing year `year'..."
  3.     
.     cd "$stubs"
  4.     
.     quietly {
  5.         infix ///
>             str1 line_type      1       ///
>             byte level          4       ///
>             str59 name          11-69   ///
>             str6 ucc_code       70-75   ///
>             str1 source         80      ///
>             byte factor         83      ///
>             str7 section        86-92   ///
>             using "CE-HG-Integ-`year'.txt", clear
  6.         
.         * Drop comment lines
.         drop if line_type=="*"
  7.         
.         * Drop empty ucc_code rows
.         drop if trim(ucc_code)==""
  8.         
.         * Keep only rows where ucc_code is all digits (real UCCs)
.         gen byte ucc_isnum = regexm(ucc_code, "^[0-9]+$")
  9.         keep if ucc_isnum
 10.         drop ucc_isnum
 11.         
.         * Extract section name (handles both "FOOD" and "1  FOOD" formats
> )
.         gen section_clean = word(section, -1)  // gets last word
 12.         
.         * Map abbreviations to full names
.         replace section_clean = "EXPEND" if section_clean == "EXPE"
 13.         replace section_clean = "ADDENDA" if section_clean == "ADDE"
 14.         replace section_clean = "ASSETS" if section_clean == "ASSE"
 15.         replace section_clean = "CUCHARS" if section_clean == "CUCH"
 16.         replace section_clean = "INCOME" if section_clean == "INCO"
 17.         
.         * Keep only expenditure sections
.         keep if inlist(section_clean, "FOOD", "EXPEND")
 18.         drop section
 19.         rename section_clean section
 20.         
.         * Make numeric UCC
.         destring ucc_code, gen(UCC) ignore(" ")
 21.         
.         keep UCC section name
 22.         compress
 23.         save "$deriv/ucc_map_`year'.dta", replace
 24.     }
 25.     
.     display "  Saved: ucc_map_`year'.dta"
 26. }

Processing year 1996...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_1996.dta

Processing year 1997...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_1997.dta

Processing year 1998...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_1998.dta

Processing year 1999...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_1999.dta

Processing year 2000...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2000.dta

Processing year 2001...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2001.dta

Processing year 2002...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2002.dta

Processing year 2003...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2003.dta

Processing year 2004...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2004.dta

Processing year 2005...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2005.dta

Processing year 2006...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2006.dta

Processing year 2007...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2007.dta

Processing year 2008...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2008.dta

Processing year 2009...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2009.dta

Processing year 2010...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2010.dta

Processing year 2011...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2011.dta

Processing year 2012...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2012.dta

Processing year 2013...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2013.dta

Processing year 2014...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2014.dta

Processing year 2015...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2015.dta

Processing year 2016...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2016.dta

Processing year 2017...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2017.dta

Processing year 2018...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2018.dta

Processing year 2019...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2019.dta

Processing year 2020...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2020.dta

Processing year 2021...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2021.dta

Processing year 2022...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2022.dta

Processing year 2023...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2023.dta

. 
. display _n "Done. UCC maps saved for 1996-2023."

Done. UCC maps saved for 1996-2023.

. 
end of do-file

. 
. * Step 2: Run each year's Gini computation
. display _n "=== Computing yearly Ginis ===" _n

=== Computing yearly Ginis ===


. forvalues y = 1996/2023 {
  2.     if `y' != 1999 {
  3.         display _n "Processing `y'..."
  4.         do "$code/02_gini_`y'.do"
  5.     }
  6. }

Processing 1996...

. ****************************************************
. * 02_gini_1996.do
. * Build 1996 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw96/intrvw96"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw96/intrvw
> 96

. 
. use mtbi961x.dta, clear

. foreach f in mtbi962 mtbi963 mtbi964 mtbi971 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_1996.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       601,279
        from master                   601,091  (_merge==1)
        from using                        188  (_merge==2)

    Matched                         1,735,121  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(601,279 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(200,853 real changes made, 200,853 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_1996_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_1996_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw96/intrvw
> 96

. preserve

. * Load first FMLI file and assign quarter
. use fmli961x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli962 fmli963 fmli964 fmli971 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable chldsupx was int, now long to accommodate using data's values)
(variable cshcntbx was int, now long to accommodate using data's values)
(variable finlwt21 was float, now double to accommodate using data's
       values)
(variable inclossb was int, now long to accommodate using data's values)
(variable othrincx was int, now long to accommodate using data's values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable cartkupq was int, now long to accommodate using data's values)
(variable trntrpcq was int, now long to accommodate using data's values)
(variable perscapq was int, now float to accommodate using data's values)
(variable perscacq was int, now float to accommodate using data's values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(5,437 real changes made)
(variable cbsgftx was int, now long to accommodate using data's values)
(variable collexpx was int, now long to accommodate using data's values)
(variable totexppq was float, now double to accommodate using data's
       values)
(variable trntrppq was int, now long to accommodate using data's values)
(variable entertpq was float, now double to accommodate using data's
       values)
(variable entertcq was float, now double to accommodate using data's
       values)
(variable otheqppq was float, now double to accommodate using data's
       values)
(variable otheqpcq was float, now double to accommodate using data's
       values)
(variable othentpq was float, now double to accommodate using data's
       values)
(variable othentcq was float, now double to accommodate using data's
       values)
(variable totex4pq was float, now double to accommodate using data's
       values)
(5,295 real changes made)
(variable alimox was int, now long to accommodate using data's values)
(5,480 real changes made)
(5,584 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 1996

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_1996_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_1996_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_1996_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 1996

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             4
        from master                         0  (_merge==1)
        from using                          4  (_merge==2)

    Matched                            43,455  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(4 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(46 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_1996_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1996_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 1996

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_1996_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1996_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_1996_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_1996_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (1996) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_1996_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_1996_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (1996) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_1996_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.778       3.121       0.265       3.411
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.98398     0.46490     0.45439     0.76392     0.49600
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20376     0.37180     0.66307
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.334       2.712       0.370       2.777
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.49024     0.32835     0.33927     0.53221     0.43243
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15294     0.27989     0.49507
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 1996

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_1996_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_1996_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_1996_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_1996_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_1996_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_1996_quarterly.dta"

. erase "$deriv/gini_1996_income_quarterly.dta"

. erase "$deriv/gini_1996_annual.dta"

. 
. display _n "Saved: gini_1996_all.dta"

Saved: gini_1996_all.dta

. 
. 
end of do-file

Processing 1997...

. ****************************************************
. * 02_gini_1997.do
. * Build 1997 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw97/intrvw97/intrvw97"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw97/intrvw
> 97/intrvw97

. 
. use mtbi971x.dta, clear

. foreach f in mtbi972 mtbi973 mtbi974 mtbi981 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_1997.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       664,193
        from master                   664,009  (_merge==1)
        from using                        184  (_merge==2)

    Matched                         1,915,973  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(664,193 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(218,325 real changes made, 218,325 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_1997_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_1997_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw97/intrvw
> 97/intrvw97

. preserve

. * Load first FMLI file and assign quarter
. use fmli971x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli972 fmli973 fmli974 fmli981 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable cntrchrx was int, now long to accommodate using data's values)
(variable compowdx was int, now long to accommodate using data's values)
(variable wtrep01 was float, now double to accommodate using data's
       values)
(variable wtrep08 was float, now double to accommodate using data's
       values)
(variable wtrep21 was float, now double to accommodate using data's
       values)
(variable wtrep27 was float, now double to accommodate using data's
       values)
(variable wtrep40 was float, now double to accommodate using data's
       values)
(variable cartkncq was int, now long to accommodate using data's values)
(5,502 real changes made)
(variable compensx was int, now long to accommodate using data's values)
(variable fssix was int, now long to accommodate using data's values)
(variable wtrep06 was float, now double to accommodate using data's
       values)
(variable wtrep09 was float, now double to accommodate using data's
       values)
(variable wtrep13 was float, now double to accommodate using data's
       values)
(variable wtrep30 was float, now double to accommodate using data's
       values)
(variable wtrep31 was float, now double to accommodate using data's
       values)
(variable wtrep34 was float, now double to accommodate using data's
       values)
(variable wtrep43 was float, now double to accommodate using data's
       values)
(5,488 real changes made)
(variable alimox was int, now long to accommodate using data's values)
(variable chldsupx was int, now long to accommodate using data's values)
(variable collexpx was int, now long to accommodate using data's values)
(variable cshcntbx was int, now long to accommodate using data's values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable erankmth was float, now double to accommodate using data's
       values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(5,609 real changes made)
(variable cntrelgx was int, now long to accommodate using data's values)
(variable medsuppq was int, now float to accommodate using data's values)
(variable totex4pq was float, now double to accommodate using data's
       values)
(5,614 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 1997

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_1997_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_1997_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_1997_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 1997

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         0  (_merge==1)
        from using                          2  (_merge==2)

    Matched                            46,245  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(2 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(51 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_1997_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1997_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 1997

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_1997_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1997_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_1997_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_1997_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (1997) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_1997_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_1997_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (1997) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_1997_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.467       3.053       0.266       3.319
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.04453     0.44984     0.42889     0.65831     0.48650
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.19572     0.36227     0.67628
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.223       2.657       0.368       2.710
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.49211     0.31838     0.32095     0.46320     0.42447
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14710     0.27268     0.49602
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 1997

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_1997_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_1997_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_1997_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_1997_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_1997_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_1997_quarterly.dta"

. erase "$deriv/gini_1997_income_quarterly.dta"

. erase "$deriv/gini_1997_annual.dta"

. 
. display _n "Saved: gini_1997_all.dta"

Saved: gini_1997_all.dta

. 
. 
end of do-file

Processing 1998...

. ****************************************************
. * 02_gini_1998.do
. * Build 1998 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw98/intrvw98/intrvw98"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw98/intrvw
> 98/intrvw98

. 
. use mtbi981x.dta, clear

. foreach f in mtbi982 mtbi983 mtbi984 mtbi991 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_1998.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       700,664
        from master                   700,453  (_merge==1)
        from using                        211  (_merge==2)

    Matched                         1,992,549  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(700,664 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(227,221 real changes made, 227,221 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_1998_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_1998_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw98/intrvw
> 98/intrvw98

. preserve

. * Load first FMLI file and assign quarter
. use fmli981x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli982 fmli983 fmli984 fmli991 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable inclossa was int, now long to accommodate using data's values)
(variable wdbsastx was int, now long to accommodate using data's values)
(variable wdbsgdsx was int, now long to accommodate using data's values)
(variable wtrep01 was float, now double to accommodate using data's
       values)
(variable wtrep04 was float, now double to accommodate using data's
       values)
(variable wtrep06 was float, now double to accommodate using data's
       values)
(variable wtrep13 was float, now double to accommodate using data's
       values)
(variable wtrep23 was float, now double to accommodate using data's
       values)
(variable wtrep27 was float, now double to accommodate using data's
       values)
(variable wtrep28 was float, now double to accommodate using data's
       values)
(variable wtrep30 was float, now double to accommodate using data's
       values)
(variable wtrep31 was float, now double to accommodate using data's
       values)
(variable wtrep38 was float, now double to accommodate using data's
       values)
(variable wtrep40 was float, now double to accommodate using data's
       values)
(variable wtrep43 was float, now double to accommodate using data's
       values)
(variable totexppq was float, now double to accommodate using data's
       values)
(variable cartkupq was int, now long to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(5,467 real changes made)
(variable cshcntbx was int, now long to accommodate using data's values)
(variable trntrppq was int, now long to accommodate using data's values)
(5,527 real changes made)
(variable collexpx was int, now long to accommodate using data's values)
(variable frretirx was int, now long to accommodate using data's values)
(variable fssix was int, now long to accommodate using data's values)
(variable wtrep03 was float, now double to accommodate using data's
       values)
(variable wtrep20 was float, now double to accommodate using data's
       values)
(variable wtrep35 was float, now double to accommodate using data's
       values)
(5,569 real changes made)
(variable cntrchrx was int, now long to accommodate using data's values)
(variable wtrep19 was float, now double to accommodate using data's
       values)
(variable medsupcq was int, now float to accommodate using data's values)
(7,015 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 1998

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_1998_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_1998_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_1998_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 1998

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             1
        from master                         0  (_merge==1)
        from using                          1  (_merge==2)

    Matched                            49,150  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(1 observation deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(33 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_1998_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1998_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 1998

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_1998_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1998_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_1998_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_1998_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (1998) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_1998_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_1998_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (1998) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_1998_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.742       3.078       0.262       3.370
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.00055     0.46213     0.44550     0.70341     0.49368
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20162     0.37006     0.66679
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.416       2.721       0.367       2.732
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.50680     0.32570     0.33243     0.49523     0.42992
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15105     0.27798     0.50338
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 1998

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_1998_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_1998_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_1998_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_1998_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_1998_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_1998_quarterly.dta"

. erase "$deriv/gini_1998_income_quarterly.dta"

. erase "$deriv/gini_1998_annual.dta"

. 
. display _n "Saved: gini_1998_all.dta"

Saved: gini_1998_all.dta

. 
. 
end of do-file

Processing 2000...

. ****************************************************
. * 02_gini_2000.do
. * Build 2000 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw00/intrvw00"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw00/intrvw
> 00

. 
. use mtbi001x.dta, clear

. foreach f in mtbi002 mtbi003 mtbi004 mtbi011 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2000.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       911,332
        from master                   911,117  (_merge==1)
        from using                        215  (_merge==2)

    Matched                         2,507,936  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(911,332 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(287,234 real changes made, 287,234 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2000_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2000_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw00/intrvw
> 00

. preserve

. * Load first FMLI file and assign quarter
. use fmli001x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli002 fmli003 fmli004 fmli011 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable wtrep06 was float, now double to accommodate using data's
       values)
(variable wtrep08 was float, now double to accommodate using data's
       values)
(variable wtrep16 was float, now double to accommodate using data's
       values)
(variable wtrep21 was float, now double to accommodate using data's
       values)
(variable wtrep42 was float, now double to accommodate using data's
       values)
(variable wtrep44 was float, now double to accommodate using data's
       values)
(variable compensx was int, now long to accommodate using data's values)
(variable cntrchrx was int, now long to accommodate using data's values)
(variable fssix was int, now long to accommodate using data's values)
(variable rfueloip was byte, now int to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(variable ecartknp was int, now long to accommodate using data's values)
(7,809 real changes made)
(variable wtrep10 was float, now double to accommodate using data's
       values)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable wtrep29 was float, now double to accommodate using data's
       values)
(variable wtrep41 was float, now double to accommodate using data's
       values)
(variable cartkucq was int, now long to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable enomotrp was int, now long to accommodate using data's values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(variable etotacx4 was float, now double to accommodate using data's
       values)
(7,624 real changes made)
(variable alimox was int, now long to accommodate using data's values)
(variable furntrpq was int, now long to accommodate using data's values)
(variable rwaterpp was byte, now int to accommodate using data's values)
(variable eothvehp was int, now long to accommodate using data's values)
(7,717 real changes made)
(variable misc1cq was float, now double to accommodate using data's
       values)
(variable misccq was float, now double to accommodate using data's
       values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable miscx4cq was float, now double to accommodate using data's
       values)
(variable emiscelc was float, now double to accommodate using data's
       values)
(variable etotalc was float, now double to accommodate using data's
       values)
(7,712 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. capture rename fincbtax fincbtax

. capture rename fsalaryx fsalaryx

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 2000

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_2000_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2000_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2000_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2000

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             3
        from master                         0  (_merge==1)
        from using                          3  (_merge==2)

    Matched                            64,586  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(3 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(42 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2000_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2000_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2000

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2000_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2000_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2000_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2000_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2000) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2000_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2000_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2000) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2000_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.604       3.195       0.275       3.365
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.04806     0.47269     0.46134     0.75383     0.50097
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20697     0.37668     0.67701
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.612       2.797       0.367       2.806
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.58787     0.34338     0.34919     0.53068     0.44022
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15823     0.29063     0.54038
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2000

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2000_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2000_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2000_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2000_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2000_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2000_quarterly.dta"

. erase "$deriv/gini_2000_income_quarterly.dta"

. erase "$deriv/gini_2000_annual.dta"

. 
. display _n "Saved: gini_2000_all.dta"

Saved: gini_2000_all.dta

. 
end of do-file

Processing 2001...

. ****************************************************
. * 02_gini_2001.do
. * Build 2001 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw01/intrvw01"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw01/intrvw
> 01

. 
. use mtbi011x.dta, clear

. foreach f in mtbi012 mtbi013 mtbi014 mtbi021 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2001.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       854,573
        from master                   854,362  (_merge==1)
        from using                        211  (_merge==2)

    Matched                         2,554,552  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(854,573 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(284,024 real changes made, 284,024 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2001_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2001_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw01/intrvw
> 01

. preserve

. * Load first FMLI file and assign quarter
. use fmli011x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli012 fmli013 fmli014 fmli021 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable wtrep03 was float, now double to accommodate using data's
       values)
(variable wtrep04 was float, now double to accommodate using data's
       values)
(variable wtrep11 was float, now double to accommodate using data's
       values)
(variable wtrep14 was float, now double to accommodate using data's
       values)
(variable wtrep15 was float, now double to accommodate using data's
       values)
(variable wtrep17 was float, now double to accommodate using data's
       values)
(variable wtrep19 was float, now double to accommodate using data's
       values)
(variable wtrep22 was float, now double to accommodate using data's
       values)
(variable wtrep24 was float, now double to accommodate using data's
       values)
(variable wtrep27 was float, now double to accommodate using data's
       values)
(variable wtrep31 was float, now double to accommodate using data's
       values)
(variable wtrep33 was float, now double to accommodate using data's
       values)
(variable wtrep35 was float, now double to accommodate using data's
       values)
(variable wtrep36 was float, now double to accommodate using data's
       values)
(variable wtrep40 was float, now double to accommodate using data's
       values)
(variable fssix was int, now long to accommodate using data's values)
(variable fpripenx was int, now long to accommodate using data's values)
(variable perscacq was int, now float to accommodate using data's values)
(variable perscapq was int, now float to accommodate using data's values)
(variable educapq was int, now long to accommodate using data's values)
(variable mrtprnoc was int, now float to accommodate using data's values)
(variable vothrflc was byte, now int to accommodate using data's values)
(variable rfueloip was byte, now int to accommodate using data's values)
(variable emrtpnvc was int, now float to accommodate using data's values)
(variable emiscmtc was int, now float to accommodate using data's values)
(variable houscq was float, now double to accommodate using data's
       values)
(variable ehousngc was float, now double to accommodate using data's
       values)
(7,579 real changes made)
(variable wtrep02 was float, now double to accommodate using data's
       values)
(variable wtrep09 was float, now double to accommodate using data's
       values)
(variable wtrep10 was float, now double to accommodate using data's
       values)
(variable wtrep20 was float, now double to accommodate using data's
       values)
(variable wtrep21 was float, now double to accommodate using data's
       values)
(variable wtrep23 was float, now double to accommodate using data's
       values)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable wtrep32 was float, now double to accommodate using data's
       values)
(variable wtrep38 was float, now double to accommodate using data's
       values)
(variable hlfbathq was byte, now int to accommodate using data's values)
(variable inclsabx was int, now long to accommodate using data's values)
(variable othentpq was float, now double to accommodate using data's
       values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable otheqppq was float, now double to accommodate using data's
       values)
(variable entertpq was float, now double to accommodate using data's
       values)
(variable eothentp was float, now double to accommodate using data's
       values)
(variable eentrmtp was float, now double to accommodate using data's
       values)
(7,398 real changes made)
(variable salincbx was int, now long to accommodate using data's values)
(variable furntrcq was int, now long to accommodate using data's values)
(variable lifinscq was int, now long to accommodate using data's values)
(variable elctrcpq was int, now float to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable ecartknc was int, now long to accommodate using data's values)
(variable houseqcq was float, now double to accommodate using data's
       values)
(7,624 real changes made)
(7,691 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 2001

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_2001_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2001_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2001_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2001

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         0  (_merge==1)
        from using                          2  (_merge==2)

    Matched                            63,130  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(2 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(76 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2001_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2001_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2001

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2001_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2001_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2001_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2001_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2001) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2001_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2001_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2001) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2001_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     12.029       3.228       0.268       3.432
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.20772     0.48709     0.47779     0.96095     0.50531
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.21189     0.38559     0.70721
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.908       2.831       0.358       2.847
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.60286     0.35195     0.36099     0.65648     0.44388
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.16179     0.29668     0.54663
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2001

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2001_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2001_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2001_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2001_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2001_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2001_quarterly.dta"

. erase "$deriv/gini_2001_income_quarterly.dta"

. erase "$deriv/gini_2001_annual.dta"

. 
. display _n "Saved: gini_2001_all.dta"

Saved: gini_2001_all.dta

. 
end of do-file

Processing 2002...

. ****************************************************
. * 02_gini_2002.do
. * Build 2002 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw02/intrvw02"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw02/intrvw
> 02

. 
. use mtbi021x.dta, clear

. foreach f in mtbi022 mtbi023 mtbi024 mtbi031 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2002.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       878,637
        from master                   878,429  (_merge==1)
        from using                        208  (_merge==2)

    Matched                         2,673,644  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(878,637 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(293,262 real changes made, 293,262 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2002_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2002_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw02/intrvw
> 02

. preserve

. * Load first FMLI file and assign quarter
. use fmli021x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli022 fmli023 fmli024 fmli031 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable compbndx was int, now long to accommodate using data's values)
(variable compowdx was int, now long to accommodate using data's values)
(variable fpripenx was int, now long to accommodate using data's values)
(variable wdbsgdsx was int, now long to accommodate using data's values)
(variable wtrep02 was float, now double to accommodate using data's
       values)
(variable wtrep10 was float, now double to accommodate using data's
       values)
(variable wtrep20 was float, now double to accommodate using data's
       values)
(variable wtrep23 was float, now double to accommodate using data's
       values)
(variable wtrep26 was float, now double to accommodate using data's
       values)
(variable wtrep28 was float, now double to accommodate using data's
       values)
(variable wtrep32 was float, now double to accommodate using data's
       values)
(variable wtrep37 was float, now double to accommodate using data's
       values)
(variable wtrep38 was float, now double to accommodate using data's
       values)
(variable wtrep39 was float, now double to accommodate using data's
       values)
(variable wtrep43 was float, now double to accommodate using data's
       values)
(variable medsupcq was int, now float to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable tothentc was byte, now int to accommodate using data's values)
(variable utilrntc was byte, now int to accommodate using data's values)
(variable relectrc was byte, now int to accommodate using data's values)
(variable rnatlgap was byte, now int to accommodate using data's values)
(variable rnatlgac was byte, now int to accommodate using data's values)
(variable rwaterpp was byte, now int to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable unemplbx was int, now long to accommodate using data's values)
(7,778 real changes made)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable lifinscq was int, now long to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(variable compnsbx was int, now long to accommodate using data's values)
(variable inclsabx was int, now long to accommodate using data's values)
(7,833 real changes made)
(variable totexppq was float, now double to accommodate using data's
       values)
(variable furntrcq was int, now long to accommodate using data's values)
(variable totex4pq was float, now double to accommodate using data's
       values)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable otrincbx was int, now long to accommodate using data's values)
(8,024 real changes made)
(variable unemplx was int, now long to accommodate using data's values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable entertcq was float, now double to accommodate using data's
       values)
(variable otheqpcq was float, now double to accommodate using data's
       values)
(variable othentcq was float, now double to accommodate using data's
       values)
(variable miscpq was float, now double to accommodate using data's
       values)
(variable misc1pq was float, now double to accommodate using data's
       values)
(variable cashcopq was float, now double to accommodate using data's
       values)
(variable cashcocq was float, now double to accommodate using data's
       values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(variable miscx4pq was float, now double to accommodate using data's
       values)
(variable rothrflc was byte, now int to accommodate using data's values)
(variable rwaterpc was byte, now int to accommodate using data's values)
(variable etotalp was float, now double to accommodate using data's
       values)
(variable etotalc was float, now double to accommodate using data's
       values)
(variable etotapx4 was float, now double to accommodate using data's
       values)
(variable etotacx4 was float, now double to accommodate using data's
       values)
(variable emiscelp was float, now double to accommodate using data's
       values)
(8,086 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 2002

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_2002_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2002_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2002_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2002

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         0  (_merge==1)
        from using                          2  (_merge==2)

    Matched                            65,781  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(2 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(62 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2002_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2002_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2002

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2002_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2002_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2002_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2002_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2002) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2002_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2002_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2002) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2002_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     12.715       3.268       0.257       3.453
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.21721     0.48755     0.46471     0.77913     0.50375
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20999     0.38587     0.70883
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      8.017       2.839       0.354       2.840
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.69083     0.35293     0.35249     0.54950     0.44276
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.16055     0.29737     0.58013
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2002

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2002_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2002_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2002_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2002_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2002_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2002_quarterly.dta"

. erase "$deriv/gini_2002_income_quarterly.dta"

. erase "$deriv/gini_2002_annual.dta"

. 
. display _n "Saved: gini_2002_all.dta"

Saved: gini_2002_all.dta

. 
end of do-file

Processing 2003...

. ****************************************************
. * 02_gini_2003.do
. * Build 2003 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw03/intrvw03"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw03/intrvw
> 03

. 
. use mtbi031x.dta, clear

. foreach f in mtbi032 mtbi033 mtbi034 mtbi041 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2003.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       876,689
        from master                   876,479  (_merge==1)
        from using                        210  (_merge==2)

    Matched                         2,559,299  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(876,689 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(293,044 real changes made, 293,044 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2003_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2003_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw03/intrvw
> 03

. preserve

. * Load first FMLI file and assign quarter
. use fmli031x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli032 fmli033 fmli034 fmli041 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable compbndx was int, now long to accommodate using data's values)
(variable setlinsx was int, now long to accommodate using data's values)
(variable cartkucq was int, now long to accommodate using data's values)
(variable predrgpq was int, now float to accommodate using data's values)
(variable predrgcq was int, now float to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(variable rnatlgap was byte, now int to accommodate using data's values)
(variable rnatlgac was byte, now int to accommodate using data's values)
(variable ecartkup was int, now long to accommodate using data's values)
(8,196 real changes made)
(variable finlwt21 was float, now double to accommodate using data's
       values)
(variable othrincx was int, now long to accommodate using data's values)
(variable educapq was int, now long to accommodate using data's values)
(variable educacq was int, now long to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable salincbx was int, now long to accommodate using data's values)
(8,072 real changes made)
(variable fpripenx was int, now long to accommodate using data's values)
(variable fssix was int, now long to accommodate using data's values)
(variable rfueloic was byte, now int to accommodate using data's values)
(variable ecartkuc was int, now long to accommodate using data's values)
(8,044 real changes made)
(variable wtrep06 was float, now double to accommodate using data's
       values)
(variable wtrep08 was float, now double to accommodate using data's
       values)
(variable houspq was float, now double to accommodate using data's
       values)
(variable entertpq was float, now double to accommodate using data's
       values)
(variable otheqppq was float, now double to accommodate using data's
       values)
(variable othentpq was float, now double to accommodate using data's
       values)
(variable ehousngp was float, now double to accommodate using data's
       values)
(variable eentrmtp was float, now double to accommodate using data's
       values)
(variable eothentp was float, now double to accommodate using data's
       values)
(variable inclsabx was int, now long to accommodate using data's values)
(7,976 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 2003

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_2003_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2003_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2003_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2003

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            10
        from master                         0  (_merge==1)
        from using                         10  (_merge==2)

    Matched                            67,309  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(10 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(47 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2003_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2003_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2003

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2003_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2003_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2003_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2003_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2003) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2003_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2003_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2003) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2003_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     12.778       3.267       0.256       3.469
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.43523     0.50389     0.48988     0.86519     0.51226
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.21791     0.39582     0.74163
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.893       2.803       0.355       2.800
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.74392     0.35867     0.36893     0.61061     0.44753
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.16500     0.30139     0.59805
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2003

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2003_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2003_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2003_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2003_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2003_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2003_quarterly.dta"

. erase "$deriv/gini_2003_income_quarterly.dta"

. erase "$deriv/gini_2003_annual.dta"

. 
. display _n "Saved: gini_2003_all.dta"

Saved: gini_2003_all.dta

. 
end of do-file

Processing 2004...

. ****************************************************
. * 02_gini_2004.do
. * Build 2004 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw04/intrvw04"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw04/intrvw
> 04

. 
. use mtbi041x.dta, clear

. foreach f in mtbi042 mtbi043 mtbi044 mtbi051 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2004.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       847,738
        from master                   847,539  (_merge==1)
        from using                        199  (_merge==2)

    Matched                         2,450,047  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(847,738 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(280,276 real changes made, 280,276 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2004_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2004_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw04/intrvw
> 04

. preserve

. * Load first FMLI file and assign quarter
. use fmli041x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli042 fmli043 fmli044 fmli051 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable wtrep09 was float, now double to accommodate using data's
       values)
(variable wtrep10 was float, now double to accommodate using data's
       values)
(variable wtrep16 was float, now double to accommodate using data's
       values)
(variable wtrep23 was float, now double to accommodate using data's
       values)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable wtrep38 was float, now double to accommodate using data's
       values)
(variable wtrep41 was float, now double to accommodate using data's
       values)
(variable wtrep42 was float, now double to accommodate using data's
       values)
(variable wtrep43 was float, now double to accommodate using data's
       values)
(variable wtrep44 was float, now double to accommodate using data's
       values)
(variable transpq was float, now double to accommodate using data's
       values)
(variable educapq was int, now float to accommodate using data's values)
(variable educacq was int, now float to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable rfueloip was byte, now int to accommodate using data's values)
(variable rfueloic was byte, now int to accommodate using data's values)
(variable lmpsumbx was int, now long to accommodate using data's values)
(variable compens1 was int, now long to accommodate using data's values)
(variable compens2 was int, now long to accommodate using data's values)
(variable compens3 was int, now long to accommodate using data's values)
(variable compens4 was int, now long to accommodate using data's values)
(variable compens5 was int, now long to accommodate using data's values)
(7,779 real changes made)
(variable compbndx was int, now long to accommodate using data's values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable cashcocq was float, now double to accommodate using data's
       values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(variable etotalc was float, now double to accommodate using data's
       values)
(variable etotacx4 was float, now double to accommodate using data's
       values)
(variable enomotrp was int, now long to accommodate using data's values)
(7,643 real changes made)
(variable wtrep02 was float, now double to accommodate using data's
       values)
(variable wtrep20 was float, now double to accommodate using data's
       values)
(variable wtrep28 was float, now double to accommodate using data's
       values)
(variable wtrep32 was float, now double to accommodate using data's
       values)
(variable wtrep37 was float, now double to accommodate using data's
       values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(7,687 real changes made)
(variable trntrppq was int, now long to accommodate using data's values)
(variable ttranprp was int, now long to accommodate using data's values)
(variable ttrntrip was int, now long to accommodate using data's values)
(variable tfarep was int, now long to accommodate using data's values)
(variable chdlmpb was str1, now str2 to accommodate using data's values)
(variable chdlmpbx was byte, now int to accommodate using data's values)
(variable aliothbx was int, now long to accommodate using data's values)
(7,759 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2004

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2004_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2004_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2004_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2004_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2004

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             9
        from master                         0  (_merge==1)
        from using                          9  (_merge==2)

    Matched                            64,601  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(9 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(88 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2004_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2004_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2004

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2004_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2004_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2004_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2004_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2004_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2004) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2004_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2004_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2004_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2004) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2004_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     12.176       3.229       0.265       3.444
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.31743     0.49191     0.48215     0.85130     0.50771
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.21406     0.38855     0.72489
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.638       2.783       0.364       2.799
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.66701     0.35014     0.36344     0.60951     0.44348
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.16207     0.29541     0.57156
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2004

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2004_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2004_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2004_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2004_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2004_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2004_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2004_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2004_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2004_quarterly.dta"

. erase "$deriv/gini_2004_income_quarterly.dta"

. erase "$deriv/gini_2004_annual.dta"

. 
. display _n "Saved: gini_2004_all.dta"

Saved: gini_2004_all.dta

. 
end of do-file

Processing 2005...

. ****************************************************
. * 02_gini_2005.do
. * Build 2005 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw05/intrvw05"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw05/intrvw
> 05

. 
. use mtbi051x.dta, clear

. foreach f in mtbi052 mtbi053 mtbi054 mtbi061 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2005.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       785,941
        from master                   785,732  (_merge==1)
        from using                        209  (_merge==2)

    Matched                         2,214,377  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(785,941 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(266,210 real changes made, 266,210 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2005_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2005_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw05/intrvw
> 05

. preserve

. * Load first FMLI file and assign quarter
. use fmli051x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli052 fmli053 fmli054 fmli061 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable setlinsx was int, now long to accommodate using data's values)
(variable wdbsastx was int, now long to accommodate using data's values)
(variable totexppq was float, now double to accommodate using data's
       values)
(variable lifinspq was int, now long to accommodate using data's values)
(variable hhid was byte, now int to accommodate using data's values)
(variable totex4pq was float, now double to accommodate using data's
       values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable vfueloip was byte, now int to accommodate using data's values)
(variable vfueloic was byte, now int to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(variable rnatlgac was byte, now int to accommodate using data's values)
(variable ecartkup was int, now long to accommodate using data's values)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable inclsabx was int, now long to accommodate using data's values)
(variable chdlmpb was str1, now str2 to accommodate using data's values)
(variable chdlmpbx was byte, now int to accommodate using data's values)
(variable compens1 was int, now long to accommodate using data's values)
(variable compens3 was int, now long to accommodate using data's values)
(variable compens4 was int, now long to accommodate using data's values)
(variable compens5 was int, now long to accommodate using data's values)
(variable colplanx was int, now long to accommodate using data's values)
(7,717 real changes made)
(variable flrcvrpq was int, now long to accommodate using data's values)
(variable entertpq was float, now double to accommodate using data's
       values)
(variable entertcq was float, now double to accommodate using data's
       values)
(variable otheqpcq was float, now double to accommodate using data's
       values)
(variable othentcq was float, now double to accommodate using data's
       values)
(variable educapq was float, now double to accommodate using data's
       values)
(variable educacq was float, now double to accommodate using data's
       values)
(variable cashcopq was float, now double to accommodate using data's
       values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable rothrflc was byte, now int to accommodate using data's values)
(variable etotalp was float, now double to accommodate using data's
       values)
(variable etotapx4 was float, now double to accommodate using data's
       values)
(variable eentrmtp was float, now double to accommodate using data's
       values)
(variable aliothbx was int, now long to accommodate using data's values)
(variable fjssded1 was int, now long to accommodate using data's values)
(variable fjssded2 was int, now long to accommodate using data's values)
(variable fjssded3 was int, now long to accommodate using data's values)
(variable fjssded4 was int, now long to accommodate using data's values)
(variable fjssded5 was int, now long to accommodate using data's values)
(7,456 real changes made)
(variable cashcocq was float, now double to accommodate using data's
       values)
(variable otrincbx was int, now long to accommodate using data's values)
(7,585 real changes made)
(variable houspq was float, now double to accommodate using data's
       values)
(variable sheltpq was float, now double to accommodate using data's
       values)
(variable owndwepq was float, now double to accommodate using data's
       values)
(variable mrpinspq was float, now double to accommodate using data's
       values)
(variable ehousngp was float, now double to accommodate using data's
       values)
(variable esheltrp was float, now double to accommodate using data's
       values)
(variable eowndwlp was float, now double to accommodate using data's
       values)
(variable enomotrc was int, now long to accommodate using data's values)
(7,786 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2005

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2005_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2005_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2005_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2005_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2005

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             7
        from master                         0  (_merge==1)
        from using                          7  (_merge==2)

    Matched                            60,905  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(7 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(81 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2005_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2005_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2005

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2005_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2005_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2005_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2005_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2005_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2005) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2005_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2005_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2005_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2005) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2005_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     12.061       3.203       0.266       3.389
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.21941     0.48462     0.46641     0.77411     0.50198
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20943     0.38407     0.70920
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.525       2.770       0.368       2.763
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.59076     0.34140     0.35153     0.54985     0.43863
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15801     0.28923     0.54160
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2005

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2005_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2005_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2005_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2005_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2005_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2005_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2005_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2005_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2005_quarterly.dta"

. erase "$deriv/gini_2005_income_quarterly.dta"

. erase "$deriv/gini_2005_annual.dta"

. 
. display _n "Saved: gini_2005_all.dta"

Saved: gini_2005_all.dta

. 
end of do-file

Processing 2006...

. ****************************************************
. * 02_gini_2006.do
. * Build 2006 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw06/intrvw06"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw06/intrvw
> 06

. 
. use mtbi061x.dta, clear

. foreach f in mtbi062 mtbi063 mtbi064 mtbi071 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2006.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       793,378
        from master                   793,149  (_merge==1)
        from using                        229  (_merge==2)

    Matched                         2,175,454  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(793,378 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(265,180 real changes made, 265,180 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2006_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2006_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw06/intrvw
> 06

. preserve

. * Load first FMLI file and assign quarter
. use fmli061x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli062 fmli063 fmli064 fmli071 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable inclossa was int, now long to accommodate using data's values)
(variable wtrep09 was float, now double to accommodate using data's
       values)
(variable wtrep15 was float, now double to accommodate using data's
       values)
(variable wtrep19 was float, now double to accommodate using data's
       values)
(variable wtrep24 was float, now double to accommodate using data's
       values)
(variable transpq was float, now double to accommodate using data's
       values)
(variable cartkupq was int, now long to accommodate using data's values)
(variable entertcq was float, now double to accommodate using data's
       values)
(variable otheqpcq was float, now double to accommodate using data's
       values)
(variable othentcq was float, now double to accommodate using data's
       values)
(variable educapq was int, now long to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(variable etranptp was float, now double to accommodate using data's
       values)
(variable ecartknc was int, now long to accommodate using data's values)
(variable ecartkup was int, now long to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable compnsbx was int, now long to accommodate using data's values)
(variable fssix1 was int, now long to accommodate using data's values)
(variable fssix3 was int, now long to accommodate using data's values)
(variable fssix4 was int, now long to accommodate using data's values)
(variable fssix5 was int, now long to accommodate using data's values)
(7,009 real changes made)
(variable welfarex was int, now long to accommodate using data's values)
(variable furntrpq was int, now long to accommodate using data's values)
(variable furntrcq was int, now long to accommodate using data's values)
(variable trntrppq was int, now long to accommodate using data's values)
(variable ttranprp was int, now long to accommodate using data's values)
(variable ttrntrip was int, now long to accommodate using data's values)
(variable tfarep was int, now long to accommodate using data's values)
(variable inclsabx was int, now long to accommodate using data's values)
(variable inclsbbx was int, now long to accommodate using data's values)
(variable welfare1 was int, now long to accommodate using data's values)
(variable welfare2 was int, now long to accommodate using data's values)
(variable welfare3 was int, now long to accommodate using data's values)
(variable welfare4 was int, now long to accommodate using data's values)
(variable welfare5 was int, now long to accommodate using data's values)
(6,988 real changes made)
(variable houscq was float, now double to accommodate using data's
       values)
(variable housopcq was float, now double to accommodate using data's
       values)
(variable domsrvcq was float, now double to accommodate using data's
       values)
(variable dmsxcccq was float, now double to accommodate using data's
       values)
(variable houseqpq was float, now double to accommodate using data's
       values)
(variable misceqpq was float, now double to accommodate using data's
       values)
(variable transcq was float, now double to accommodate using data's
       values)
(variable ehousngc was float, now double to accommodate using data's
       values)
(7,084 real changes made)
(variable rendwepq was float, now double to accommodate using data's
       values)
(variable rntxrppq was float, now double to accommodate using data's
       values)
(variable educacq was int, now long to accommodate using data's values)
(variable compensm was float, now double to accommodate using data's
       values)
(6,965 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2006

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2006_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2006_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2006_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2006_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2006

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            12
        from master                         0  (_merge==1)
        from using                         12  (_merge==2)

    Matched                            59,813  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(12 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(109 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2006_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2006_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2006

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2006_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2006_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2006_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2006_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2006_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2006) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2006_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2006_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2006_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2006) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2006_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.982       3.112       0.260       3.370
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.30579     0.48167     0.46048     0.78065     0.49756
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20699     0.38225     0.72311
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.304       2.728       0.374       2.713
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.60049     0.33538     0.34858     0.57375     0.43467
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15578     0.28493     0.54566
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2006

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2006_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2006_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2006_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2006_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2006_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2006_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2006_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2006_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2006_quarterly.dta"

. erase "$deriv/gini_2006_income_quarterly.dta"

. erase "$deriv/gini_2006_annual.dta"

. 
. display _n "Saved: gini_2006_all.dta"

Saved: gini_2006_all.dta

. 
end of do-file

Processing 2007...

. ****************************************************
. * 02_gini_2007.do
. * Build 2007 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw07/intrvw07"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw07/intrvw
> 07

. 
. use mtbi071x.dta, clear

. foreach f in mtbi072 mtbi073 mtbi074 mtbi081 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2007.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       738,607
        from master                   738,390  (_merge==1)
        from using                        217  (_merge==2)

    Matched                         2,044,448  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(738,607 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(255,605 real changes made, 255,605 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2007_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2007_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw07/intrvw
> 07

. preserve

. * Load first FMLI file and assign quarter
. use fmli071x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli072 fmli073 fmli074 fmli081 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable wtrep26 was float, now double to accommodate using data's
       values)
(variable wtrep41 was float, now double to accommodate using data's
       values)
(variable ntlgaspq was int, now float to accommodate using data's values)
(variable ntlgascq was int, now float to accommodate using data's values)
(variable elctrcpq was int, now float to accommodate using data's values)
(variable elctrccq was int, now float to accommodate using data's values)
(variable allfulpq was int, now float to accommodate using data's values)
(variable allfulcq was int, now float to accommodate using data's values)
(variable fuloilpq was int, now float to accommodate using data's values)
(variable othflspq was int, now float to accommodate using data's values)
(variable othflscq was int, now float to accommodate using data's values)
(variable watrpspq was int, now float to accommodate using data's values)
(variable watrpscq was int, now float to accommodate using data's values)
(variable trntrppq was int, now long to accommodate using data's values)
(variable entertcq was float, now double to accommodate using data's
       values)
(variable otheqpcq was float, now double to accommodate using data's
       values)
(variable othentcq was float, now double to accommodate using data's
       values)
(variable ttranprp was int, now long to accommodate using data's values)
(variable ttrntrip was int, now long to accommodate using data's values)
(variable tfarep was int, now long to accommodate using data's values)
(variable utilownp was int, now float to accommodate using data's values)
(variable utilownc was int, now float to accommodate using data's values)
(variable vothrflp was int, now float to accommodate using data's values)
(variable vnatlgap was int, now float to accommodate using data's values)
(variable vnatlgac was int, now float to accommodate using data's values)
(variable vwaterpp was int, now float to accommodate using data's values)
(variable vwaterpc was int, now float to accommodate using data's values)
(variable eentrmtc was float, now double to accommodate using data's
       values)
(variable eothentc was float, now double to accommodate using data's
       values)
(variable emotrvhc was int, now long to accommodate using data's values)
(variable emiscmtc was int, now float to accommodate using data's values)
(variable inclsabx was int, now long to accommodate using data's values)
(variable fssix3 was int, now long to accommodate using data's values)
(6,829 real changes made)
(variable unemplx was int, now long to accommodate using data's values)
(variable houscq was float, now double to accommodate using data's
       values)
(variable fuloilcq was int, now float to accommodate using data's values)
(variable houseqcq was float, now double to accommodate using data's
       values)
(variable apparpq was float, now double to accommodate using data's
       values)
(variable othaplpq was float, now double to accommodate using data's
       values)
(variable othvehpq was int, now long to accommodate using data's values)
(variable vfueloip was int, now float to accommodate using data's values)
(variable vfueloic was int, now float to accommodate using data's values)
(variable vothrflc was int, now float to accommodate using data's values)
(variable velectrc was int, now float to accommodate using data's values)
(variable utilrntp was int, now float to accommodate using data's values)
(variable utilrntc was int, now float to accommodate using data's values)
(variable rnatlgap was int, now float to accommodate using data's values)
(variable rnatlgac was int, now float to accommodate using data's values)
(variable rwaterpp was int, now float to accommodate using data's values)
(variable rwaterpc was int, now float to accommodate using data's values)
(variable ehousngc was float, now double to accommodate using data's
       values)
(variable eothvehp was int, now long to accommodate using data's values)
(variable unemplbx was int, now long to accommodate using data's values)
(variable lmpsumbx was int, now long to accommodate using data's values)
(variable unemplx1 was int, now long to accommodate using data's values)
(variable unemplx2 was int, now long to accommodate using data's values)
(variable unemplx3 was int, now long to accommodate using data's values)
(variable unemplx4 was int, now long to accommodate using data's values)
(variable unemplx5 was int, now long to accommodate using data's values)
(6,711 real changes made)
(variable bbydaypq was int, now long to accommodate using data's values)
(variable lifinscq was int, now long to accommodate using data's values)
(variable velectrp was int, now float to accommodate using data's values)
(variable rfueloic was int, now float to accommodate using data's values)
(variable rothrflc was byte, now float to accommodate using data's
       values)
(variable fssix1 was int, now long to accommodate using data's values)
(variable fssix4 was int, now long to accommodate using data's values)
(6,830 real changes made)
(variable tairfarp was int, now long to accommodate using data's values)
(6,914 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2007

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2007_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2007_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2007_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2007_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2007

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            25
        from master                         0  (_merge==1)
        from using                         25  (_merge==2)

    Matched                            57,077  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(25 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(106 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2007_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2007_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2007

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2007_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2007_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2007_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2007_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2007_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2007) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2007_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2007_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2007_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2007) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2007_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.762       3.095       0.263       3.304
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.35745     0.46737     0.44986     0.77245     0.49253
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20226     0.37335     0.73081
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.074       2.704       0.382       2.721
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.57537     0.32557     0.33879     0.56767     0.42893
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15158     0.27789     0.53504
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2007

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2007_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2007_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2007_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2007_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2007_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2007_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2007_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2007_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2007_quarterly.dta"

. erase "$deriv/gini_2007_income_quarterly.dta"

. erase "$deriv/gini_2007_annual.dta"

. 
. display _n "Saved: gini_2007_all.dta"

Saved: gini_2007_all.dta

. 
end of do-file

Processing 2008...

. ****************************************************
. * 02_gini_2008.do
. * Build 2008 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw08/intrvw08"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw08/intrvw
> 08

. 
. use mtbi081x.dta, clear

. foreach f in mtbi082 mtbi083 mtbi084 mtbi091 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2008.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       752,489
        from master                   752,264  (_merge==1)
        from using                        225  (_merge==2)

    Matched                         2,048,735  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(752,489 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(257,626 real changes made, 257,626 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2008_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2008_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw08/intrvw
> 08

. preserve

. * Load first FMLI file and assign quarter
. use fmli081x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli082 fmli083 fmli084 fmli091 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable fsltaxx was int, now long to accommodate using data's values)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable wtrep26 was float, now double to accommodate using data's
       values)
(variable allfulcq was int, now float to accommodate using data's values)
(variable fuloilcq was int, now float to accommodate using data's values)
(variable othflscq was int, now float to accommodate using data's values)
(variable vfueloic was int, now float to accommodate using data's values)
(variable velectrc was int, now float to accommodate using data's values)
(variable vnatlgap was int, now float to accommodate using data's values)
(variable utilrntp was int, now float to accommodate using data's values)
(variable utilrntc was int, now float to accommodate using data's values)
(variable rnatlgap was int, now float to accommodate using data's values)
(variable rwaterpp was byte, now float to accommodate using data's
       values)
(variable rwaterpc was int, now float to accommodate using data's values)
(variable ecartkup was int, now long to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(variable fsltaxx1 was int, now long to accommodate using data's values)
(variable fsltaxx2 was int, now long to accommodate using data's values)
(variable fsltaxx3 was int, now long to accommodate using data's values)
(variable fsltaxx4 was int, now long to accommodate using data's values)
(variable fsltaxx5 was int, now long to accommodate using data's values)
(variable fssix5 was int, now long to accommodate using data's values)
(6,942 real changes made)
(variable wdbsgdsx was int, now long to accommodate using data's values)
(variable educacq was int, now long to accommodate using data's values)
(variable relectrc was int, now float to accommodate using data's values)
(variable ecartknc was int, now long to accommodate using data's values)
(variable otrincbx was int, now long to accommodate using data's values)
(variable famtfedm was float, now double to accommodate using data's
       values)
(6,794 real changes made)
(variable fssix was int, now long to accommodate using data's values)
(variable furntrpq was int, now long to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(variable fssix1 was int, now long to accommodate using data's values)
(variable fssix2 was int, now long to accommodate using data's values)
(variable fssix3 was int, now long to accommodate using data's values)
(variable fssix4 was int, now long to accommodate using data's values)
(6,895 real changes made)
(variable vnatlgac was int, now float to accommodate using data's values)
(6,940 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2008

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2008_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2008_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2008_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2008_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2008

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            27
        from master                         0  (_merge==1)
        from using                         27  (_merge==2)

    Matched                            57,533  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(27 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(97 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2008_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2008_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2008

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2008_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2008_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2008_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2008_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2008_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2008) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2008_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2008_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2008_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2008) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2008_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.251       2.984       0.265       3.273
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.20243     0.44504     0.42001     0.67446     0.47951
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.19194     0.35920     0.70630
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.812       2.584       0.379       2.678
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.58770     0.30843     0.31436     0.48997     0.41642
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14285     0.26540     0.54031
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2008

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2008_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2008_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2008_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2008_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2008_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2008_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2008_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2008_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2008_quarterly.dta"

. erase "$deriv/gini_2008_income_quarterly.dta"

. erase "$deriv/gini_2008_annual.dta"

. 
. display _n "Saved: gini_2008_all.dta"

Saved: gini_2008_all.dta

. 
end of do-file

Processing 2009...

. ****************************************************
. * 02_gini_2009.do
. * Build 2009 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw09/intrvw09"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw09/intrvw
> 09

. 
. use mtbi091x.dta, clear

. foreach f in mtbi092 mtbi093 mtbi094 mtbi101 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2009.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       800,392
        from master                   800,175  (_merge==1)
        from using                        217  (_merge==2)

    Matched                         2,072,678  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(800,392 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(270,224 real changes made, 270,224 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2009_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2009_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw09/intrvw
> 09

. preserve

. * Load first FMLI file and assign quarter
. use fmli091x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli092 fmli093 fmli094 fmli101 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable wtrep11 was float, now double to accommodate using data's
       values)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable entertcq was float, now double to accommodate using data's
       values)
(variable otheqpcq was float, now double to accommodate using data's
       values)
(variable othentcq was float, now double to accommodate using data's
       values)
(variable lifinscq was int, now long to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable tothentc was byte, now int to accommodate using data's values)
(variable vothrflp was int, now float to accommodate using data's values)
(variable rothrflp was byte, now float to accommodate using data's
       values)
(variable rothrflc was byte, now float to accommodate using data's
       values)
(variable rwaterpp was int, now float to accommodate using data's values)
(variable ehousngc was float, now double to accommodate using data's
       values)
(variable ecartknp was int, now long to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(variable lmpsumbx was int, now long to accommodate using data's values)
(variable colplanx was int, now long to accommodate using data's values)
(6,991 real changes made)
(variable setlinsx was int, now long to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable rwaterpc was byte, now int to accommodate using data's values)
(variable aliothbx was int, now long to accommodate using data's values)
(variable fjssded1 was int, now long to accommodate using data's values)
(variable fjssded2 was int, now long to accommodate using data's values)
(variable fjssded3 was int, now long to accommodate using data's values)
(variable fjssded4 was int, now long to accommodate using data's values)
(variable fjssded5 was int, now long to accommodate using data's values)
(6,994 real changes made)
(variable bbydaypq was int, now long to accommodate using data's values)
(variable hhid was byte, now int to accommodate using data's values)
(variable velectrp was int, now float to accommodate using data's values)
(variable rnatlgac was byte, now int to accommodate using data's values)
(variable ehousngp was float, now double to accommodate using data's
       values)
(7,104 real changes made)
(variable fjssdedx was int, now long to accommodate using data's values)
(variable menboypq was int, now long to accommodate using data's values)
(variable mensixpq was int, now long to accommodate using data's values)
(variable vothrflc was int, now float to accommodate using data's values)
(variable rnatlgac was int, now float to accommodate using data's values)
(variable rwaterpc was int, now float to accommodate using data's values)
(7,198 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2009

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2009_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2009_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2009_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2009_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2009

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            13
        from master                         0  (_merge==1)
        from using                         13  (_merge==2)

    Matched                            58,628  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(13 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(113 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2009_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2009_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2009

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2009_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2009_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2009_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2009_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2009_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2009) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2009_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2009_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2009_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2009) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2009_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     10.927       2.973       0.272       3.243
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.18525     0.44594     0.42612     0.70991     0.48063
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.19318     0.35977     0.70331
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.659       2.570       0.386       2.618
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.61530     0.30660     0.31345     0.48911     0.41476
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14214     0.26405     0.55169
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2009

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2009_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2009_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2009_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2009_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2009_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2009_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2009_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2009_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2009_quarterly.dta"

. erase "$deriv/gini_2009_income_quarterly.dta"

. erase "$deriv/gini_2009_annual.dta"

. 
. display _n "Saved: gini_2009_all.dta"

Saved: gini_2009_all.dta

. 
end of do-file

Processing 2010...

. ****************************************************
. * 02_gini_2010.do
. * Build 2010 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw10/intrvw10"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw10/intrvw
> 10

. 
. use mtbi101x.dta, clear

. foreach f in mtbi102 mtbi103 mtbi104 mtbi111 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2010.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       794,690
        from master                   794,475  (_merge==1)
        from using                        215  (_merge==2)

    Matched                         2,025,823  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(794,690 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(268,787 real changes made, 268,787 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2010_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2010_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw10/intrvw
> 10

. preserve

. * Load first FMLI file and assign quarter
. use fmli101x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli102 fmli103 fmli104 fmli111 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable wtrep02 was float, now double to accommodate using data's
       values)
(variable wtrep26 was float, now double to accommodate using data's
       values)
(variable houspq was float, now double to accommodate using data's
       values)
(variable houseqpq was float, now double to accommodate using data's
       values)
(variable furntrpq was int, now long to accommodate using data's values)
(variable cartkucq was int, now long to accommodate using data's values)
(variable ttotalp was int, now long to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable ehousngp was float, now double to accommodate using data's
       values)
(variable evehpurc was int, now long to accommodate using data's values)
(variable ecartknc was int, now long to accommodate using data's values)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable chdlmpb was str1, now str2 to accommodate using data's values)
(variable chdlmpbx was byte, now int to accommodate using data's values)
(variable othrincb was str1, now str2 to accommodate using data's values)
(variable otrincbx was byte, now int to accommodate using data's values)
(7,135 real changes made)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable fjssded1 was int, now long to accommodate using data's values)
(variable fjssded2 was int, now long to accommodate using data's values)
(variable fjssded3 was int, now long to accommodate using data's values)
(variable fjssded4 was int, now long to accommodate using data's values)
(variable fjssded5 was int, now long to accommodate using data's values)
(variable typepyx was byte, now int to accommodate using data's values)
(7,059 real changes made)
(variable entertpq was float, now double to accommodate using data's
       values)
(variable otheqppq was float, now double to accommodate using data's
       values)
(variable othentpq was float, now double to accommodate using data's
       values)
(variable cashcocq was int, now long to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(variable eentrmtp was float, now double to accommodate using data's
       values)
(variable eothentp was float, now double to accommodate using data's
       values)
(variable enomotrp was int, now long to accommodate using data's values)
(7,037 real changes made)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(variable etotalc was float, now double to accommodate using data's
       values)
(variable etotacx4 was float, now double to accommodate using data's
       values)
(variable inclsbbx was int, now long to accommodate using data's values)
(6,869 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2010

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2010_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2010_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2010_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2010_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2010

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            13
        from master                         0  (_merge==1)
        from using                         13  (_merge==2)

    Matched                            58,804  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(13 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(101 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2010_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2010_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2010

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2010_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2010_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2010_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2010_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2010_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2010) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2010_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2010_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2010_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2010) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2010_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     10.761       2.935       0.273       3.244
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.22906     0.44221     0.42392     0.68996     0.48003
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.19225     0.35739     0.71082
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.589       2.546       0.386       2.612
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.75651     0.30523     0.31211     0.47969     0.41391
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14156     0.26305     0.60207
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2010

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2010_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2010_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2010_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2010_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2010_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2010_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2010_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2010_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2010_quarterly.dta"

. erase "$deriv/gini_2010_income_quarterly.dta"

. erase "$deriv/gini_2010_annual.dta"

. 
. display _n "Saved: gini_2010_all.dta"

Saved: gini_2010_all.dta

. 
end of do-file

Processing 2011...

. ****************************************************
. * 02_gini_2011.do
. * Build 2011 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw11/intrvw11"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw11/intrvw
> 11

. 
. use mtbi111x.dta, clear

. foreach f in mtbi112 mtbi113 mtbi114 mtbi121 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2011.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       804,013
        from master                   803,802  (_merge==1)
        from using                        211  (_merge==2)

    Matched                         1,942,827  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(804,013 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(258,363 real changes made, 258,363 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2011_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2011_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw11/intrvw
> 11

. preserve

. * Load first FMLI file and assign quarter
. use fmli111x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli112 fmli113 fmli114 fmli121 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable insrfndx was int, now long to accommodate using data's values)
(variable setlinsx was int, now long to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable unemplbx was int, now long to accommodate using data's values)
(variable saleincb was str1, now str2 to accommodate using data's values)
(variable salincbx was byte, now int to accommodate using data's values)
(variable colplanx was int, now long to accommodate using data's values)
(6,729 real changes made)
(variable ecartkup was int, now long to accommodate using data's values)
(variable enomotrp was int, now long to accommodate using data's values)
(variable welfrebx was int, now long to accommodate using data's values)
(variable chdothbx was int, now long to accommodate using data's values)
(variable welfare1 was int, now long to accommodate using data's values)
(variable welfare2 was int, now long to accommodate using data's values)
(variable welfare3 was int, now long to accommodate using data's values)
(variable welfare4 was int, now long to accommodate using data's values)
(variable welfare5 was int, now long to accommodate using data's values)
(6,611 real changes made)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable fjssded2 was int, now long to accommodate using data's values)
(variable fjssded5 was int, now long to accommodate using data's values)
(6,781 real changes made)
(variable fjssdedx was int, now long to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(variable rothrflc was byte, now int to accommodate using data's values)
(variable otrincbx was int, now long to accommodate using data's values)
(6,838 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2011

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2011_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2011_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2011_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2011_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2011

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            16
        from master                         0  (_merge==1)
        from using                         16  (_merge==2)

    Matched                            56,328  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(16 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(78 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2011_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2011_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2011

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2011_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2011_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2011_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2011_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2011_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2011) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2011_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2011_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2011_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2011) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2011_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     10.732       2.867       0.267       3.233
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.06810     0.44133     0.42388     0.70383     0.47850
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.19188     0.35682     0.68114
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.468       2.492       0.385       2.599
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.51642     0.30109     0.30970     0.48199     0.41127
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14022     0.25999     0.50808
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2011

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2011_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2011_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2011_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2011_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2011_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2011_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2011_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2011_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2011_quarterly.dta"

. erase "$deriv/gini_2011_income_quarterly.dta"

. erase "$deriv/gini_2011_annual.dta"

. 
. display _n "Saved: gini_2011_all.dta"

Saved: gini_2011_all.dta

. 
end of do-file

Processing 2012...

. ****************************************************
. * 02_gini_2012.do
. * Build 2012 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw12/intrvw12"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw12/intrvw
> 12

. 
. use mtbi121x.dta, clear

. foreach f in mtbi122 mtbi123 mtbi124 mtbi131 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2012.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       805,404
        from master                   805,190  (_merge==1)
        from using                        214  (_merge==2)

    Matched                         1,940,300  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(805,404 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(257,523 real changes made, 257,523 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2012_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2012_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw12/intrvw
> 12

. preserve

. * Load first FMLI file and assign quarter
. use fmli121x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli122 fmli123 fmli124 fmli131 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable compbndx was int, now long to accommodate using data's values)
(variable furntrpq was int, now long to accommodate using data's values)
(variable educapq was int, now long to accommodate using data's values)
(variable educacq was int, now long to accommodate using data's values)
(variable mrtprnop was int, now long to accommodate using data's values)
(variable mrtprnoc was int, now long to accommodate using data's values)
(variable rwaterpc was byte, now int to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(6,715 real changes made)
(variable ecartkup was int, now long to accommodate using data's values)
(variable chdlmpb was str1, now str2 to accommodate using data's values)
(variable chdlmpbx was byte, now int to accommodate using data's values)
(variable aliothbx was int, now long to accommodate using data's values)
(variable colplanx was int, now long to accommodate using data's values)
(6,689 real changes made)
(variable enomotrc was int, now long to accommodate using data's values)
(variable unemplbx was int, now long to accommodate using data's values)
(variable inclsabx was int, now long to accommodate using data's values)
(6,751 real changes made)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable mrtprnop was long, now double to accommodate using data's
       values)
(variable mrtprnoc was long, now double to accommodate using data's
       values)
(variable emrtpnvp was int, now double to accommodate using data's
       values)
(variable emrtpnvc was int, now double to accommodate using data's
       values)
(6,769 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2012

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2012_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2012_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2012_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2012_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2012

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            16
        from master                         0  (_merge==1)
        from using                         16  (_merge==2)

    Matched                            56,085  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(16 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(81 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2012_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2012_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2012

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2012_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2012_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2012_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2012_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2012_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2012) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2012_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2012_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2012_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2012) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2012_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.469       3.038       0.265       3.361
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.33300     0.46243     0.44198     0.72335     0.48976
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.19992     0.37025     0.72722
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.806       2.593       0.381       2.668
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.79384     0.31577     0.32261     0.49541     0.42098
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14613     0.27077     0.61355
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2012

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2012_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2012_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2012_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2012_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2012_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2012_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2012_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2012_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2012_quarterly.dta"

. erase "$deriv/gini_2012_income_quarterly.dta"

. erase "$deriv/gini_2012_annual.dta"

. 
. display _n "Saved: gini_2012_all.dta"

Saved: gini_2012_all.dta

. 
end of do-file

Processing 2013...

. ****************************************************
. * 02_gini_2013.do
. * Build 2013 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw13/intrvw13"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw13/intrvw
> 13

. 
. use mtbi131x.dta, clear

. foreach f in mtbi132 mtbi133 mtbi134 mtbi141 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2013.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       714,492
        from master                   714,279  (_merge==1)
        from using                        213  (_merge==2)

    Matched                         1,728,054  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(714,492 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(232,213 real changes made, 232,213 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2013_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2013_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw13/intrvw
> 13

. preserve

. * Load first FMLI file and assign quarter
. use fmli131x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli132 fmli133 fmli134 fmli141 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable furntrpq was int, now long to accommodate using data's values)
(variable flrcvrpq was int, now double to accommodate using data's
       values)
(variable flrcvrcq was int, now double to accommodate using data's
       values)
(variable lifinspq was int, now long to accommodate using data's values)
(variable fjssded1 was int, now long to accommodate using data's values)
(variable fjssded2 was int, now long to accommodate using data's values)
(variable fjssded3 was int, now long to accommodate using data's values)
(variable fjssded4 was int, now long to accommodate using data's values)
(variable fjssded5 was int, now long to accommodate using data's values)
(6,762 real changes made)
(variable ttotalp was int, now long to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(6,500 real changes made)
(variable rfueloic was byte, now int to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable othlyrbx was int, now long to accommodate using data's values)
(6,077 real changes made)
(variable hhid was byte, now int to accommodate using data's values)
(variable rfueloip was byte, now int to accommodate using data's values)
(6,483 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2013

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2013_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2013_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2013_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2013_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2013

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            12
        from master                         0  (_merge==1)
        from using                         12  (_merge==2)

    Matched                            54,415  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(12 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(94 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2013_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2013_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2013

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2013_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2013_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2013_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2013_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2013_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2013) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2013_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2013_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2013_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2013) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2013_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.532       3.080       0.267       3.407
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.17231     0.46695     0.44814     0.73890     0.49367
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20242     0.37309     0.70101
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.841       2.631       0.385       2.670
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.50829     0.31284     0.32306     0.49926     0.42211
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14602     0.26863     0.50411
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2013

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2013_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2013_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2013_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2013_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2013_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2013_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2013_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2013_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2013_quarterly.dta"

. erase "$deriv/gini_2013_income_quarterly.dta"

. erase "$deriv/gini_2013_annual.dta"

. 
. display _n "Saved: gini_2013_all.dta"

Saved: gini_2013_all.dta

. 
end of do-file

Processing 2014...

. ****************************************************
. * 02_gini_2014.do
. * Build 2014 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw14/intrvw14"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw14/intrvw
> 14

. 
. use mtbi141x.dta, clear

. foreach f in mtbi142 mtbi143 mtbi144 mtbi151 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2014.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       695,886
        from master                   695,623  (_merge==1)
        from using                        263  (_merge==2)

    Matched                         1,683,796  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(695,886 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(234,720 real changes made, 234,720 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2014_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2014_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw14/intrvw
> 14

. preserve

. * Load first FMLI file and assign quarter
. use fmli141x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli142 fmli143 fmli144 fmli151 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable fjssdedx was int, now long to accommodate using data's values)
(variable frrdedx was byte, now int to accommodate using data's values)
(variable fssix was int, now long to accommodate using data's values)
(variable cartkucq was int, now long to accommodate using data's values)
(variable trntrppq was int, now long to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(variable ttranprp was int, now long to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable ttrntrip was int, now long to accommodate using data's values)
(variable tfarep was int, now long to accommodate using data's values)
(variable vfueloip was byte, now int to accommodate using data's values)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(variable frrdedm was byte, now int to accommodate using data's values)
(variable fssix1 was int, now long to accommodate using data's values)
(variable othlonbx was int, now long to accommodate using data's values)
(6,489 real changes made)
(variable educacq was int, now long to accommodate using data's values)
(variable rothrflc was byte, now int to accommodate using data's values)
(variable ecartkup was int, now long to accommodate using data's values)
(variable othrinc1 was int, now long to accommodate using data's values)
(variable othrinc2 was int, now long to accommodate using data's values)
(variable othrinc3 was int, now long to accommodate using data's values)
(variable othrinc4 was int, now long to accommodate using data's values)
(variable othrinc5 was int, now long to accommodate using data's values)
(6,466 real changes made)
(6,470 real changes made)
(variable medsrvpq was int, now long to accommodate using data's values)
(variable cashcocq was int, now long to accommodate using data's values)
(6,413 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2014

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2014_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2014_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2014_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2014_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2014

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            10
        from master                         0  (_merge==1)
        from using                         10  (_merge==2)

    Matched                            53,769  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(10 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(119 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2014_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2014_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2014

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2014_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2014_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2014_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2014_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2014_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2014) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2014_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2014_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2014_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2014) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2014_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.920       3.117       0.261       3.355
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.33040     0.47370     0.44991     0.71082     0.49537
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20396     0.37731     0.72684
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.873       2.662       0.387       2.624
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.52129     0.31403     0.32185     0.47708     0.42197
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14609     0.26950     0.51042
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2014

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2014_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2014_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2014_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2014_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2014_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2014_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2014_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2014_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2014_quarterly.dta"

. erase "$deriv/gini_2014_income_quarterly.dta"

. erase "$deriv/gini_2014_annual.dta"

. 
. display _n "Saved: gini_2014_all.dta"

Saved: gini_2014_all.dta

. 
end of do-file

Processing 2015...

. ****************************************************
. * 02_gini_2015.do
. * Build 2015 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw15/intrvw15"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw15/intrvw
> 15

. 
. use mtbi151x.dta, clear

. foreach f in mtbi152 mtbi153 mtbi154 mtbi161 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2015.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       664,099
        from master                   663,888  (_merge==1)
        from using                        211  (_merge==2)

    Matched                         1,562,973  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(664,099 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)
(32,693 missing values generated)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(117,846 real changes made, 117,846 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2015_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2015_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw15/intrvw
> 15

. preserve

. * Load first FMLI file and assign quarter
. use fmli151x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli152 fmli153 fmli154 fmli161 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable misctaxx was int, now long to accommodate using data's values)
(variable lifinscq was int, now long to accommodate using data's values)
(variable mrtprnop was long, now double to accommodate using data's
       values)
(variable mrtprnoc was int, now double to accommodate using data's
       values)
(variable emrtpnvp was int, now double to accommodate using data's
       values)
(variable emrtpnvc was int, now double to accommodate using data's
       values)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable enomotrp was int, now long to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(variable fjssded1 was int, now long to accommodate using data's values)
(variable fjssded2 was int, now long to accommodate using data's values)
(variable fjssded3 was int, now long to accommodate using data's values)
(variable fjssded4 was int, now long to accommodate using data's values)
(variable fjssded5 was int, now long to accommodate using data's values)
(variable creditbx was int, now long to accommodate using data's values)
(variable credyrbx was int, now long to accommodate using data's values)
(variable fstaxowe was int, now long to accommodate using data's values)
(6,518 real changes made)
(variable furntrpq was int, now long to accommodate using data's values)
(variable trntrppq was int, now long to accommodate using data's values)
(variable medsrvpq was int, now long to accommodate using data's values)
(variable ttotalp was int, now long to accommodate using data's values)
(variable ttotalc was int, now long to accommodate using data's values)
(variable ttranprp was int, now long to accommodate using data's values)
(variable ttrntrip was int, now long to accommodate using data's values)
(variable tfarep was int, now long to accommodate using data's values)
(variable enomotrc was int, now long to accommodate using data's values)
(variable fssix5 was int, now long to accommodate using data's values)
(variable othregbx was int, now long to accommodate using data's values)
(6,481 real changes made)
(variable educapq was int, now long to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(6,372 real changes made)
(variable fssix was int, now long to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable rothrflc was byte, now int to accommodate using data's values)
(6,426 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2015

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2015_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2015_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2015_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2015_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2015

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            34
        from master                         0  (_merge==1)
        from using                         34  (_merge==2)

    Matched                            51,139  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(34 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(19 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2015_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2015_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2015

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2015_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2015_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2015_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2015_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2015_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2015) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2015_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2015_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2015_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2015) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2015_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.457       2.738       0.367       2.750
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.86722     0.34384     0.35059     0.54315     0.43836
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15808     0.29096     0.63429
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.107       2.676       0.376       2.681
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.84306     0.32841     0.33454     0.50982     0.42911
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15148     0.27993     0.62772
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2015

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2015_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2015_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2015_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2015_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2015_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2015_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2015_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2015_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2015_quarterly.dta"

. erase "$deriv/gini_2015_income_quarterly.dta"

. erase "$deriv/gini_2015_annual.dta"

. 
. display _n "Saved: gini_2015_all.dta"

Saved: gini_2015_all.dta

. 
end of do-file

Processing 2016...

. ****************************************************
. * 02_gini_2016.do
. * Build 2016 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw16/intrvw16"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw16/intrvw
> 16

. 
. use mtbi161x.dta, clear

. foreach f in mtbi162 mtbi163 mtbi164 mtbi171 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2016.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       708,846
        from master                   708,633  (_merge==1)
        from using                        213  (_merge==2)

    Matched                         1,688,050  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(708,846 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)
(33,988 missing values generated)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(128,542 real changes made, 128,542 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2016_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2016_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw16/intrvw
> 16

. preserve

. * Load first FMLI file and assign quarter
. use fmli161x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli162 fmli163 fmli164 fmli171 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable cashcocq was int, now long to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(6,342 real changes made)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable fmlpyyrx was int, now long to accommodate using data's values)
(variable othlyrbx was int, now long to accommodate using data's values)
(6,372 real changes made)
(variable trntrppq was int, now long to accommodate using data's values)
(variable ttranprp was int, now long to accommodate using data's values)
(variable ttrntrip was int, now long to accommodate using data's values)
(variable tfarep was int, now long to accommodate using data's values)
(variable othlonbx was int, now long to accommodate using data's values)
(6,301 real changes made)
(variable emotrvhc was int, now long to accommodate using data's values)
(6,208 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2016

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2016_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2016_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2016_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2016_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2016

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            29
        from master                         0  (_merge==1)
        from using                         29  (_merge==2)

    Matched                            52,575  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(29 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(13 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2016_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2016_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2016

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2016_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2016_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2016_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2016_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2016_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2016) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2016_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2016_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2016_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2016) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2016_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.206       2.706       0.375       2.732
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.84213     0.34393     0.35820     0.81732     0.43578
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15814     0.29102     0.62746
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.960       2.648       0.380       2.657
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.82788     0.32953     0.34313     0.76486     0.42683
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15195     0.28074     0.62346
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2016

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2016_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2016_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2016_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2016_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2016_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2016_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2016_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2016_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2016_quarterly.dta"

. erase "$deriv/gini_2016_income_quarterly.dta"

. erase "$deriv/gini_2016_annual.dta"

. 
. display _n "Saved: gini_2016_all.dta"

Saved: gini_2016_all.dta

. 
end of do-file

Processing 2017...

. ****************************************************
. * 02_gini_2017.do
. * Build 2017 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw17/intrvw17"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw17/intrvw
> 17

. 
. use mtbi171x.dta, clear

. foreach f in mtbi172 mtbi173 mtbi174 mtbi181 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2017.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       689,972
        from master                   689,759  (_merge==1)
        from using                        213  (_merge==2)

    Matched                         1,732,276  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(689,972 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)
(31,731 missing values generated)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(114,999 real changes made, 114,999 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2017_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2017_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw17/intrvw
> 17

. preserve

. * Load first FMLI file and assign quarter
. use fmli171x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli172 fmli173 fmli174 fmli181 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(6,177 real changes made)
(6,090 real changes made)
(6,004 real changes made)
(5,916 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2017

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2017_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2017_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2017_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2017_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2017

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             9
        from master                         0  (_merge==1)
        from using                          9  (_merge==2)

    Matched                            50,590  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(9 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(10 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2017_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2017_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2017

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2017_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2017_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2017_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2017_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2017_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2017) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2017_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2017_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2017_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2017) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2017_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.268       2.693       0.370       2.734
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.67409     0.34791     0.36468     0.80353     0.43862
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.16050     0.29383     0.57414
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.992       2.624       0.375       2.690
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.62140     0.33300     0.34900     0.74722     0.42998
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15423     0.28323     0.55413
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2017

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2017_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2017_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2017_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2017_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2017_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2017_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2017_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2017_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2017_quarterly.dta"

. erase "$deriv/gini_2017_income_quarterly.dta"

. erase "$deriv/gini_2017_annual.dta"

. 
. display _n "Saved: gini_2017_all.dta"

Saved: gini_2017_all.dta

. 
end of do-file

Processing 2018...

. ****************************************************
. * 02_gini_2018.do
. * Build 2018 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw18"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw18

. 
. use mtbi181x.dta, clear

. foreach f in mtbi182 mtbi183 mtbi184 mtbi191 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2018.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       655,757
        from master                   655,540  (_merge==1)
        from using                        217  (_merge==2)

    Matched                         1,687,921  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(655,757 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)
(29,812 missing values generated)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(106,798 real changes made, 106,798 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2018_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2018_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw18

. preserve

. * Load first FMLI file and assign quarter
. use fmli181x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli182 fmli183 fmli184 fmli191 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(5,899 real changes made)
(5,773 real changes made)
(5,571 real changes made)
(5,623 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2018

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2018_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2018_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2018_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2018_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2018

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            24
        from master                         0  (_merge==1)
        from using                         24  (_merge==2)

    Matched                            47,760  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(24 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(13 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2018_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2018_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2018

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2018_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2018_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2018_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2018_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2018_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2018) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2018_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2018_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2018_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2018) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2018_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.124       2.677       0.376       2.661
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.64639     0.33908     0.34806     0.55973     0.43367
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15613     0.28758     0.56385
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.906       2.639       0.382       2.622
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.59975     0.32583     0.33401     0.52863     0.42583
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15044     0.27807     0.54535
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2018

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2018_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2018_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2018_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2018_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2018_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2018_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2018_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2018_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2018_quarterly.dta"

. erase "$deriv/gini_2018_income_quarterly.dta"

. erase "$deriv/gini_2018_annual.dta"

. 
. display _n "Saved: gini_2018_all.dta"

Saved: gini_2018_all.dta

. 
end of do-file

Processing 2019...

. ****************************************************
. * 02_gini_2019.do
. * Build 2019 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw19/intrvw19"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw19/intrvw
> 19

. 
. use mtbi191x.dta, clear

. foreach f in mtbi192 mtbi193 mtbi194 mtbi201 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2019.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       621,450
        from master                   621,235  (_merge==1)
        from using                        215  (_merge==2)

    Matched                         1,592,354  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(621,450 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)
(27,580 missing values generated)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(100,979 real changes made, 100,979 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2019_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2019_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw19/intrvw
> 19

. preserve

. * Load first FMLI file and assign quarter
. use fmli191x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli192 fmli193 fmli194 fmli201 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(5,493 real changes made)
(5,337 real changes made)
(5,248 real changes made)
(5,202 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2019

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2019_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2019_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2019_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2019_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2019

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            14
        from master                         0  (_merge==1)
        from using                         14  (_merge==2)

    Matched                            44,467  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(14 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(7 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2019_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2019_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2019

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2019_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2019_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2019_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2019_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2019_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2019) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2019_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2019_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2019_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2019) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2019_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.847       2.687       0.392       2.615
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.54570     0.32359     0.33545     0.54708     0.42695
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15048     0.27645     0.52185
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.649       2.635       0.396       2.589
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.50988     0.31190     0.32358     0.52321     0.41991
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14552     0.26795     0.50489
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2019

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2019_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2019_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2019_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2019_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2019_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2019_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2019_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2019_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2019_quarterly.dta"

. erase "$deriv/gini_2019_income_quarterly.dta"

. erase "$deriv/gini_2019_annual.dta"

. 
. display _n "Saved: gini_2019_all.dta"

Saved: gini_2019_all.dta

. 
end of do-file

Processing 2020...

. ****************************************************
. * 02_gini_2020.do
. * Build 2020 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw20"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw20

. 
. use mtbi202.dta, clear

. foreach f in mtbi203 mtbi204 mtbi211 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2020.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       465,906
        from master                   465,692  (_merge==1)
        from using                        214  (_merge==2)

    Matched                         1,113,483  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(465,906 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)
(19,232 missing values generated)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(68,970 real changes made, 68,970 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2020_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2020_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw20

. preserve

. * Load first FMLI file and assign quarter
. use fmli202.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli203 fmli204 fmli211 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(4,980 real changes made)
(5,205 real changes made)
(5,115 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2020

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2020_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2020_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2020_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2020_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2020

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         0  (_merge==1)
        from using                          2  (_merge==2)

    Matched                            33,756  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(2 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(6 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2020_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2020_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2020

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2020_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2020_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2020_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2020_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2020_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2020) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2020_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2020_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2020_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2020) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2020_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.299       2.625       0.417       2.507
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.51952     0.30888     0.33862     0.61779     0.42235
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14801     0.26573     0.50957
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.143       2.562       0.417       2.469
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.44993     0.29533     0.32326     0.57596     0.41406
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14202     0.25571     0.47365
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2020

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2020_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2020_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2020_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2020_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2020_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2020_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2020_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2020_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2020_quarterly.dta"

. erase "$deriv/gini_2020_income_quarterly.dta"

. erase "$deriv/gini_2020_annual.dta"

. 
. display _n "Saved: gini_2020_all.dta"

Saved: gini_2020_all.dta

. 
end of do-file

Processing 2021...

. ****************************************************
. * 02_gini_2021.do
. * Build 2021 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw21"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw21

. 
. use mtbi212.dta, clear

. foreach f in mtbi213 mtbi214 mtbi221 {
  2.     append using `f'.dta
  3. }

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2021.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       550,611
        from master                   550,329  (_merge==1)
        from using                        282  (_merge==2)

    Matched                         1,111,816  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(550,611 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(160,155 real changes made, 160,155 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2021_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2021_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw21

. preserve

. * Load first FMLI file and assign quarter
. use fmli212.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli213 fmli214 fmli221 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(5,121 real changes made)
(4,902 real changes made)
(5,187 real changes made)

. 
. * Handle variable name casing (2021-2023 use uppercase FINCBTXM/FSALARYM,
>  standardize to lowercase)
. capture rename FINCBTXM fincbtxm

. capture rename FSALARYM fsalarym

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2021

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2021_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2021_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2021_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2021_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2021

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             5
        from master                         0  (_merge==1)
        from using                          5  (_merge==2)

    Matched                            33,965  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(5 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(45 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2021_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2021_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2021

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2021_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2021_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2021_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2021_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2021_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2021) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2021_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2021_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2021_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2021) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2021_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.081       3.135       0.283       3.248
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.06670     0.48380     0.50050     0.97700     0.50801
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.21575     0.38356     0.68086
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.573       2.646       0.403       2.509
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.50851     0.32386     0.35917     0.65694     0.43093
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15524     0.27665     0.50422
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2021

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2021_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2021_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2021_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2021_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2021_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2021_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2021_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2021_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2021_quarterly.dta"

. erase "$deriv/gini_2021_income_quarterly.dta"

. erase "$deriv/gini_2021_annual.dta"

. 
. display _n "Saved: gini_2021_all.dta"

Saved: gini_2021_all.dta

. 
end of do-file

Processing 2022...

. ****************************************************
. * 02_gini_2022.do
. * Build 2022 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw22"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. * Ensure ineqdeco is installed
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata for 2022
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw22

. 
. use mtbi222.dta, clear

. foreach f in mtbi223 mtbi224 mtbi231 {
  2.     append using `f'.dta
  3. }

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2022.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       504,603
        from master                   504,358  (_merge==1)
        from using                        245  (_merge==2)

    Matched                         1,051,806  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(504,603 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. * Exclusions from core: mortgage/rent/health/education
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. * Broad: all food + expenditure
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. 
. * Core: broad minus excluded categories
. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(153,474 real changes made, 153,474 to missing)

. 
. * Create quarter from REF_MO
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2022_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2022_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw22

. preserve

. * Load first FMLI file and assign quarter
. use fmli222.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli223 fmli224 fmli231 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(4,580 real changes made)
(4,617 real changes made)
(4,807 real changes made)

. 
. * Handle variable name casing (2021-2023 use uppercase FINCBTXM/FSALARYM,
>  standardize to lowercase)
. capture rename FINCBTXM fincbtxm

. capture rename FSALARYM fsalarym

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2022

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2022_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2022_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2022_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2022_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2022

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             4
        from master                         0  (_merge==1)
        from using                          4  (_merge==2)

    Matched                            31,705  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(4 observations deleted)

. drop _merge

. 
. * Drop zero/negative consumption
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(61 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2022_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2022_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2022

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2022_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2022_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. use "$deriv/cons_2022_cuq.dta", clear

. 
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2022_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2022_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2022_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2022) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2022_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2022_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2022_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2022) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2022_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.287       3.098       0.274       3.295
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.10947     0.47574     0.48868     1.11411     0.50251
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.21123     0.37857     0.68934
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.556       2.644       0.403       2.558
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.54207     0.31962     0.35512     0.74984     0.42832
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15309     0.27357     0.52019
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2022

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2022_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2022_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2022_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual into one file
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2022_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2022_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2022_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2022_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2022_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2022_quarterly.dta"

. erase "$deriv/gini_2022_income_quarterly.dta"

. erase "$deriv/gini_2022_annual.dta"

. 
. display _n "Saved:"

Saved:

. display "  $deriv/mtbi_2022_tagged.dta (item-level)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_
> 2022_tagged.dta (item-level)

. display "  $deriv/cons_2022_cuq.dta (CU-quarter)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_
> 2022_cuq.dta (CU-quarter)

. display "  $deriv/cons_2022_cuy.dta (CU-year)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_
> 2022_cuy.dta (CU-year)

. display "  $deriv/gini_2022_all.dta (quarterly + annual Ginis)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_
> 2022_all.dta (quarterly + annual Ginis)

. 
. 
end of do-file

Processing 2023...

. ****************************************************
. * 02_gini_2023.do
. * Build 2023 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw23"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. * Ensure ineqdeco is installed
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata for 2023
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw23

. 
. use mtbi232.dta, clear

. foreach f in mtbi233 mtbi234 mtbi241 {
  2.     append using `f'.dta
  3. }

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2023.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       492,423
        from master                   492,215  (_merge==1)
        from using                        208  (_merge==2)

    Matched                         1,016,933  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(492,423 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. * Exclusions from core: mortgage/rent/health/education
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. * Broad: all food + expenditure
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. 
. * Core: broad minus excluded categories
. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(153,650 real changes made, 153,650 to missing)

. 
. * Create quarter from REF_MO
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2023_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2023_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw23

. preserve

. * Load first FMLI file and assign quarter
. use fmli232.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli233 fmli234 fmli241 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(4,770 real changes made)
(4,662 real changes made)
(4,688 real changes made)

. 
. * Handle variable name casing (2021-2023 use uppercase FINCBTXM/FSALARYM,
>  standardize to lowercase)
. capture rename FINCBTXM fincbtxm

. capture rename FSALARYM fsalarym

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2023

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2023_cuq.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2023_cu
    > q.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2023_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2023_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2023

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             1
        from master                         0  (_merge==1)
        from using                          1  (_merge==2)

    Matched                            31,420  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(1 observation deleted)

. drop _merge

. 
. * Drop zero/negative consumption
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(29 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2023_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2023_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2023

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2023_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2023_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. use "$deriv/cons_2023_cuq.dta", clear

. 
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2023_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2023_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2023_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2023) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. use "$deriv/income_2023_cuq.dta", clear

. 
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2023_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2023_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2023_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2023) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2023_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.877       3.203       0.270       3.351
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.24510     0.49174     0.48930     0.85537     0.50865
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.21538     0.38844     0.71348
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.747       2.702       0.401       2.544
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.59726     0.32777     0.34887     0.57985     0.43078
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15407     0.27947     0.54432
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2023

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2023_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2023_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2023_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual into one file
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2023_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2023_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2023_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2023_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2023_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2023_quarterly.dta"

. erase "$deriv/gini_2023_income_quarterly.dta"

. erase "$deriv/gini_2023_annual.dta"

. 
. display _n "Saved:"

Saved:

. display "  $deriv/mtbi_2023_tagged.dta (item-level)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_
> 2023_tagged.dta (item-level)

. display "  $deriv/cons_2023_cuq.dta (CU-quarter)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_
> 2023_cuq.dta (CU-quarter)

. display "  $deriv/cons_2023_cuy.dta (CU-year)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_
> 2023_cuy.dta (CU-year)

. display "  $deriv/gini_2023_all.dta (quarterly + annual Ginis)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_
> 2023_all.dta (quarterly + annual Ginis)

. 
end of do-file

. 
. * Step 3: Append all years together
. display _n "=== Appending all years ===" _n

=== Appending all years ===


. do "$code/03_append_gini_all.do"

. ****************************************************
. * 03_append_gini_all.do
. * Append all yearly Gini files into one panel
. * with quarterly date format for merging
. ****************************************************
. 
. clear all

. set more off

. 
. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. ****************************************************
. * 1. Append all yearly Gini files
. ****************************************************
. cd "$deriv"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived

. 
. use gini_1996_all.dta, clear

. 
. forvalues y = 1997/2023 {
  2.     capture append using gini_`y'_all.dta
  3. }

. 
. ****************************************************
. * 2. Sort and create quarterly date variable
. ****************************************************
. sort year quarter

. 
. * Create Stata quarterly date (for quarterly obs only)
. gen qdate = yq(year, quarter) if quarter != .
(27 missing values generated)

. format qdate %tq

. 
. * Create string date like "1996q1" for easy reading
. gen str8 date_str = string(year) + "q" + string(quarter) if quarter != .
(27 missing values generated)

. replace date_str = string(year) + " annual" if quarter == .
variable date_str was str8 now str11
(27 real changes made)

. 
. ****************************************************
. * 3. Order and save final panel
. ****************************************************
. order year quarter qdate date_str gini_core gini_broad gini_fincbtax gini
> _fsalaryx

. sort year quarter

. 
. label var year          "Year"

. label var quarter       "Quarter (. = annual)"

. label var qdate         "Stata quarterly date"

. label var date_str      "Date string"

. label var gini_core     "Gini coefficient - core consumption"

. label var gini_broad    "Gini coefficient - broad consumption"

. label var gini_fincbtax "Gini coefficient - income before taxes"

. label var gini_fsalaryx "Gini coefficient - salary income"

. 
. save "$deriv/gini_1996_2023.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_2023
    > .dta saved

. 
. * Also export quarterly-only version (for merging with monthly data)
. drop if quarter == .
(27 observations deleted)

. drop date_str

. order year quarter qdate gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_1996_2023_quarterly.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_2023
    > _quarterly.dta saved

. 
. display _n "Saved:"

Saved:

. display "  $deriv/gini_1996_2023.dta (quarterly + annual)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_
> 1996_2023.dta (quarterly + annual)

. display "  $deriv/gini_1996_2023_quarterly.dta (quarterly only)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_
> 1996_2023_quarterly.dta (quarterly only)

. 
. * Show summary
. list in 1/20

     +-------------------------------------------------------------+
  1. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1996 |       1 | 1996q1 | .55468213 | .49419832 | .48794494 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                           .4469206                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
  2. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1996 |       2 | 1996q2 | .56675941 | .50503184 | .48039882 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44027883                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
  3. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1996 |       3 | 1996q3 | .57520928 | .51438453 | .47925651 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                           .4351627                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
  4. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1996 |       4 | 1996q4 | .55639912 | .49887649 | .48211903 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44501452                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
  5. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1997 |       1 | 1997q1 | .54642597 | .48424696 | .47472963 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44305942                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
  6. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1997 |       2 | 1997q2 | .55785435 | .49735394 | .47345289 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44555976                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
  7. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1997 |       3 | 1997q3 | .56695318 | .50885453 | .47236631 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44213179                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
  8. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1997 |       4 | 1997q4 | .54984284 | .49451624 | .47498209 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44150127                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
  9. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1998 |       1 | 1998q1 | .55603067 | .49286135 | .47864468 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .43974221                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 10. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1998 |       2 | 1998q2 | .57069699 | .50973879 | .47534157 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .43696457                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 11. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1998 |       3 | 1998q3 | .56856592 |  .5095694 | .47891865 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44108099                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 12. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1998 |       4 | 1998q4 | .55375674 |  .4987267 | .48489898 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44414738                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 13. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 2000 |       1 | 2000q1 | .56679806 | .50698114 | .49092228 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                           .4411787                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 14. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 2000 |       2 | 2000q2 | .56903703 | .50977404 | .48835974 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .43355742                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 15. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 2000 |       3 | 2000q3 | .57262391 | .51582328 | .48610998 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .43286336                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 16. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 2000 |       4 | 2000q4 | .56101712 | .50705849 | .49586488 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44692902                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 17. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 2001 |       1 | 2001q1 | .56722331 |  .5072244 |  .4964892 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44473754                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 18. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 2001 |       2 | 2001q2 | .57571294 | .51578006 | .47983586 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44222975                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 19. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 2001 |       3 | 2001q3 | .57161633 | .51590847 | .47696455 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .43975238                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 20. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 2001 |       4 | 2001q4 | .56907023 | .51333295 | .47492692 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44630957                          |
     +-------------------------------------------------------------+

. 
. 
end of do-file

. 
. * Step 4: Merge BH shocks
. display _n "=== Merging BH shocks ===" _n

=== Merging BH shocks ===


. do "$code/04_merge_bh_shocks.do"

. ****************************************************
. * 04_merge_bh_shocks.do
. * Import BH supply and demand shocks and merge with quarterly Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global bh_shocks "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data
> /BH shocks"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. global code "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code"

. 
. * Start log file
. log using "$code/04_merge_bh_shocks.log", replace
log file already open
r(604);

end of do-file
r(604);

end of do-file

r(604);

. do "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/00_run_all.do"

. ****************************************************
. * 00_run_all.do
. * Master file - runs entire Gini pipeline
. ****************************************************
. 
. clear all

. set more off

. 
. global code "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code"

. 
. * Step 1: Build all UCC maps
. display _n "=== Building UCC maps ===" _n

=== Building UCC maps ===


. do "$code/01_build_ucc_map.do"

. ****************************************************
. * 01_build_ucc_map.do
. * Build UCC mappings for all years 1996-2023
. ****************************************************
. 
. clear all

. set more off

. 
. global stubs "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /stubs"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture mkdir "$deriv"

. 
. ****************************************************
. * Loop through all years and build UCC maps
. ****************************************************
. forvalues year = 1996/2023 {
  2.     
.     display _n "Processing year `year'..."
  3.     
.     cd "$stubs"
  4.     
.     quietly {
  5.         infix ///
>             str1 line_type      1       ///
>             byte level          4       ///
>             str59 name          11-69   ///
>             str6 ucc_code       70-75   ///
>             str1 source         80      ///
>             byte factor         83      ///
>             str7 section        86-92   ///
>             using "CE-HG-Integ-`year'.txt", clear
  6.         
.         * Drop comment lines
.         drop if line_type=="*"
  7.         
.         * Drop empty ucc_code rows
.         drop if trim(ucc_code)==""
  8.         
.         * Keep only rows where ucc_code is all digits (real UCCs)
.         gen byte ucc_isnum = regexm(ucc_code, "^[0-9]+$")
  9.         keep if ucc_isnum
 10.         drop ucc_isnum
 11.         
.         * Extract section name (handles both "FOOD" and "1  FOOD" formats
> )
.         gen section_clean = word(section, -1)  // gets last word
 12.         
.         * Map abbreviations to full names
.         replace section_clean = "EXPEND" if section_clean == "EXPE"
 13.         replace section_clean = "ADDENDA" if section_clean == "ADDE"
 14.         replace section_clean = "ASSETS" if section_clean == "ASSE"
 15.         replace section_clean = "CUCHARS" if section_clean == "CUCH"
 16.         replace section_clean = "INCOME" if section_clean == "INCO"
 17.         
.         * Keep only expenditure sections
.         keep if inlist(section_clean, "FOOD", "EXPEND")
 18.         drop section
 19.         rename section_clean section
 20.         
.         * Make numeric UCC
.         destring ucc_code, gen(UCC) ignore(" ")
 21.         
.         keep UCC section name
 22.         compress
 23.         save "$deriv/ucc_map_`year'.dta", replace
 24.     }
 25.     
.     display "  Saved: ucc_map_`year'.dta"
 26. }

Processing year 1996...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_1996.dta

Processing year 1997...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_1997.dta

Processing year 1998...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_1998.dta

Processing year 1999...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_1999.dta

Processing year 2000...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2000.dta

Processing year 2001...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2001.dta

Processing year 2002...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2002.dta

Processing year 2003...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2003.dta

Processing year 2004...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2004.dta

Processing year 2005...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2005.dta

Processing year 2006...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2006.dta

Processing year 2007...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2007.dta

Processing year 2008...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2008.dta

Processing year 2009...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2009.dta

Processing year 2010...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2010.dta

Processing year 2011...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2011.dta

Processing year 2012...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2012.dta

Processing year 2013...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2013.dta

Processing year 2014...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2014.dta

Processing year 2015...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2015.dta

Processing year 2016...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2016.dta

Processing year 2017...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2017.dta

Processing year 2018...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2018.dta

Processing year 2019...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2019.dta

Processing year 2020...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2020.dta

Processing year 2021...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2021.dta

Processing year 2022...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2022.dta

Processing year 2023...
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/stubs
  Saved: ucc_map_2023.dta

. 
. display _n "Done. UCC maps saved for 1996-2023."

Done. UCC maps saved for 1996-2023.

. 
end of do-file

. 
. * Step 2: Run each year's Gini computation
. display _n "=== Computing yearly Ginis ===" _n

=== Computing yearly Ginis ===


. forvalues y = 1996/2023 {
  2.     if `y' != 1999 {
  3.         display _n "Processing `y'..."
  4.         do "$code/02_gini_`y'.do"
  5.     }
  6. }

Processing 1996...

. ****************************************************
. * 02_gini_1996.do
. * Build 1996 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw96/intrvw96"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw96/intrvw
> 96

. 
. use mtbi961x.dta, clear

. foreach f in mtbi962 mtbi963 mtbi964 mtbi971 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_1996.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       601,279
        from master                   601,091  (_merge==1)
        from using                        188  (_merge==2)

    Matched                         1,735,121  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(601,279 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(200,853 real changes made, 200,853 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_1996_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_1996_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw96/intrvw
> 96

. preserve

. * Load first FMLI file and assign quarter
. use fmli961x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli962 fmli963 fmli964 fmli971 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable chldsupx was int, now long to accommodate using data's values)
(variable cshcntbx was int, now long to accommodate using data's values)
(variable finlwt21 was float, now double to accommodate using data's
       values)
(variable inclossb was int, now long to accommodate using data's values)
(variable othrincx was int, now long to accommodate using data's values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable cartkupq was int, now long to accommodate using data's values)
(variable trntrpcq was int, now long to accommodate using data's values)
(variable perscapq was int, now float to accommodate using data's values)
(variable perscacq was int, now float to accommodate using data's values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(5,437 real changes made)
(variable cbsgftx was int, now long to accommodate using data's values)
(variable collexpx was int, now long to accommodate using data's values)
(variable totexppq was float, now double to accommodate using data's
       values)
(variable trntrppq was int, now long to accommodate using data's values)
(variable entertpq was float, now double to accommodate using data's
       values)
(variable entertcq was float, now double to accommodate using data's
       values)
(variable otheqppq was float, now double to accommodate using data's
       values)
(variable otheqpcq was float, now double to accommodate using data's
       values)
(variable othentpq was float, now double to accommodate using data's
       values)
(variable othentcq was float, now double to accommodate using data's
       values)
(variable totex4pq was float, now double to accommodate using data's
       values)
(5,295 real changes made)
(variable alimox was int, now long to accommodate using data's values)
(5,480 real changes made)
(5,584 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 1996

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_1996_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_1996_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_1996_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 1996

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             4
        from master                         0  (_merge==1)
        from using                          4  (_merge==2)

    Matched                            43,455  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(4 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(46 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_1996_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1996_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 1996

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_1996_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1996_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_1996_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_1996_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (1996) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_1996_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_1996_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (1996) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_1996_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.778       3.121       0.265       3.411
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.98398     0.46490     0.45439     0.76392     0.49600
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20376     0.37180     0.66307
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.334       2.712       0.370       2.777
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.49024     0.32835     0.33927     0.53221     0.43243
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15294     0.27989     0.49507
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 1996

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_1996_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_1996_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_1996_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_1996_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_1996_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_1996_quarterly.dta"

. erase "$deriv/gini_1996_income_quarterly.dta"

. erase "$deriv/gini_1996_annual.dta"

. 
. display _n "Saved: gini_1996_all.dta"

Saved: gini_1996_all.dta

. 
. 
end of do-file

Processing 1997...

. ****************************************************
. * 02_gini_1997.do
. * Build 1997 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw97/intrvw97/intrvw97"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw97/intrvw
> 97/intrvw97

. 
. use mtbi971x.dta, clear

. foreach f in mtbi972 mtbi973 mtbi974 mtbi981 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_1997.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       664,193
        from master                   664,009  (_merge==1)
        from using                        184  (_merge==2)

    Matched                         1,915,973  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(664,193 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(218,325 real changes made, 218,325 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_1997_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_1997_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw97/intrvw
> 97/intrvw97

. preserve

. * Load first FMLI file and assign quarter
. use fmli971x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli972 fmli973 fmli974 fmli981 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable cntrchrx was int, now long to accommodate using data's values)
(variable compowdx was int, now long to accommodate using data's values)
(variable wtrep01 was float, now double to accommodate using data's
       values)
(variable wtrep08 was float, now double to accommodate using data's
       values)
(variable wtrep21 was float, now double to accommodate using data's
       values)
(variable wtrep27 was float, now double to accommodate using data's
       values)
(variable wtrep40 was float, now double to accommodate using data's
       values)
(variable cartkncq was int, now long to accommodate using data's values)
(5,502 real changes made)
(variable compensx was int, now long to accommodate using data's values)
(variable fssix was int, now long to accommodate using data's values)
(variable wtrep06 was float, now double to accommodate using data's
       values)
(variable wtrep09 was float, now double to accommodate using data's
       values)
(variable wtrep13 was float, now double to accommodate using data's
       values)
(variable wtrep30 was float, now double to accommodate using data's
       values)
(variable wtrep31 was float, now double to accommodate using data's
       values)
(variable wtrep34 was float, now double to accommodate using data's
       values)
(variable wtrep43 was float, now double to accommodate using data's
       values)
(5,488 real changes made)
(variable alimox was int, now long to accommodate using data's values)
(variable chldsupx was int, now long to accommodate using data's values)
(variable collexpx was int, now long to accommodate using data's values)
(variable cshcntbx was int, now long to accommodate using data's values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable erankmth was float, now double to accommodate using data's
       values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(5,609 real changes made)
(variable cntrelgx was int, now long to accommodate using data's values)
(variable medsuppq was int, now float to accommodate using data's values)
(variable totex4pq was float, now double to accommodate using data's
       values)
(5,614 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 1997

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_1997_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_1997_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_1997_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 1997

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         0  (_merge==1)
        from using                          2  (_merge==2)

    Matched                            46,245  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(2 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(51 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_1997_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1997_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 1997

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_1997_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1997_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_1997_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_1997_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (1997) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_1997_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_1997_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (1997) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_1997_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.467       3.053       0.266       3.319
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.04453     0.44984     0.42889     0.65831     0.48650
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.19572     0.36227     0.67628
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.223       2.657       0.368       2.710
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.49211     0.31838     0.32095     0.46320     0.42447
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14710     0.27268     0.49602
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 1997

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_1997_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_1997_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_1997_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_1997_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_1997_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1997_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_1997_quarterly.dta"

. erase "$deriv/gini_1997_income_quarterly.dta"

. erase "$deriv/gini_1997_annual.dta"

. 
. display _n "Saved: gini_1997_all.dta"

Saved: gini_1997_all.dta

. 
. 
end of do-file

Processing 1998...

. ****************************************************
. * 02_gini_1998.do
. * Build 1998 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw98/intrvw98/intrvw98"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw98/intrvw
> 98/intrvw98

. 
. use mtbi981x.dta, clear

. foreach f in mtbi982 mtbi983 mtbi984 mtbi991 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_1998.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       700,664
        from master                   700,453  (_merge==1)
        from using                        211  (_merge==2)

    Matched                         1,992,549  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(700,664 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(227,221 real changes made, 227,221 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_1998_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_1998_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw98/intrvw
> 98/intrvw98

. preserve

. * Load first FMLI file and assign quarter
. use fmli981x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli982 fmli983 fmli984 fmli991 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable inclossa was int, now long to accommodate using data's values)
(variable wdbsastx was int, now long to accommodate using data's values)
(variable wdbsgdsx was int, now long to accommodate using data's values)
(variable wtrep01 was float, now double to accommodate using data's
       values)
(variable wtrep04 was float, now double to accommodate using data's
       values)
(variable wtrep06 was float, now double to accommodate using data's
       values)
(variable wtrep13 was float, now double to accommodate using data's
       values)
(variable wtrep23 was float, now double to accommodate using data's
       values)
(variable wtrep27 was float, now double to accommodate using data's
       values)
(variable wtrep28 was float, now double to accommodate using data's
       values)
(variable wtrep30 was float, now double to accommodate using data's
       values)
(variable wtrep31 was float, now double to accommodate using data's
       values)
(variable wtrep38 was float, now double to accommodate using data's
       values)
(variable wtrep40 was float, now double to accommodate using data's
       values)
(variable wtrep43 was float, now double to accommodate using data's
       values)
(variable totexppq was float, now double to accommodate using data's
       values)
(variable cartkupq was int, now long to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(5,467 real changes made)
(variable cshcntbx was int, now long to accommodate using data's values)
(variable trntrppq was int, now long to accommodate using data's values)
(5,527 real changes made)
(variable collexpx was int, now long to accommodate using data's values)
(variable frretirx was int, now long to accommodate using data's values)
(variable fssix was int, now long to accommodate using data's values)
(variable wtrep03 was float, now double to accommodate using data's
       values)
(variable wtrep20 was float, now double to accommodate using data's
       values)
(variable wtrep35 was float, now double to accommodate using data's
       values)
(5,569 real changes made)
(variable cntrchrx was int, now long to accommodate using data's values)
(variable wtrep19 was float, now double to accommodate using data's
       values)
(variable medsupcq was int, now float to accommodate using data's values)
(7,015 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 1998

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_1998_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_1998_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_1998_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 1998

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             1
        from master                         0  (_merge==1)
        from using                          1  (_merge==2)

    Matched                            49,150  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(1 observation deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(33 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_1998_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1998_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 1998

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_1998_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_1998_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_1998_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_1998_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (1998) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_1998_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_1998_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (1998) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_1998_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.742       3.078       0.262       3.370
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.00055     0.46213     0.44550     0.70341     0.49368
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20162     0.37006     0.66679
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.416       2.721       0.367       2.732
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.50680     0.32570     0.33243     0.49523     0.42992
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15105     0.27798     0.50338
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 1998

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_1998_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_1998_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_1998_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_1998_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_1998_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1998_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_1998_quarterly.dta"

. erase "$deriv/gini_1998_income_quarterly.dta"

. erase "$deriv/gini_1998_annual.dta"

. 
. display _n "Saved: gini_1998_all.dta"

Saved: gini_1998_all.dta

. 
. 
end of do-file

Processing 2000...

. ****************************************************
. * 02_gini_2000.do
. * Build 2000 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw00/intrvw00"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw00/intrvw
> 00

. 
. use mtbi001x.dta, clear

. foreach f in mtbi002 mtbi003 mtbi004 mtbi011 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2000.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       911,332
        from master                   911,117  (_merge==1)
        from using                        215  (_merge==2)

    Matched                         2,507,936  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(911,332 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(287,234 real changes made, 287,234 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2000_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2000_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw00/intrvw
> 00

. preserve

. * Load first FMLI file and assign quarter
. use fmli001x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli002 fmli003 fmli004 fmli011 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable wtrep06 was float, now double to accommodate using data's
       values)
(variable wtrep08 was float, now double to accommodate using data's
       values)
(variable wtrep16 was float, now double to accommodate using data's
       values)
(variable wtrep21 was float, now double to accommodate using data's
       values)
(variable wtrep42 was float, now double to accommodate using data's
       values)
(variable wtrep44 was float, now double to accommodate using data's
       values)
(variable compensx was int, now long to accommodate using data's values)
(variable cntrchrx was int, now long to accommodate using data's values)
(variable fssix was int, now long to accommodate using data's values)
(variable rfueloip was byte, now int to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(variable ecartknp was int, now long to accommodate using data's values)
(7,809 real changes made)
(variable wtrep10 was float, now double to accommodate using data's
       values)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable wtrep29 was float, now double to accommodate using data's
       values)
(variable wtrep41 was float, now double to accommodate using data's
       values)
(variable cartkucq was int, now long to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable enomotrp was int, now long to accommodate using data's values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(variable etotacx4 was float, now double to accommodate using data's
       values)
(7,624 real changes made)
(variable alimox was int, now long to accommodate using data's values)
(variable furntrpq was int, now long to accommodate using data's values)
(variable rwaterpp was byte, now int to accommodate using data's values)
(variable eothvehp was int, now long to accommodate using data's values)
(7,717 real changes made)
(variable misc1cq was float, now double to accommodate using data's
       values)
(variable misccq was float, now double to accommodate using data's
       values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable miscx4cq was float, now double to accommodate using data's
       values)
(variable emiscelc was float, now double to accommodate using data's
       values)
(variable etotalc was float, now double to accommodate using data's
       values)
(7,712 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. capture rename fincbtax fincbtax

. capture rename fsalaryx fsalaryx

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 2000

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_2000_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2000_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2000_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2000

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             3
        from master                         0  (_merge==1)
        from using                          3  (_merge==2)

    Matched                            64,586  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(3 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(42 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2000_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2000_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2000

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2000_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2000_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2000_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2000_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2000) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2000_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2000_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2000) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2000_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.604       3.195       0.275       3.365
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.04806     0.47269     0.46134     0.75383     0.50097
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20697     0.37668     0.67701
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.612       2.797       0.367       2.806
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.58787     0.34338     0.34919     0.53068     0.44022
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15823     0.29063     0.54038
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2000

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2000_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2000_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2000_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2000_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2000_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2000_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2000_quarterly.dta"

. erase "$deriv/gini_2000_income_quarterly.dta"

. erase "$deriv/gini_2000_annual.dta"

. 
. display _n "Saved: gini_2000_all.dta"

Saved: gini_2000_all.dta

. 
end of do-file

Processing 2001...

. ****************************************************
. * 02_gini_2001.do
. * Build 2001 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw01/intrvw01"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw01/intrvw
> 01

. 
. use mtbi011x.dta, clear

. foreach f in mtbi012 mtbi013 mtbi014 mtbi021 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2001.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       854,573
        from master                   854,362  (_merge==1)
        from using                        211  (_merge==2)

    Matched                         2,554,552  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(854,573 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(284,024 real changes made, 284,024 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2001_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2001_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw01/intrvw
> 01

. preserve

. * Load first FMLI file and assign quarter
. use fmli011x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli012 fmli013 fmli014 fmli021 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable wtrep03 was float, now double to accommodate using data's
       values)
(variable wtrep04 was float, now double to accommodate using data's
       values)
(variable wtrep11 was float, now double to accommodate using data's
       values)
(variable wtrep14 was float, now double to accommodate using data's
       values)
(variable wtrep15 was float, now double to accommodate using data's
       values)
(variable wtrep17 was float, now double to accommodate using data's
       values)
(variable wtrep19 was float, now double to accommodate using data's
       values)
(variable wtrep22 was float, now double to accommodate using data's
       values)
(variable wtrep24 was float, now double to accommodate using data's
       values)
(variable wtrep27 was float, now double to accommodate using data's
       values)
(variable wtrep31 was float, now double to accommodate using data's
       values)
(variable wtrep33 was float, now double to accommodate using data's
       values)
(variable wtrep35 was float, now double to accommodate using data's
       values)
(variable wtrep36 was float, now double to accommodate using data's
       values)
(variable wtrep40 was float, now double to accommodate using data's
       values)
(variable fssix was int, now long to accommodate using data's values)
(variable fpripenx was int, now long to accommodate using data's values)
(variable perscacq was int, now float to accommodate using data's values)
(variable perscapq was int, now float to accommodate using data's values)
(variable educapq was int, now long to accommodate using data's values)
(variable mrtprnoc was int, now float to accommodate using data's values)
(variable vothrflc was byte, now int to accommodate using data's values)
(variable rfueloip was byte, now int to accommodate using data's values)
(variable emrtpnvc was int, now float to accommodate using data's values)
(variable emiscmtc was int, now float to accommodate using data's values)
(variable houscq was float, now double to accommodate using data's
       values)
(variable ehousngc was float, now double to accommodate using data's
       values)
(7,579 real changes made)
(variable wtrep02 was float, now double to accommodate using data's
       values)
(variable wtrep09 was float, now double to accommodate using data's
       values)
(variable wtrep10 was float, now double to accommodate using data's
       values)
(variable wtrep20 was float, now double to accommodate using data's
       values)
(variable wtrep21 was float, now double to accommodate using data's
       values)
(variable wtrep23 was float, now double to accommodate using data's
       values)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable wtrep32 was float, now double to accommodate using data's
       values)
(variable wtrep38 was float, now double to accommodate using data's
       values)
(variable hlfbathq was byte, now int to accommodate using data's values)
(variable inclsabx was int, now long to accommodate using data's values)
(variable othentpq was float, now double to accommodate using data's
       values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable otheqppq was float, now double to accommodate using data's
       values)
(variable entertpq was float, now double to accommodate using data's
       values)
(variable eothentp was float, now double to accommodate using data's
       values)
(variable eentrmtp was float, now double to accommodate using data's
       values)
(7,398 real changes made)
(variable salincbx was int, now long to accommodate using data's values)
(variable furntrcq was int, now long to accommodate using data's values)
(variable lifinscq was int, now long to accommodate using data's values)
(variable elctrcpq was int, now float to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable ecartknc was int, now long to accommodate using data's values)
(variable houseqcq was float, now double to accommodate using data's
       values)
(7,624 real changes made)
(7,691 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 2001

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_2001_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2001_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2001_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2001

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         0  (_merge==1)
        from using                          2  (_merge==2)

    Matched                            63,130  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(2 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(76 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2001_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2001_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2001

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2001_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2001_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2001_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2001_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2001) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2001_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2001_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2001) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2001_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     12.029       3.228       0.268       3.432
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.20772     0.48709     0.47779     0.96095     0.50531
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.21189     0.38559     0.70721
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.908       2.831       0.358       2.847
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.60286     0.35195     0.36099     0.65648     0.44388
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.16179     0.29668     0.54663
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2001

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2001_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2001_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2001_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2001_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2001_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2001_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2001_quarterly.dta"

. erase "$deriv/gini_2001_income_quarterly.dta"

. erase "$deriv/gini_2001_annual.dta"

. 
. display _n "Saved: gini_2001_all.dta"

Saved: gini_2001_all.dta

. 
end of do-file

Processing 2002...

. ****************************************************
. * 02_gini_2002.do
. * Build 2002 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw02/intrvw02"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw02/intrvw
> 02

. 
. use mtbi021x.dta, clear

. foreach f in mtbi022 mtbi023 mtbi024 mtbi031 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2002.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       878,637
        from master                   878,429  (_merge==1)
        from using                        208  (_merge==2)

    Matched                         2,673,644  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(878,637 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(293,262 real changes made, 293,262 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2002_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2002_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw02/intrvw
> 02

. preserve

. * Load first FMLI file and assign quarter
. use fmli021x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli022 fmli023 fmli024 fmli031 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable compbndx was int, now long to accommodate using data's values)
(variable compowdx was int, now long to accommodate using data's values)
(variable fpripenx was int, now long to accommodate using data's values)
(variable wdbsgdsx was int, now long to accommodate using data's values)
(variable wtrep02 was float, now double to accommodate using data's
       values)
(variable wtrep10 was float, now double to accommodate using data's
       values)
(variable wtrep20 was float, now double to accommodate using data's
       values)
(variable wtrep23 was float, now double to accommodate using data's
       values)
(variable wtrep26 was float, now double to accommodate using data's
       values)
(variable wtrep28 was float, now double to accommodate using data's
       values)
(variable wtrep32 was float, now double to accommodate using data's
       values)
(variable wtrep37 was float, now double to accommodate using data's
       values)
(variable wtrep38 was float, now double to accommodate using data's
       values)
(variable wtrep39 was float, now double to accommodate using data's
       values)
(variable wtrep43 was float, now double to accommodate using data's
       values)
(variable medsupcq was int, now float to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable tothentc was byte, now int to accommodate using data's values)
(variable utilrntc was byte, now int to accommodate using data's values)
(variable relectrc was byte, now int to accommodate using data's values)
(variable rnatlgap was byte, now int to accommodate using data's values)
(variable rnatlgac was byte, now int to accommodate using data's values)
(variable rwaterpp was byte, now int to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable unemplbx was int, now long to accommodate using data's values)
(7,778 real changes made)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable lifinscq was int, now long to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(variable compnsbx was int, now long to accommodate using data's values)
(variable inclsabx was int, now long to accommodate using data's values)
(7,833 real changes made)
(variable totexppq was float, now double to accommodate using data's
       values)
(variable furntrcq was int, now long to accommodate using data's values)
(variable totex4pq was float, now double to accommodate using data's
       values)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable otrincbx was int, now long to accommodate using data's values)
(8,024 real changes made)
(variable unemplx was int, now long to accommodate using data's values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable entertcq was float, now double to accommodate using data's
       values)
(variable otheqpcq was float, now double to accommodate using data's
       values)
(variable othentcq was float, now double to accommodate using data's
       values)
(variable miscpq was float, now double to accommodate using data's
       values)
(variable misc1pq was float, now double to accommodate using data's
       values)
(variable cashcopq was float, now double to accommodate using data's
       values)
(variable cashcocq was float, now double to accommodate using data's
       values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(variable miscx4pq was float, now double to accommodate using data's
       values)
(variable rothrflc was byte, now int to accommodate using data's values)
(variable rwaterpc was byte, now int to accommodate using data's values)
(variable etotalp was float, now double to accommodate using data's
       values)
(variable etotalc was float, now double to accommodate using data's
       values)
(variable etotapx4 was float, now double to accommodate using data's
       values)
(variable etotacx4 was float, now double to accommodate using data's
       values)
(variable emiscelp was float, now double to accommodate using data's
       values)
(8,086 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 2002

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_2002_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2002_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2002_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2002

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         0  (_merge==1)
        from using                          2  (_merge==2)

    Matched                            65,781  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(2 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(62 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2002_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2002_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2002

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2002_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2002_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2002_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2002_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2002) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2002_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2002_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2002) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2002_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     12.715       3.268       0.257       3.453
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.21721     0.48755     0.46471     0.77913     0.50375
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20999     0.38587     0.70883
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      8.017       2.839       0.354       2.840
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.69083     0.35293     0.35249     0.54950     0.44276
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.16055     0.29737     0.58013
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2002

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2002_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2002_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2002_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2002_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2002_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2002_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2002_quarterly.dta"

. erase "$deriv/gini_2002_income_quarterly.dta"

. erase "$deriv/gini_2002_annual.dta"

. 
. display _n "Saved: gini_2002_all.dta"

Saved: gini_2002_all.dta

. 
end of do-file

Processing 2003...

. ****************************************************
. * 02_gini_2003.do
. * Build 2003 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw03/intrvw03"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw03/intrvw
> 03

. 
. use mtbi031x.dta, clear

. foreach f in mtbi032 mtbi033 mtbi034 mtbi041 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2003.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       876,689
        from master                   876,479  (_merge==1)
        from using                        210  (_merge==2)

    Matched                         2,559,299  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(876,689 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(293,044 real changes made, 293,044 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2003_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2003_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw03/intrvw
> 03

. preserve

. * Load first FMLI file and assign quarter
. use fmli031x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli032 fmli033 fmli034 fmli041 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable compbndx was int, now long to accommodate using data's values)
(variable setlinsx was int, now long to accommodate using data's values)
(variable cartkucq was int, now long to accommodate using data's values)
(variable predrgpq was int, now float to accommodate using data's values)
(variable predrgcq was int, now float to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(variable rnatlgap was byte, now int to accommodate using data's values)
(variable rnatlgac was byte, now int to accommodate using data's values)
(variable ecartkup was int, now long to accommodate using data's values)
(8,196 real changes made)
(variable finlwt21 was float, now double to accommodate using data's
       values)
(variable othrincx was int, now long to accommodate using data's values)
(variable educapq was int, now long to accommodate using data's values)
(variable educacq was int, now long to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable salincbx was int, now long to accommodate using data's values)
(8,072 real changes made)
(variable fpripenx was int, now long to accommodate using data's values)
(variable fssix was int, now long to accommodate using data's values)
(variable rfueloic was byte, now int to accommodate using data's values)
(variable ecartkuc was int, now long to accommodate using data's values)
(8,044 real changes made)
(variable wtrep06 was float, now double to accommodate using data's
       values)
(variable wtrep08 was float, now double to accommodate using data's
       values)
(variable houspq was float, now double to accommodate using data's
       values)
(variable entertpq was float, now double to accommodate using data's
       values)
(variable otheqppq was float, now double to accommodate using data's
       values)
(variable othentpq was float, now double to accommodate using data's
       values)
(variable ehousngp was float, now double to accommodate using data's
       values)
(variable eentrmtp was float, now double to accommodate using data's
       values)
(variable eothentp was float, now double to accommodate using data's
       values)
(variable inclsabx was int, now long to accommodate using data's values)
(7,976 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtax fsalaryx quarter

. gen year = 2003

. 
. * Drop missing income values
. drop if missing(fincbtax) & missing(fsalaryx)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtax fsalaryx FINLWT21

. save "$deriv/income_2003_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2003_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2003_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2003

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            10
        from master                         0  (_merge==1)
        from using                         10  (_merge==2)

    Matched                            67,309  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(10 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(47 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2003_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2003_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2003

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2003_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2003_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2003_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2003_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2003) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2003_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2003_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtax (drop missing)
.         preserve
  6.         drop if missing(fincbtax) | fincbtax <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtax [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalaryx (drop missing)
.         preserve
 16.         drop if missing(fsalaryx) | fsalaryx <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalaryx [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2003) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2003_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     12.778       3.267       0.256       3.469
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.43523     0.50389     0.48988     0.86519     0.51226
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.21791     0.39582     0.74163
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.893       2.803       0.355       2.800
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.74392     0.35867     0.36893     0.61061     0.44753
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.16500     0.30139     0.59805
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2003

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2003_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2003_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2003_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2003_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2003_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2003_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2003_quarterly.dta"

. erase "$deriv/gini_2003_income_quarterly.dta"

. erase "$deriv/gini_2003_annual.dta"

. 
. display _n "Saved: gini_2003_all.dta"

Saved: gini_2003_all.dta

. 
end of do-file

Processing 2004...

. ****************************************************
. * 02_gini_2004.do
. * Build 2004 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw04/intrvw04"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw04/intrvw
> 04

. 
. use mtbi041x.dta, clear

. foreach f in mtbi042 mtbi043 mtbi044 mtbi051 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2004.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       847,738
        from master                   847,539  (_merge==1)
        from using                        199  (_merge==2)

    Matched                         2,450,047  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(847,738 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(280,276 real changes made, 280,276 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2004_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2004_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw04/intrvw
> 04

. preserve

. * Load first FMLI file and assign quarter
. use fmli041x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli042 fmli043 fmli044 fmli051 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable wtrep09 was float, now double to accommodate using data's
       values)
(variable wtrep10 was float, now double to accommodate using data's
       values)
(variable wtrep16 was float, now double to accommodate using data's
       values)
(variable wtrep23 was float, now double to accommodate using data's
       values)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable wtrep38 was float, now double to accommodate using data's
       values)
(variable wtrep41 was float, now double to accommodate using data's
       values)
(variable wtrep42 was float, now double to accommodate using data's
       values)
(variable wtrep43 was float, now double to accommodate using data's
       values)
(variable wtrep44 was float, now double to accommodate using data's
       values)
(variable transpq was float, now double to accommodate using data's
       values)
(variable educapq was int, now float to accommodate using data's values)
(variable educacq was int, now float to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable rfueloip was byte, now int to accommodate using data's values)
(variable rfueloic was byte, now int to accommodate using data's values)
(variable lmpsumbx was int, now long to accommodate using data's values)
(variable compens1 was int, now long to accommodate using data's values)
(variable compens2 was int, now long to accommodate using data's values)
(variable compens3 was int, now long to accommodate using data's values)
(variable compens4 was int, now long to accommodate using data's values)
(variable compens5 was int, now long to accommodate using data's values)
(7,779 real changes made)
(variable compbndx was int, now long to accommodate using data's values)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable cashcocq was float, now double to accommodate using data's
       values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(variable etotalc was float, now double to accommodate using data's
       values)
(variable etotacx4 was float, now double to accommodate using data's
       values)
(variable enomotrp was int, now long to accommodate using data's values)
(7,643 real changes made)
(variable wtrep02 was float, now double to accommodate using data's
       values)
(variable wtrep20 was float, now double to accommodate using data's
       values)
(variable wtrep28 was float, now double to accommodate using data's
       values)
(variable wtrep32 was float, now double to accommodate using data's
       values)
(variable wtrep37 was float, now double to accommodate using data's
       values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(7,687 real changes made)
(variable trntrppq was int, now long to accommodate using data's values)
(variable ttranprp was int, now long to accommodate using data's values)
(variable ttrntrip was int, now long to accommodate using data's values)
(variable tfarep was int, now long to accommodate using data's values)
(variable chdlmpb was str1, now str2 to accommodate using data's values)
(variable chdlmpbx was byte, now int to accommodate using data's values)
(variable aliothbx was int, now long to accommodate using data's values)
(7,759 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2004

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2004_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2004_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2004_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2004

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             9
        from master                         0  (_merge==1)
        from using                          9  (_merge==2)

    Matched                            64,601  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(9 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(88 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2004_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2004_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2004

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2004_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2004_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2004_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2004_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2004_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2004) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2004_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2004_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2004_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2004) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2004_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     12.176       3.229       0.265       3.444
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.31743     0.49191     0.48215     0.85130     0.50771
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.21406     0.38855     0.72489
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.638       2.783       0.364       2.799
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.66701     0.35014     0.36344     0.60951     0.44348
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.16207     0.29541     0.57156
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2004

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2004_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2004_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2004_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2004_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2004_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2004_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2004_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2004_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2004_quarterly.dta"

. erase "$deriv/gini_2004_income_quarterly.dta"

. erase "$deriv/gini_2004_annual.dta"

. 
. display _n "Saved: gini_2004_all.dta"

Saved: gini_2004_all.dta

. 
end of do-file

Processing 2005...

. ****************************************************
. * 02_gini_2005.do
. * Build 2005 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw05/intrvw05"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw05/intrvw
> 05

. 
. use mtbi051x.dta, clear

. foreach f in mtbi052 mtbi053 mtbi054 mtbi061 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2005.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       785,941
        from master                   785,732  (_merge==1)
        from using                        209  (_merge==2)

    Matched                         2,214,377  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(785,941 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(266,210 real changes made, 266,210 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2005_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2005_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw05/intrvw
> 05

. preserve

. * Load first FMLI file and assign quarter
. use fmli051x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli052 fmli053 fmli054 fmli061 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable setlinsx was int, now long to accommodate using data's values)
(variable wdbsastx was int, now long to accommodate using data's values)
(variable totexppq was float, now double to accommodate using data's
       values)
(variable lifinspq was int, now long to accommodate using data's values)
(variable hhid was byte, now int to accommodate using data's values)
(variable totex4pq was float, now double to accommodate using data's
       values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable vfueloip was byte, now int to accommodate using data's values)
(variable vfueloic was byte, now int to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(variable rnatlgac was byte, now int to accommodate using data's values)
(variable ecartkup was int, now long to accommodate using data's values)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable inclsabx was int, now long to accommodate using data's values)
(variable chdlmpb was str1, now str2 to accommodate using data's values)
(variable chdlmpbx was byte, now int to accommodate using data's values)
(variable compens1 was int, now long to accommodate using data's values)
(variable compens3 was int, now long to accommodate using data's values)
(variable compens4 was int, now long to accommodate using data's values)
(variable compens5 was int, now long to accommodate using data's values)
(variable colplanx was int, now long to accommodate using data's values)
(7,717 real changes made)
(variable flrcvrpq was int, now long to accommodate using data's values)
(variable entertpq was float, now double to accommodate using data's
       values)
(variable entertcq was float, now double to accommodate using data's
       values)
(variable otheqpcq was float, now double to accommodate using data's
       values)
(variable othentcq was float, now double to accommodate using data's
       values)
(variable educapq was float, now double to accommodate using data's
       values)
(variable educacq was float, now double to accommodate using data's
       values)
(variable cashcopq was float, now double to accommodate using data's
       values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable rothrflc was byte, now int to accommodate using data's values)
(variable etotalp was float, now double to accommodate using data's
       values)
(variable etotapx4 was float, now double to accommodate using data's
       values)
(variable eentrmtp was float, now double to accommodate using data's
       values)
(variable aliothbx was int, now long to accommodate using data's values)
(variable fjssded1 was int, now long to accommodate using data's values)
(variable fjssded2 was int, now long to accommodate using data's values)
(variable fjssded3 was int, now long to accommodate using data's values)
(variable fjssded4 was int, now long to accommodate using data's values)
(variable fjssded5 was int, now long to accommodate using data's values)
(7,456 real changes made)
(variable cashcocq was float, now double to accommodate using data's
       values)
(variable otrincbx was int, now long to accommodate using data's values)
(7,585 real changes made)
(variable houspq was float, now double to accommodate using data's
       values)
(variable sheltpq was float, now double to accommodate using data's
       values)
(variable owndwepq was float, now double to accommodate using data's
       values)
(variable mrpinspq was float, now double to accommodate using data's
       values)
(variable ehousngp was float, now double to accommodate using data's
       values)
(variable esheltrp was float, now double to accommodate using data's
       values)
(variable eowndwlp was float, now double to accommodate using data's
       values)
(variable enomotrc was int, now long to accommodate using data's values)
(7,786 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2005

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2005_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2005_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2005_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2005

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             7
        from master                         0  (_merge==1)
        from using                          7  (_merge==2)

    Matched                            60,905  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(7 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(81 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2005_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2005_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2005

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2005_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2005_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2005_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2005_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2005_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2005) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2005_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2005_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2005_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2005) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2005_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     12.061       3.203       0.266       3.389
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.21941     0.48462     0.46641     0.77411     0.50198
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20943     0.38407     0.70920
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.525       2.770       0.368       2.763
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.59076     0.34140     0.35153     0.54985     0.43863
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15801     0.28923     0.54160
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2005

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2005_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2005_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2005_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2005_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2005_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2005_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2005_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2005_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2005_quarterly.dta"

. erase "$deriv/gini_2005_income_quarterly.dta"

. erase "$deriv/gini_2005_annual.dta"

. 
. display _n "Saved: gini_2005_all.dta"

Saved: gini_2005_all.dta

. 
end of do-file

Processing 2006...

. ****************************************************
. * 02_gini_2006.do
. * Build 2006 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw06/intrvw06"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw06/intrvw
> 06

. 
. use mtbi061x.dta, clear

. foreach f in mtbi062 mtbi063 mtbi064 mtbi071 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2006.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       793,378
        from master                   793,149  (_merge==1)
        from using                        229  (_merge==2)

    Matched                         2,175,454  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(793,378 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(265,180 real changes made, 265,180 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2006_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2006_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw06/intrvw
> 06

. preserve

. * Load first FMLI file and assign quarter
. use fmli061x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli062 fmli063 fmli064 fmli071 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable inclossa was int, now long to accommodate using data's values)
(variable wtrep09 was float, now double to accommodate using data's
       values)
(variable wtrep15 was float, now double to accommodate using data's
       values)
(variable wtrep19 was float, now double to accommodate using data's
       values)
(variable wtrep24 was float, now double to accommodate using data's
       values)
(variable transpq was float, now double to accommodate using data's
       values)
(variable cartkupq was int, now long to accommodate using data's values)
(variable entertcq was float, now double to accommodate using data's
       values)
(variable otheqpcq was float, now double to accommodate using data's
       values)
(variable othentcq was float, now double to accommodate using data's
       values)
(variable educapq was int, now long to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(variable etranptp was float, now double to accommodate using data's
       values)
(variable ecartknc was int, now long to accommodate using data's values)
(variable ecartkup was int, now long to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable compnsbx was int, now long to accommodate using data's values)
(variable fssix1 was int, now long to accommodate using data's values)
(variable fssix3 was int, now long to accommodate using data's values)
(variable fssix4 was int, now long to accommodate using data's values)
(variable fssix5 was int, now long to accommodate using data's values)
(7,009 real changes made)
(variable welfarex was int, now long to accommodate using data's values)
(variable furntrpq was int, now long to accommodate using data's values)
(variable furntrcq was int, now long to accommodate using data's values)
(variable trntrppq was int, now long to accommodate using data's values)
(variable ttranprp was int, now long to accommodate using data's values)
(variable ttrntrip was int, now long to accommodate using data's values)
(variable tfarep was int, now long to accommodate using data's values)
(variable inclsabx was int, now long to accommodate using data's values)
(variable inclsbbx was int, now long to accommodate using data's values)
(variable welfare1 was int, now long to accommodate using data's values)
(variable welfare2 was int, now long to accommodate using data's values)
(variable welfare3 was int, now long to accommodate using data's values)
(variable welfare4 was int, now long to accommodate using data's values)
(variable welfare5 was int, now long to accommodate using data's values)
(6,988 real changes made)
(variable houscq was float, now double to accommodate using data's
       values)
(variable housopcq was float, now double to accommodate using data's
       values)
(variable domsrvcq was float, now double to accommodate using data's
       values)
(variable dmsxcccq was float, now double to accommodate using data's
       values)
(variable houseqpq was float, now double to accommodate using data's
       values)
(variable misceqpq was float, now double to accommodate using data's
       values)
(variable transcq was float, now double to accommodate using data's
       values)
(variable ehousngc was float, now double to accommodate using data's
       values)
(7,084 real changes made)
(variable rendwepq was float, now double to accommodate using data's
       values)
(variable rntxrppq was float, now double to accommodate using data's
       values)
(variable educacq was int, now long to accommodate using data's values)
(variable compensm was float, now double to accommodate using data's
       values)
(6,965 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2006

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2006_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2006_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2006_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2006

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            12
        from master                         0  (_merge==1)
        from using                         12  (_merge==2)

    Matched                            59,813  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(12 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(109 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2006_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2006_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2006

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2006_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2006_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2006_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2006_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2006_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2006) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2006_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2006_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2006_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2006) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2006_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.982       3.112       0.260       3.370
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.30579     0.48167     0.46048     0.78065     0.49756
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20699     0.38225     0.72311
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.304       2.728       0.374       2.713
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.60049     0.33538     0.34858     0.57375     0.43467
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15578     0.28493     0.54566
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2006

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2006_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2006_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2006_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2006_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2006_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2006_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2006_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2006_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2006_quarterly.dta"

. erase "$deriv/gini_2006_income_quarterly.dta"

. erase "$deriv/gini_2006_annual.dta"

. 
. display _n "Saved: gini_2006_all.dta"

Saved: gini_2006_all.dta

. 
end of do-file

Processing 2007...

. ****************************************************
. * 02_gini_2007.do
. * Build 2007 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw07/intrvw07"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw07/intrvw
> 07

. 
. use mtbi071x.dta, clear

. foreach f in mtbi072 mtbi073 mtbi074 mtbi081 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2007.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       738,607
        from master                   738,390  (_merge==1)
        from using                        217  (_merge==2)

    Matched                         2,044,448  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(738,607 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(255,605 real changes made, 255,605 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2007_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2007_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw07/intrvw
> 07

. preserve

. * Load first FMLI file and assign quarter
. use fmli071x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli072 fmli073 fmli074 fmli081 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable wtrep26 was float, now double to accommodate using data's
       values)
(variable wtrep41 was float, now double to accommodate using data's
       values)
(variable ntlgaspq was int, now float to accommodate using data's values)
(variable ntlgascq was int, now float to accommodate using data's values)
(variable elctrcpq was int, now float to accommodate using data's values)
(variable elctrccq was int, now float to accommodate using data's values)
(variable allfulpq was int, now float to accommodate using data's values)
(variable allfulcq was int, now float to accommodate using data's values)
(variable fuloilpq was int, now float to accommodate using data's values)
(variable othflspq was int, now float to accommodate using data's values)
(variable othflscq was int, now float to accommodate using data's values)
(variable watrpspq was int, now float to accommodate using data's values)
(variable watrpscq was int, now float to accommodate using data's values)
(variable trntrppq was int, now long to accommodate using data's values)
(variable entertcq was float, now double to accommodate using data's
       values)
(variable otheqpcq was float, now double to accommodate using data's
       values)
(variable othentcq was float, now double to accommodate using data's
       values)
(variable ttranprp was int, now long to accommodate using data's values)
(variable ttrntrip was int, now long to accommodate using data's values)
(variable tfarep was int, now long to accommodate using data's values)
(variable utilownp was int, now float to accommodate using data's values)
(variable utilownc was int, now float to accommodate using data's values)
(variable vothrflp was int, now float to accommodate using data's values)
(variable vnatlgap was int, now float to accommodate using data's values)
(variable vnatlgac was int, now float to accommodate using data's values)
(variable vwaterpp was int, now float to accommodate using data's values)
(variable vwaterpc was int, now float to accommodate using data's values)
(variable eentrmtc was float, now double to accommodate using data's
       values)
(variable eothentc was float, now double to accommodate using data's
       values)
(variable emotrvhc was int, now long to accommodate using data's values)
(variable emiscmtc was int, now float to accommodate using data's values)
(variable inclsabx was int, now long to accommodate using data's values)
(variable fssix3 was int, now long to accommodate using data's values)
(6,829 real changes made)
(variable unemplx was int, now long to accommodate using data's values)
(variable houscq was float, now double to accommodate using data's
       values)
(variable fuloilcq was int, now float to accommodate using data's values)
(variable houseqcq was float, now double to accommodate using data's
       values)
(variable apparpq was float, now double to accommodate using data's
       values)
(variable othaplpq was float, now double to accommodate using data's
       values)
(variable othvehpq was int, now long to accommodate using data's values)
(variable vfueloip was int, now float to accommodate using data's values)
(variable vfueloic was int, now float to accommodate using data's values)
(variable vothrflc was int, now float to accommodate using data's values)
(variable velectrc was int, now float to accommodate using data's values)
(variable utilrntp was int, now float to accommodate using data's values)
(variable utilrntc was int, now float to accommodate using data's values)
(variable rnatlgap was int, now float to accommodate using data's values)
(variable rnatlgac was int, now float to accommodate using data's values)
(variable rwaterpp was int, now float to accommodate using data's values)
(variable rwaterpc was int, now float to accommodate using data's values)
(variable ehousngc was float, now double to accommodate using data's
       values)
(variable eothvehp was int, now long to accommodate using data's values)
(variable unemplbx was int, now long to accommodate using data's values)
(variable lmpsumbx was int, now long to accommodate using data's values)
(variable unemplx1 was int, now long to accommodate using data's values)
(variable unemplx2 was int, now long to accommodate using data's values)
(variable unemplx3 was int, now long to accommodate using data's values)
(variable unemplx4 was int, now long to accommodate using data's values)
(variable unemplx5 was int, now long to accommodate using data's values)
(6,711 real changes made)
(variable bbydaypq was int, now long to accommodate using data's values)
(variable lifinscq was int, now long to accommodate using data's values)
(variable velectrp was int, now float to accommodate using data's values)
(variable rfueloic was int, now float to accommodate using data's values)
(variable rothrflc was byte, now float to accommodate using data's
       values)
(variable fssix1 was int, now long to accommodate using data's values)
(variable fssix4 was int, now long to accommodate using data's values)
(6,830 real changes made)
(variable tairfarp was int, now long to accommodate using data's values)
(6,914 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2007

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2007_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2007_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2007_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2007

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            25
        from master                         0  (_merge==1)
        from using                         25  (_merge==2)

    Matched                            57,077  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(25 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(106 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2007_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2007_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2007

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2007_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2007_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2007_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2007_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2007_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2007) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2007_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2007_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2007_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2007) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2007_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.762       3.095       0.263       3.304
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.35745     0.46737     0.44986     0.77245     0.49253
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20226     0.37335     0.73081
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.074       2.704       0.382       2.721
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.57537     0.32557     0.33879     0.56767     0.42893
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15158     0.27789     0.53504
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2007

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2007_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2007_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2007_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2007_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2007_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2007_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2007_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2007_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2007_quarterly.dta"

. erase "$deriv/gini_2007_income_quarterly.dta"

. erase "$deriv/gini_2007_annual.dta"

. 
. display _n "Saved: gini_2007_all.dta"

Saved: gini_2007_all.dta

. 
end of do-file

Processing 2008...

. ****************************************************
. * 02_gini_2008.do
. * Build 2008 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw08/intrvw08"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw08/intrvw
> 08

. 
. use mtbi081x.dta, clear

. foreach f in mtbi082 mtbi083 mtbi084 mtbi091 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2008.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       752,489
        from master                   752,264  (_merge==1)
        from using                        225  (_merge==2)

    Matched                         2,048,735  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(752,489 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(257,626 real changes made, 257,626 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2008_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2008_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw08/intrvw
> 08

. preserve

. * Load first FMLI file and assign quarter
. use fmli081x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli082 fmli083 fmli084 fmli091 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable fsltaxx was int, now long to accommodate using data's values)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable wtrep26 was float, now double to accommodate using data's
       values)
(variable allfulcq was int, now float to accommodate using data's values)
(variable fuloilcq was int, now float to accommodate using data's values)
(variable othflscq was int, now float to accommodate using data's values)
(variable vfueloic was int, now float to accommodate using data's values)
(variable velectrc was int, now float to accommodate using data's values)
(variable vnatlgap was int, now float to accommodate using data's values)
(variable utilrntp was int, now float to accommodate using data's values)
(variable utilrntc was int, now float to accommodate using data's values)
(variable rnatlgap was int, now float to accommodate using data's values)
(variable rwaterpp was byte, now float to accommodate using data's
       values)
(variable rwaterpc was int, now float to accommodate using data's values)
(variable ecartkup was int, now long to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(variable fsltaxx1 was int, now long to accommodate using data's values)
(variable fsltaxx2 was int, now long to accommodate using data's values)
(variable fsltaxx3 was int, now long to accommodate using data's values)
(variable fsltaxx4 was int, now long to accommodate using data's values)
(variable fsltaxx5 was int, now long to accommodate using data's values)
(variable fssix5 was int, now long to accommodate using data's values)
(6,942 real changes made)
(variable wdbsgdsx was int, now long to accommodate using data's values)
(variable educacq was int, now long to accommodate using data's values)
(variable relectrc was int, now float to accommodate using data's values)
(variable ecartknc was int, now long to accommodate using data's values)
(variable otrincbx was int, now long to accommodate using data's values)
(variable famtfedm was float, now double to accommodate using data's
       values)
(6,794 real changes made)
(variable fssix was int, now long to accommodate using data's values)
(variable furntrpq was int, now long to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(variable fssix1 was int, now long to accommodate using data's values)
(variable fssix2 was int, now long to accommodate using data's values)
(variable fssix3 was int, now long to accommodate using data's values)
(variable fssix4 was int, now long to accommodate using data's values)
(6,895 real changes made)
(variable vnatlgac was int, now float to accommodate using data's values)
(6,940 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2008

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2008_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2008_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2008_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2008

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            27
        from master                         0  (_merge==1)
        from using                         27  (_merge==2)

    Matched                            57,533  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(27 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(97 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2008_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2008_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2008

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2008_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2008_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2008_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2008_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2008_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2008) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2008_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2008_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2008_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2008) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2008_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.251       2.984       0.265       3.273
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.20243     0.44504     0.42001     0.67446     0.47951
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.19194     0.35920     0.70630
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.812       2.584       0.379       2.678
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.58770     0.30843     0.31436     0.48997     0.41642
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14285     0.26540     0.54031
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2008

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2008_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2008_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2008_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2008_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2008_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2008_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2008_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2008_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2008_quarterly.dta"

. erase "$deriv/gini_2008_income_quarterly.dta"

. erase "$deriv/gini_2008_annual.dta"

. 
. display _n "Saved: gini_2008_all.dta"

Saved: gini_2008_all.dta

. 
end of do-file

Processing 2009...

. ****************************************************
. * 02_gini_2009.do
. * Build 2009 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw09/intrvw09"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw09/intrvw
> 09

. 
. use mtbi091x.dta, clear

. foreach f in mtbi092 mtbi093 mtbi094 mtbi101 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2009.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       800,392
        from master                   800,175  (_merge==1)
        from using                        217  (_merge==2)

    Matched                         2,072,678  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(800,392 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(270,224 real changes made, 270,224 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2009_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2009_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw09/intrvw
> 09

. preserve

. * Load first FMLI file and assign quarter
. use fmli091x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli092 fmli093 fmli094 fmli101 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable wtrep11 was float, now double to accommodate using data's
       values)
(variable wtrep25 was float, now double to accommodate using data's
       values)
(variable entertcq was float, now double to accommodate using data's
       values)
(variable otheqpcq was float, now double to accommodate using data's
       values)
(variable othentcq was float, now double to accommodate using data's
       values)
(variable lifinscq was int, now long to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable tothentc was byte, now int to accommodate using data's values)
(variable vothrflp was int, now float to accommodate using data's values)
(variable rothrflp was byte, now float to accommodate using data's
       values)
(variable rothrflc was byte, now float to accommodate using data's
       values)
(variable rwaterpp was int, now float to accommodate using data's values)
(variable ehousngc was float, now double to accommodate using data's
       values)
(variable ecartknp was int, now long to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(variable lmpsumbx was int, now long to accommodate using data's values)
(variable colplanx was int, now long to accommodate using data's values)
(6,991 real changes made)
(variable setlinsx was int, now long to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable rwaterpc was byte, now int to accommodate using data's values)
(variable aliothbx was int, now long to accommodate using data's values)
(variable fjssded1 was int, now long to accommodate using data's values)
(variable fjssded2 was int, now long to accommodate using data's values)
(variable fjssded3 was int, now long to accommodate using data's values)
(variable fjssded4 was int, now long to accommodate using data's values)
(variable fjssded5 was int, now long to accommodate using data's values)
(6,994 real changes made)
(variable bbydaypq was int, now long to accommodate using data's values)
(variable hhid was byte, now int to accommodate using data's values)
(variable velectrp was int, now float to accommodate using data's values)
(variable rnatlgac was byte, now int to accommodate using data's values)
(variable ehousngp was float, now double to accommodate using data's
       values)
(7,104 real changes made)
(variable fjssdedx was int, now long to accommodate using data's values)
(variable menboypq was int, now long to accommodate using data's values)
(variable mensixpq was int, now long to accommodate using data's values)
(variable vothrflc was int, now float to accommodate using data's values)
(variable rnatlgac was int, now float to accommodate using data's values)
(variable rwaterpc was int, now float to accommodate using data's values)
(7,198 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2009

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2009_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2009_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2009_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2009

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            13
        from master                         0  (_merge==1)
        from using                         13  (_merge==2)

    Matched                            58,628  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(13 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(113 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2009_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2009_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2009

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2009_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2009_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2009_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2009_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2009_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2009) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2009_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2009_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2009_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2009) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2009_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     10.927       2.973       0.272       3.243
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.18525     0.44594     0.42612     0.70991     0.48063
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.19318     0.35977     0.70331
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.659       2.570       0.386       2.618
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.61530     0.30660     0.31345     0.48911     0.41476
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14214     0.26405     0.55169
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2009

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2009_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2009_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2009_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2009_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2009_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2009_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2009_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2009_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2009_quarterly.dta"

. erase "$deriv/gini_2009_income_quarterly.dta"

. erase "$deriv/gini_2009_annual.dta"

. 
. display _n "Saved: gini_2009_all.dta"

Saved: gini_2009_all.dta

. 
end of do-file

Processing 2010...

. ****************************************************
. * 02_gini_2010.do
. * Build 2010 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw10/intrvw10"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw10/intrvw
> 10

. 
. use mtbi101x.dta, clear

. foreach f in mtbi102 mtbi103 mtbi104 mtbi111 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2010.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       794,690
        from master                   794,475  (_merge==1)
        from using                        215  (_merge==2)

    Matched                         2,025,823  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(794,690 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(268,787 real changes made, 268,787 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2010_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2010_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw10/intrvw
> 10

. preserve

. * Load first FMLI file and assign quarter
. use fmli101x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli102 fmli103 fmli104 fmli111 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable wtrep02 was float, now double to accommodate using data's
       values)
(variable wtrep26 was float, now double to accommodate using data's
       values)
(variable houspq was float, now double to accommodate using data's
       values)
(variable houseqpq was float, now double to accommodate using data's
       values)
(variable furntrpq was int, now long to accommodate using data's values)
(variable cartkucq was int, now long to accommodate using data's values)
(variable ttotalp was int, now long to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable ehousngp was float, now double to accommodate using data's
       values)
(variable evehpurc was int, now long to accommodate using data's values)
(variable ecartknc was int, now long to accommodate using data's values)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable chdlmpb was str1, now str2 to accommodate using data's values)
(variable chdlmpbx was byte, now int to accommodate using data's values)
(variable othrincb was str1, now str2 to accommodate using data's values)
(variable otrincbx was byte, now int to accommodate using data's values)
(7,135 real changes made)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable fjssded1 was int, now long to accommodate using data's values)
(variable fjssded2 was int, now long to accommodate using data's values)
(variable fjssded3 was int, now long to accommodate using data's values)
(variable fjssded4 was int, now long to accommodate using data's values)
(variable fjssded5 was int, now long to accommodate using data's values)
(variable typepyx was byte, now int to accommodate using data's values)
(7,059 real changes made)
(variable entertpq was float, now double to accommodate using data's
       values)
(variable otheqppq was float, now double to accommodate using data's
       values)
(variable othentpq was float, now double to accommodate using data's
       values)
(variable cashcocq was int, now long to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(variable eentrmtp was float, now double to accommodate using data's
       values)
(variable eothentp was float, now double to accommodate using data's
       values)
(variable enomotrp was int, now long to accommodate using data's values)
(7,037 real changes made)
(variable totexpcq was float, now double to accommodate using data's
       values)
(variable totex4cq was float, now double to accommodate using data's
       values)
(variable etotalc was float, now double to accommodate using data's
       values)
(variable etotacx4 was float, now double to accommodate using data's
       values)
(variable inclsbbx was int, now long to accommodate using data's values)
(6,869 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2010

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2010_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2010_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2010_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2010

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            13
        from master                         0  (_merge==1)
        from using                         13  (_merge==2)

    Matched                            58,804  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(13 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(101 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2010_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2010_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2010

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2010_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2010_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2010_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2010_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2010_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2010) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2010_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2010_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2010_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2010) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2010_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     10.761       2.935       0.273       3.244
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.22906     0.44221     0.42392     0.68996     0.48003
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.19225     0.35739     0.71082
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.589       2.546       0.386       2.612
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.75651     0.30523     0.31211     0.47969     0.41391
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14156     0.26305     0.60207
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2010

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2010_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2010_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2010_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2010_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2010_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2010_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2010_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2010_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2010_quarterly.dta"

. erase "$deriv/gini_2010_income_quarterly.dta"

. erase "$deriv/gini_2010_annual.dta"

. 
. display _n "Saved: gini_2010_all.dta"

Saved: gini_2010_all.dta

. 
end of do-file

Processing 2011...

. ****************************************************
. * 02_gini_2011.do
. * Build 2011 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw11/intrvw11"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw11/intrvw
> 11

. 
. use mtbi111x.dta, clear

. foreach f in mtbi112 mtbi113 mtbi114 mtbi121 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2011.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       804,013
        from master                   803,802  (_merge==1)
        from using                        211  (_merge==2)

    Matched                         1,942,827  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(804,013 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(258,363 real changes made, 258,363 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2011_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2011_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw11/intrvw
> 11

. preserve

. * Load first FMLI file and assign quarter
. use fmli111x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli112 fmli113 fmli114 fmli121 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable insrfndx was int, now long to accommodate using data's values)
(variable setlinsx was int, now long to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable unemplbx was int, now long to accommodate using data's values)
(variable saleincb was str1, now str2 to accommodate using data's values)
(variable salincbx was byte, now int to accommodate using data's values)
(variable colplanx was int, now long to accommodate using data's values)
(6,729 real changes made)
(variable ecartkup was int, now long to accommodate using data's values)
(variable enomotrp was int, now long to accommodate using data's values)
(variable welfrebx was int, now long to accommodate using data's values)
(variable chdothbx was int, now long to accommodate using data's values)
(variable welfare1 was int, now long to accommodate using data's values)
(variable welfare2 was int, now long to accommodate using data's values)
(variable welfare3 was int, now long to accommodate using data's values)
(variable welfare4 was int, now long to accommodate using data's values)
(variable welfare5 was int, now long to accommodate using data's values)
(6,611 real changes made)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable fjssded2 was int, now long to accommodate using data's values)
(variable fjssded5 was int, now long to accommodate using data's values)
(6,781 real changes made)
(variable fjssdedx was int, now long to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(variable rothrflc was byte, now int to accommodate using data's values)
(variable otrincbx was int, now long to accommodate using data's values)
(6,838 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2011

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2011_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2011_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2011_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2011

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            16
        from master                         0  (_merge==1)
        from using                         16  (_merge==2)

    Matched                            56,328  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(16 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(78 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2011_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2011_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2011

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2011_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2011_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2011_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2011_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2011_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2011) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2011_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2011_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2011_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2011) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2011_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     10.732       2.867       0.267       3.233
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.06810     0.44133     0.42388     0.70383     0.47850
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.19188     0.35682     0.68114
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.468       2.492       0.385       2.599
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.51642     0.30109     0.30970     0.48199     0.41127
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14022     0.25999     0.50808
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2011

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2011_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2011_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2011_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2011_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2011_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2011_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2011_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2011_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2011_quarterly.dta"

. erase "$deriv/gini_2011_income_quarterly.dta"

. erase "$deriv/gini_2011_annual.dta"

. 
. display _n "Saved: gini_2011_all.dta"

Saved: gini_2011_all.dta

. 
end of do-file

Processing 2012...

. ****************************************************
. * 02_gini_2012.do
. * Build 2012 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw12/intrvw12"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw12/intrvw
> 12

. 
. use mtbi121x.dta, clear

. foreach f in mtbi122 mtbi123 mtbi124 mtbi131 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2012.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       805,404
        from master                   805,190  (_merge==1)
        from using                        214  (_merge==2)

    Matched                         1,940,300  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(805,404 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(257,523 real changes made, 257,523 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2012_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2012_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw12/intrvw
> 12

. preserve

. * Load first FMLI file and assign quarter
. use fmli121x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli122 fmli123 fmli124 fmli131 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable compbndx was int, now long to accommodate using data's values)
(variable furntrpq was int, now long to accommodate using data's values)
(variable educapq was int, now long to accommodate using data's values)
(variable educacq was int, now long to accommodate using data's values)
(variable mrtprnop was int, now long to accommodate using data's values)
(variable mrtprnoc was int, now long to accommodate using data's values)
(variable rwaterpc was byte, now int to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(6,715 real changes made)
(variable ecartkup was int, now long to accommodate using data's values)
(variable chdlmpb was str1, now str2 to accommodate using data's values)
(variable chdlmpbx was byte, now int to accommodate using data's values)
(variable aliothbx was int, now long to accommodate using data's values)
(variable colplanx was int, now long to accommodate using data's values)
(6,689 real changes made)
(variable enomotrc was int, now long to accommodate using data's values)
(variable unemplbx was int, now long to accommodate using data's values)
(variable inclsabx was int, now long to accommodate using data's values)
(6,751 real changes made)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable mrtprnop was long, now double to accommodate using data's
       values)
(variable mrtprnoc was long, now double to accommodate using data's
       values)
(variable emrtpnvp was int, now double to accommodate using data's
       values)
(variable emrtpnvc was int, now double to accommodate using data's
       values)
(6,769 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2012

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2012_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2012_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2012_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2012

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            16
        from master                         0  (_merge==1)
        from using                         16  (_merge==2)

    Matched                            56,085  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(16 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(81 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2012_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2012_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2012

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2012_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2012_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2012_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2012_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2012_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2012) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2012_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2012_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2012_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2012) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2012_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.469       3.038       0.265       3.361
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.33300     0.46243     0.44198     0.72335     0.48976
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.19992     0.37025     0.72722
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.806       2.593       0.381       2.668
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.79384     0.31577     0.32261     0.49541     0.42098
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14613     0.27077     0.61355
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2012

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2012_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2012_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2012_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2012_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2012_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2012_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2012_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2012_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2012_quarterly.dta"

. erase "$deriv/gini_2012_income_quarterly.dta"

. erase "$deriv/gini_2012_annual.dta"

. 
. display _n "Saved: gini_2012_all.dta"

Saved: gini_2012_all.dta

. 
end of do-file

Processing 2013...

. ****************************************************
. * 02_gini_2013.do
. * Build 2013 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw13/intrvw13"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw13/intrvw
> 13

. 
. use mtbi131x.dta, clear

. foreach f in mtbi132 mtbi133 mtbi134 mtbi141 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2013.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       714,492
        from master                   714,279  (_merge==1)
        from using                        213  (_merge==2)

    Matched                         1,728,054  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(714,492 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(232,213 real changes made, 232,213 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2013_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2013_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw13/intrvw
> 13

. preserve

. * Load first FMLI file and assign quarter
. use fmli131x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli132 fmli133 fmli134 fmli141 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable furntrpq was int, now long to accommodate using data's values)
(variable flrcvrpq was int, now double to accommodate using data's
       values)
(variable flrcvrcq was int, now double to accommodate using data's
       values)
(variable lifinspq was int, now long to accommodate using data's values)
(variable fjssded1 was int, now long to accommodate using data's values)
(variable fjssded2 was int, now long to accommodate using data's values)
(variable fjssded3 was int, now long to accommodate using data's values)
(variable fjssded4 was int, now long to accommodate using data's values)
(variable fjssded5 was int, now long to accommodate using data's values)
(6,762 real changes made)
(variable ttotalp was int, now long to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(6,500 real changes made)
(variable rfueloic was byte, now int to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable othlyrbx was int, now long to accommodate using data's values)
(6,077 real changes made)
(variable hhid was byte, now int to accommodate using data's values)
(variable rfueloip was byte, now int to accommodate using data's values)
(6,483 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2013

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2013_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2013_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2013_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2013

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            12
        from master                         0  (_merge==1)
        from using                         12  (_merge==2)

    Matched                            54,415  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(12 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(94 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2013_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2013_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2013

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2013_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2013_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2013_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2013_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2013_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2013) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2013_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2013_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2013_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2013) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2013_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.532       3.080       0.267       3.407
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.17231     0.46695     0.44814     0.73890     0.49367
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20242     0.37309     0.70101
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.841       2.631       0.385       2.670
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.50829     0.31284     0.32306     0.49926     0.42211
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14602     0.26863     0.50411
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2013

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2013_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2013_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2013_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2013_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2013_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2013_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2013_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2013_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2013_quarterly.dta"

. erase "$deriv/gini_2013_income_quarterly.dta"

. erase "$deriv/gini_2013_annual.dta"

. 
. display _n "Saved: gini_2013_all.dta"

Saved: gini_2013_all.dta

. 
end of do-file

Processing 2014...

. ****************************************************
. * 02_gini_2014.do
. * Build 2014 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw14/intrvw14"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw14/intrvw
> 14

. 
. use mtbi141x.dta, clear

. foreach f in mtbi142 mtbi143 mtbi144 mtbi151 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2014.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       695,886
        from master                   695,623  (_merge==1)
        from using                        263  (_merge==2)

    Matched                         1,683,796  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(695,886 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(234,720 real changes made, 234,720 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2014_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2014_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw14/intrvw
> 14

. preserve

. * Load first FMLI file and assign quarter
. use fmli141x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli142 fmli143 fmli144 fmli151 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable fjssdedx was int, now long to accommodate using data's values)
(variable frrdedx was byte, now int to accommodate using data's values)
(variable fssix was int, now long to accommodate using data's values)
(variable cartkucq was int, now long to accommodate using data's values)
(variable trntrppq was int, now long to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(variable ttranprp was int, now long to accommodate using data's values)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable ttrntrip was int, now long to accommodate using data's values)
(variable tfarep was int, now long to accommodate using data's values)
(variable vfueloip was byte, now int to accommodate using data's values)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(variable frrdedm was byte, now int to accommodate using data's values)
(variable fssix1 was int, now long to accommodate using data's values)
(variable othlonbx was int, now long to accommodate using data's values)
(6,489 real changes made)
(variable educacq was int, now long to accommodate using data's values)
(variable rothrflc was byte, now int to accommodate using data's values)
(variable ecartkup was int, now long to accommodate using data's values)
(variable othrinc1 was int, now long to accommodate using data's values)
(variable othrinc2 was int, now long to accommodate using data's values)
(variable othrinc3 was int, now long to accommodate using data's values)
(variable othrinc4 was int, now long to accommodate using data's values)
(variable othrinc5 was int, now long to accommodate using data's values)
(6,466 real changes made)
(6,470 real changes made)
(variable medsrvpq was int, now long to accommodate using data's values)
(variable cashcocq was int, now long to accommodate using data's values)
(6,413 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2014

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2014_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2014_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2014_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2014

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            10
        from master                         0  (_merge==1)
        from using                         10  (_merge==2)

    Matched                            53,769  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(10 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(119 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2014_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2014_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2014

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2014_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2014_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2014_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2014_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2014_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2014) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2014_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2014_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2014_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2014) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2014_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.920       3.117       0.261       3.355
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.33040     0.47370     0.44991     0.71082     0.49537
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.20396     0.37731     0.72684
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.873       2.662       0.387       2.624
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.52129     0.31403     0.32185     0.47708     0.42197
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14609     0.26950     0.51042
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2014

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2014_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2014_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2014_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2014_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2014_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2014_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2014_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2014_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2014_quarterly.dta"

. erase "$deriv/gini_2014_income_quarterly.dta"

. erase "$deriv/gini_2014_annual.dta"

. 
. display _n "Saved: gini_2014_all.dta"

Saved: gini_2014_all.dta

. 
end of do-file

Processing 2015...

. ****************************************************
. * 02_gini_2015.do
. * Build 2015 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw15/intrvw15"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw15/intrvw
> 15

. 
. use mtbi151x.dta, clear

. foreach f in mtbi152 mtbi153 mtbi154 mtbi161 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2015.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       664,099
        from master                   663,888  (_merge==1)
        from using                        211  (_merge==2)

    Matched                         1,562,973  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(664,099 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)
(32,693 missing values generated)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(117,846 real changes made, 117,846 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2015_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2015_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw15/intrvw
> 15

. preserve

. * Load first FMLI file and assign quarter
. use fmli151x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli152 fmli153 fmli154 fmli161 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable misctaxx was int, now long to accommodate using data's values)
(variable lifinscq was int, now long to accommodate using data's values)
(variable mrtprnop was long, now double to accommodate using data's
       values)
(variable mrtprnoc was int, now double to accommodate using data's
       values)
(variable emrtpnvp was int, now double to accommodate using data's
       values)
(variable emrtpnvc was int, now double to accommodate using data's
       values)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable enomotrp was int, now long to accommodate using data's values)
(variable emotrvhp was int, now long to accommodate using data's values)
(variable emotrvhc was int, now long to accommodate using data's values)
(variable fjssded1 was int, now long to accommodate using data's values)
(variable fjssded2 was int, now long to accommodate using data's values)
(variable fjssded3 was int, now long to accommodate using data's values)
(variable fjssded4 was int, now long to accommodate using data's values)
(variable fjssded5 was int, now long to accommodate using data's values)
(variable creditbx was int, now long to accommodate using data's values)
(variable credyrbx was int, now long to accommodate using data's values)
(variable fstaxowe was int, now long to accommodate using data's values)
(6,518 real changes made)
(variable furntrpq was int, now long to accommodate using data's values)
(variable trntrppq was int, now long to accommodate using data's values)
(variable medsrvpq was int, now long to accommodate using data's values)
(variable ttotalp was int, now long to accommodate using data's values)
(variable ttotalc was int, now long to accommodate using data's values)
(variable ttranprp was int, now long to accommodate using data's values)
(variable ttrntrip was int, now long to accommodate using data's values)
(variable tfarep was int, now long to accommodate using data's values)
(variable enomotrc was int, now long to accommodate using data's values)
(variable fssix5 was int, now long to accommodate using data's values)
(variable othregbx was int, now long to accommodate using data's values)
(6,481 real changes made)
(variable educapq was int, now long to accommodate using data's values)
(variable lifinspq was int, now long to accommodate using data's values)
(6,372 real changes made)
(variable fssix was int, now long to accommodate using data's values)
(variable tothvhrc was byte, now int to accommodate using data's values)
(variable rothrflc was byte, now int to accommodate using data's values)
(6,426 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2015

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2015_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2015_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2015_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2015

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            34
        from master                         0  (_merge==1)
        from using                         34  (_merge==2)

    Matched                            51,139  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(34 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(19 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2015_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2015_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2015

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2015_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2015_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2015_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2015_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2015_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2015) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2015_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2015_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2015_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2015) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2015_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.457       2.738       0.367       2.750
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.86722     0.34384     0.35059     0.54315     0.43836
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15808     0.29096     0.63429
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.107       2.676       0.376       2.681
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.84306     0.32841     0.33454     0.50982     0.42911
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15148     0.27993     0.62772
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2015

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2015_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2015_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2015_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2015_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2015_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2015_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2015_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2015_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2015_quarterly.dta"

. erase "$deriv/gini_2015_income_quarterly.dta"

. erase "$deriv/gini_2015_annual.dta"

. 
. display _n "Saved: gini_2015_all.dta"

Saved: gini_2015_all.dta

. 
end of do-file

Processing 2016...

. ****************************************************
. * 02_gini_2016.do
. * Build 2016 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw16/intrvw16"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw16/intrvw
> 16

. 
. use mtbi161x.dta, clear

. foreach f in mtbi162 mtbi163 mtbi164 mtbi171 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2016.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       708,846
        from master                   708,633  (_merge==1)
        from using                        213  (_merge==2)

    Matched                         1,688,050  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(708,846 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)
(33,988 missing values generated)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(128,542 real changes made, 128,542 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2016_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2016_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw16/intrvw
> 16

. preserve

. * Load first FMLI file and assign quarter
. use fmli161x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli162 fmli163 fmli164 fmli171 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(variable cashcocq was int, now long to accommodate using data's values)
(variable rothrflp was byte, now int to accommodate using data's values)
(6,342 real changes made)
(variable tothvhrp was byte, now int to accommodate using data's values)
(variable ecartkuc was int, now long to accommodate using data's values)
(variable fmlpyyrx was int, now long to accommodate using data's values)
(variable othlyrbx was int, now long to accommodate using data's values)
(6,372 real changes made)
(variable trntrppq was int, now long to accommodate using data's values)
(variable ttranprp was int, now long to accommodate using data's values)
(variable ttrntrip was int, now long to accommodate using data's values)
(variable tfarep was int, now long to accommodate using data's values)
(variable othlonbx was int, now long to accommodate using data's values)
(6,301 real changes made)
(variable emotrvhc was int, now long to accommodate using data's values)
(6,208 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2016

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2016_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2016_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2016_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2016

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            29
        from master                         0  (_merge==1)
        from using                         29  (_merge==2)

    Matched                            52,575  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(29 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(13 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2016_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2016_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2016

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2016_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2016_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2016_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2016_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2016_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2016) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2016_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2016_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2016_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2016) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2016_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.206       2.706       0.375       2.732
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.84213     0.34393     0.35820     0.81732     0.43578
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15814     0.29102     0.62746
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.960       2.648       0.380       2.657
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.82788     0.32953     0.34313     0.76486     0.42683
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15195     0.28074     0.62346
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2016

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2016_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2016_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2016_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2016_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2016_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2016_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2016_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2016_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2016_quarterly.dta"

. erase "$deriv/gini_2016_income_quarterly.dta"

. erase "$deriv/gini_2016_annual.dta"

. 
. display _n "Saved: gini_2016_all.dta"

Saved: gini_2016_all.dta

. 
end of do-file

Processing 2017...

. ****************************************************
. * 02_gini_2017.do
. * Build 2017 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw17/intrvw17"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw17/intrvw
> 17

. 
. use mtbi171x.dta, clear

. foreach f in mtbi172 mtbi173 mtbi174 mtbi181 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2017.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       689,972
        from master                   689,759  (_merge==1)
        from using                        213  (_merge==2)

    Matched                         1,732,276  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(689,972 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)
(31,731 missing values generated)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(114,999 real changes made, 114,999 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2017_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2017_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw17/intrvw
> 17

. preserve

. * Load first FMLI file and assign quarter
. use fmli171x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli172 fmli173 fmli174 fmli181 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(6,177 real changes made)
(6,090 real changes made)
(6,004 real changes made)
(5,916 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2017

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2017_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2017_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2017_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2017

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             9
        from master                         0  (_merge==1)
        from using                          9  (_merge==2)

    Matched                            50,590  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(9 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(10 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2017_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2017_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2017

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2017_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2017_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2017_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2017_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2017_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2017) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2017_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2017_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2017_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2017) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2017_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.268       2.693       0.370       2.734
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.67409     0.34791     0.36468     0.80353     0.43862
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.16050     0.29383     0.57414
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.992       2.624       0.375       2.690
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.62140     0.33300     0.34900     0.74722     0.42998
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15423     0.28323     0.55413
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2017

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2017_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2017_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2017_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2017_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2017_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2017_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2017_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2017_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2017_quarterly.dta"

. erase "$deriv/gini_2017_income_quarterly.dta"

. erase "$deriv/gini_2017_annual.dta"

. 
. display _n "Saved: gini_2017_all.dta"

Saved: gini_2017_all.dta

. 
end of do-file

Processing 2018...

. ****************************************************
. * 02_gini_2018.do
. * Build 2018 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw18"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw18

. 
. use mtbi181x.dta, clear

. foreach f in mtbi182 mtbi183 mtbi184 mtbi191 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2018.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       655,757
        from master                   655,540  (_merge==1)
        from using                        217  (_merge==2)

    Matched                         1,687,921  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(655,757 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)
(29,812 missing values generated)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(106,798 real changes made, 106,798 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2018_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2018_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw18

. preserve

. * Load first FMLI file and assign quarter
. use fmli181x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli182 fmli183 fmli184 fmli191 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(5,899 real changes made)
(5,773 real changes made)
(5,571 real changes made)
(5,623 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2018

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2018_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2018_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2018_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2018

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            24
        from master                         0  (_merge==1)
        from using                         24  (_merge==2)

    Matched                            47,760  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(24 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(13 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2018_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2018_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2018

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2018_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2018_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2018_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2018_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2018_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2018) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2018_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2018_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2018_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2018) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2018_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      7.124       2.677       0.376       2.661
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.64639     0.33908     0.34806     0.55973     0.43367
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15613     0.28758     0.56385
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.906       2.639       0.382       2.622
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.59975     0.32583     0.33401     0.52863     0.42583
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15044     0.27807     0.54535
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2018

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2018_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2018_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2018_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2018_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2018_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2018_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2018_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2018_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2018_quarterly.dta"

. erase "$deriv/gini_2018_income_quarterly.dta"

. erase "$deriv/gini_2018_annual.dta"

. 
. display _n "Saved: gini_2018_all.dta"

Saved: gini_2018_all.dta

. 
end of do-file

Processing 2019...

. ****************************************************
. * 02_gini_2019.do
. * Build 2019 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw19/intrvw19"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw19/intrvw
> 19

. 
. use mtbi191x.dta, clear

. foreach f in mtbi192 mtbi193 mtbi194 mtbi201 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2019.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       621,450
        from master                   621,235  (_merge==1)
        from using                        215  (_merge==2)

    Matched                         1,592,354  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(621,450 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)
(27,580 missing values generated)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(100,979 real changes made, 100,979 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2019_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2019_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw19/intrvw
> 19

. preserve

. * Load first FMLI file and assign quarter
. use fmli191x.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli192 fmli193 fmli194 fmli201 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(5,493 real changes made)
(5,337 real changes made)
(5,248 real changes made)
(5,202 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2019

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2019_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2019_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2019_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2019

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                            14
        from master                         0  (_merge==1)
        from using                         14  (_merge==2)

    Matched                            44,467  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(14 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(7 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2019_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2019_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2019

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2019_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2019_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2019_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2019_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2019_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2019) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2019_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2019_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2019_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2019) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2019_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.847       2.687       0.392       2.615
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.54570     0.32359     0.33545     0.54708     0.42695
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15048     0.27645     0.52185
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.649       2.635       0.396       2.589
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.50988     0.31190     0.32358     0.52321     0.41991
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14552     0.26795     0.50489
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2019

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2019_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2019_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2019_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2019_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2019_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2019_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2019_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2019_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2019_quarterly.dta"

. erase "$deriv/gini_2019_income_quarterly.dta"

. erase "$deriv/gini_2019_annual.dta"

. 
. display _n "Saved: gini_2019_all.dta"

Saved: gini_2019_all.dta

. 
end of do-file

Processing 2020...

. ****************************************************
. * 02_gini_2020.do
. * Build 2020 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw20"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw20

. 
. use mtbi202.dta, clear

. foreach f in mtbi203 mtbi204 mtbi211 {
  2.     append using `f'.dta
  3. }

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename ucc UCC

. capture rename cost COST

. capture rename ref_mo REF_MO

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2020.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       465,906
        from master                   465,692  (_merge==1)
        from using                        214  (_merge==2)

    Matched                         1,113,483  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(465,906 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)
(19,232 missing values generated)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(68,970 real changes made, 68,970 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2020_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2020_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw20

. preserve

. * Load first FMLI file and assign quarter
. use fmli202.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli203 fmli204 fmli211 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(4,980 real changes made)
(5,205 real changes made)
(5,115 real changes made)

. 
. * Standardize variable names (1996-2020 use lowercase)
. capture rename newid NEWID

. capture rename finlwt21 FINLWT21

. 
. * Extract income variables (2004-2020 use fincbtxm and fsalarym)
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2020

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2020_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2020_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2020_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2020

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         0  (_merge==1)
        from using                          2  (_merge==2)

    Matched                            33,756  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(2 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(6 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2020_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2020_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2020

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2020_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2020_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2020_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2020_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2020_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2020) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2020_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2020_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2020_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2020) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2020_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.299       2.625       0.417       2.507
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.51952     0.30888     0.33862     0.61779     0.42235
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14801     0.26573     0.50957
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.143       2.562       0.417       2.469
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.44993     0.29533     0.32326     0.57596     0.41406
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.14202     0.25571     0.47365
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2020

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2020_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2020_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2020_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2020_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2020_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2020_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2020_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2020_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2020_quarterly.dta"

. erase "$deriv/gini_2020_income_quarterly.dta"

. erase "$deriv/gini_2020_annual.dta"

. 
. display _n "Saved: gini_2020_all.dta"

Saved: gini_2020_all.dta

. 
end of do-file

Processing 2021...

. ****************************************************
. * 02_gini_2021.do
. * Build 2021 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw21"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw21

. 
. use mtbi212.dta, clear

. foreach f in mtbi213 mtbi214 mtbi221 {
  2.     append using `f'.dta
  3. }

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2021.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       550,611
        from master                   550,329  (_merge==1)
        from using                        282  (_merge==2)

    Matched                         1,111,816  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(550,611 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(160,155 real changes made, 160,155 to missing)

. 
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2021_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2021_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw21

. preserve

. * Load first FMLI file and assign quarter
. use fmli212.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli213 fmli214 fmli221 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(5,121 real changes made)
(4,902 real changes made)
(5,187 real changes made)

. 
. * Handle variable name casing (2021-2023 use uppercase FINCBTXM/FSALARYM,
>  standardize to lowercase)
. capture rename FINCBTXM fincbtxm

. capture rename FSALARYM fsalarym

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2021

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2021_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2021_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2021_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2021

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             5
        from master                         0  (_merge==1)
        from using                          5  (_merge==2)

    Matched                            33,965  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(5 observations deleted)

. drop _merge

. 
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(45 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2021_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2021_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2021

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2021_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2021_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2021_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2021_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2021_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2021) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2021_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2021_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2021_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2021) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2021_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.081       3.135       0.283       3.248
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.06670     0.48380     0.50050     0.97700     0.50801
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.21575     0.38356     0.68086
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.573       2.646       0.403       2.509
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.50851     0.32386     0.35917     0.65694     0.43093
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15524     0.27665     0.50422
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2021

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2021_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2021_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2021_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2021_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2021_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2021_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2021_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2021_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2021_quarterly.dta"

. erase "$deriv/gini_2021_income_quarterly.dta"

. erase "$deriv/gini_2021_annual.dta"

. 
. display _n "Saved: gini_2021_all.dta"

Saved: gini_2021_all.dta

. 
end of do-file

Processing 2022...

. ****************************************************
. * 02_gini_2022.do
. * Build 2022 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw22"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. * Ensure ineqdeco is installed
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata for 2022
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw22

. 
. use mtbi222.dta, clear

. foreach f in mtbi223 mtbi224 mtbi231 {
  2.     append using `f'.dta
  3. }

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2022.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       504,603
        from master                   504,358  (_merge==1)
        from using                        245  (_merge==2)

    Matched                         1,051,806  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(504,603 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. * Exclusions from core: mortgage/rent/health/education
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. * Broad: all food + expenditure
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. 
. * Core: broad minus excluded categories
. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(153,474 real changes made, 153,474 to missing)

. 
. * Create quarter from REF_MO
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2022_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2022_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw22

. preserve

. * Load first FMLI file and assign quarter
. use fmli222.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli223 fmli224 fmli231 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(4,580 real changes made)
(4,617 real changes made)
(4,807 real changes made)

. 
. * Handle variable name casing (2021-2023 use uppercase FINCBTXM/FSALARYM,
>  standardize to lowercase)
. capture rename FINCBTXM fincbtxm

. capture rename FSALARYM fsalarym

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2022

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2022_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2022_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2022_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2022

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             4
        from master                         0  (_merge==1)
        from using                          4  (_merge==2)

    Matched                            31,705  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(4 observations deleted)

. drop _merge

. 
. * Drop zero/negative consumption
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(61 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2022_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2022_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2022

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2022_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2022_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. use "$deriv/cons_2022_cuq.dta", clear

. 
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2022_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2022_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2022_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2022) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2022_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2022_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2022_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2022) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2022_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.287       3.098       0.274       3.295
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.10947     0.47574     0.48868     1.11411     0.50251
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.21123     0.37857     0.68934
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.556       2.644       0.403       2.558
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.54207     0.31962     0.35512     0.74984     0.42832
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15309     0.27357     0.52019
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2022

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2022_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2022_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2022_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual into one file
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2022_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2022_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2022_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2022_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2022_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2022_quarterly.dta"

. erase "$deriv/gini_2022_income_quarterly.dta"

. erase "$deriv/gini_2022_annual.dta"

. 
. display _n "Saved:"

Saved:

. display "  $deriv/mtbi_2022_tagged.dta (item-level)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_
> 2022_tagged.dta (item-level)

. display "  $deriv/cons_2022_cuq.dta (CU-quarter)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_
> 2022_cuq.dta (CU-quarter)

. display "  $deriv/cons_2022_cuy.dta (CU-year)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_
> 2022_cuy.dta (CU-year)

. display "  $deriv/gini_2022_all.dta (quarterly + annual Ginis)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_
> 2022_all.dta (quarterly + annual Ginis)

. 
. 
end of do-file

Processing 2023...

. ****************************************************
. * 02_gini_2023.do
. * Build 2023 consumption (core/broad) and Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global intr  "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /intrvw23"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. * Ensure ineqdeco is installed
. capture which ineqdeco

. if _rc ssc install ineqdeco

. 
. ****************************************************
. * 1. Load MTBI expenditure microdata for 2023
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw23

. 
. use mtbi232.dta, clear

. foreach f in mtbi233 mtbi234 mtbi241 {
  2.     append using `f'.dta
  3. }

. 
. keep NEWID UCC COST REF_MO

. destring UCC, replace
UCC: all characters numeric; replaced as long

. 
. ****************************************************
. * 2. Merge with UCC map
. ****************************************************
. merge m:1 UCC using "$deriv/ucc_map_2023.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       492,423
        from master                   492,215  (_merge==1)
        from using                        208  (_merge==2)

    Matched                         1,016,933  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(492,423 observations deleted)

. drop _merge

. 
. ****************************************************
. * 3. Classify core vs broad consumption
. ****************************************************
. gen uppername = upper(name)

. 
. * Exclusions from core: mortgage/rent/health/education
. gen excl_core = ///
>     (strpos(uppername,"MORTGAGE")>0)  | ///
>     (strpos(uppername,"RENT")>0)      | ///
>     (strpos(uppername,"HEALTH")>0)    | ///
>     (strpos(uppername,"MEDICAL")>0)   | ///
>     (strpos(uppername,"EDUC")>0)

. 
. * Broad: all food + expenditure
. gen cons_broad_item = COST if inlist(section,"FOOD","EXPEND")

. 
. * Core: broad minus excluded categories
. gen cons_core_item = cons_broad_item

. replace cons_core_item = . if excl_core
(153,650 real changes made, 153,650 to missing)

. 
. * Create quarter from REF_MO
. destring REF_MO, replace ignore(" ")
REF_MO: all characters numeric; replaced as byte

. gen quarter = ceil(REF_MO/3)

. 
. ****************************************************
. * 4. Save item-level tagged file
. ****************************************************
. save "$deriv/mtbi_2023_tagged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_2023_tagg
    > ed.dta saved

. 
. ****************************************************
. * 5. Build weights file and extract income data
. ****************************************************
. cd "$intr"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/intrvw23

. preserve

. * Load first FMLI file and assign quarter
. use fmli232.dta, clear

. gen quarter = 1

. 
. * Load remaining FMLI files and assign quarters sequentially
. local q = 2

. foreach f in fmli233 fmli234 fmli241 {
  2.     append using `f'.dta
  3.     replace quarter = `q' if quarter == .
  4.     local q = `q' + 1
  5. }
(4,770 real changes made)
(4,662 real changes made)
(4,688 real changes made)

. 
. * Handle variable name casing (2021-2023 use uppercase FINCBTXM/FSALARYM,
>  standardize to lowercase)
. capture rename FINCBTXM fincbtxm

. capture rename FSALARYM fsalarym

. 
. * Extract income variables
. keep NEWID FINLWT21 fincbtxm fsalarym quarter

. gen year = 2023

. 
. * Drop missing income values
. drop if missing(fincbtxm) & missing(fsalarym)
(0 observations deleted)

. 
. * Save income data at CU-quarter level
. order NEWID year quarter fincbtxm fsalarym FINLWT21

. save "$deriv/income_2023_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/income_2023_cu
    > q.dta saved

. 
. * Also create weights-only file for consumption merge
. keep NEWID FINLWT21

. duplicates drop NEWID, force

Duplicates in terms of NEWID

(0 observations are duplicates)

. tempfile weights

. save `weights'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. restore

. 
. ****************************************************
. * 6. Collapse to CU-quarter level + merge weights
. ****************************************************
. use "$deriv/mtbi_2023_tagged.dta", clear

. collapse (sum) cons_core_q=cons_core_item cons_broad_q=cons_broad_item, b
> y(NEWID quarter)

. gen year = 2023

. 
. merge m:1 NEWID using `weights'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             1
        from master                         0  (_merge==1)
        from using                          1  (_merge==2)

    Matched                            31,420  (_merge==3)
    -----------------------------------------

. keep if _merge==3
(1 observation deleted)

. drop _merge

. 
. * Drop zero/negative consumption
. drop if cons_core_q <= 0 | cons_broad_q <= 0
(29 observations deleted)

. 
. order NEWID year quarter cons_core_q cons_broad_q FINLWT21

. save "$deriv/cons_2023_cuq.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2023_cuq.
    > dta saved

. 
. ****************************************************
. * 7. Collapse to CU-year level
. ****************************************************
. collapse (sum) cons_core_y=cons_core_q cons_broad_y=cons_broad_q (first) 
> FINLWT21, by(NEWID)

. gen year = 2023

. 
. order NEWID year cons_core_y cons_broad_y FINLWT21

. save "$deriv/cons_2023_cuy.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_2023_cuy.
    > dta saved

. 
. ****************************************************
. * 8. Compute quarterly consumption Ginis
. ****************************************************
. use "$deriv/cons_2023_cuq.dta", clear

. 
. postfile gini_post int year int quarter double gini_core double gini_broa
> d ///
>     using "$deriv/gini_2023_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2023_quar
    > terly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/cons_2023_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         ineqdeco cons_core_q [aw = FINLWT21]
  6.         scalar gc = r(gini)
  7.         ineqdeco cons_broad_q [aw = FINLWT21]
  8.         scalar gb = r(gini)
  9.     }
 10.     post gini_post (2023) (`q') (gc) (gb)
 11. }

. postclose gini_post

. 
. ****************************************************
. * 8a. Compute quarterly income Ginis
. ****************************************************
. use "$deriv/income_2023_cuq.dta", clear

. 
. postfile gini_inc_post int year int quarter double gini_fincbtax double g
> ini_fsalaryx ///
>     using "$deriv/gini_2023_income_quarterly.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2023_inco
    > me_quarterly.dta not found)

. 
. forvalues q = 1/4 {
  2.     quietly {
  3.         use "$deriv/income_2023_cuq.dta", clear
  4.         keep if quarter == `q'
  5.         * Compute Gini for fincbtxm (drop missing)
.         preserve
  6.         drop if missing(fincbtxm) | fincbtxm <= 0
  7.         if _N > 0 {
  8.             ineqdeco fincbtxm [aw = FINLWT21]
  9.             scalar g_fincbtax = r(gini)
 10.         }
 11.         else {
 12.             scalar g_fincbtax = .
 13.         }
 14.         restore
 15.         
.         * Compute Gini for fsalarym (drop missing)
.         preserve
 16.         drop if missing(fsalarym) | fsalarym <= 0
 17.         if _N > 0 {
 18.             ineqdeco fsalarym [aw = FINLWT21]
 19.             scalar g_fsalaryx = r(gini)
 20.         }
 21.         else {
 22.             scalar g_fsalaryx = .
 23.         }
 24.         restore
 25.     }
 26.     post gini_inc_post (2023) (`q') (g_fincbtax) (g_fsalaryx)
 27. }

. postclose gini_inc_post

. 
. ****************************************************
. * 9. Compute annual Gini
. ****************************************************
. use "$deriv/cons_2023_cuy.dta", clear

. 
. ineqdeco cons_core_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |     11.877       3.203       0.270       3.351
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    1.24510     0.49174     0.48930     0.85537     0.50865
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.21538     0.38844     0.71348
----------------------------------------------

. scalar gini_core_annual = r(gini)

. 
. ineqdeco cons_broad_y [aw = FINLWT21]
 
Percentile ratios

----------------------------------------------------------
  All obs |    p90/p10     p90/p50     p10/p50     p75/p25
----------+-----------------------------------------------
          |      6.747       2.702       0.401       2.544
----------------------------------------------------------
  
Generalized Entropy indices GE(a), where a = income difference
 sensitivity parameter, and Gini coefficient

----------------------------------------------------------------------
  All obs |     GE(-1)       GE(0)       GE(1)       GE(2)        Gini
----------+-----------------------------------------------------------
          |    0.59726     0.32777     0.34887     0.57985     0.43078
----------------------------------------------------------------------
   
Atkinson indices, A(e), where e > 0 is the inequality aversion parameter

----------------------------------------------
  All obs |     A(0.5)        A(1)        A(2)
----------+-----------------------------------
          |    0.15407     0.27947     0.54432
----------------------------------------------

. scalar gini_broad_annual = r(gini)

. 
. clear

. set obs 1
Number of observations (_N) was 0, now 1.

. gen year       = 2023

. gen quarter    = .
(1 missing value generated)

. gen gini_core  = gini_core_annual

. gen gini_broad = gini_broad_annual

. save "$deriv/gini_2023_annual.dta", replace
(file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2023_annu
    > al.dta not found)
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2023_annu
    > al.dta saved

. 
. ****************************************************
. * 10. Combine quarterly + annual into one file
. ****************************************************
. * Merge consumption and income quarterly Ginis
. use "$deriv/gini_2023_quarterly.dta", clear

. merge 1:1 year quarter using "$deriv/gini_2023_income_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 4  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Append annual consumption Ginis (no annual income Ginis per user reques
> t)
. append using "$deriv/gini_2023_annual.dta"
(variable year was int, now float to accommodate using data's values)
(variable quarter was int, now float to accommodate using data's values)

. 
. * Set income Ginis to missing for annual observations
. replace gini_fincbtax = . if quarter == .
(0 real changes made)

. replace gini_fsalaryx = . if quarter == .
(0 real changes made)

. 
. order year quarter gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_2023_all.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_2023_all.
    > dta saved

. 
. * Clean up intermediate files
. erase "$deriv/gini_2023_quarterly.dta"

. erase "$deriv/gini_2023_income_quarterly.dta"

. erase "$deriv/gini_2023_annual.dta"

. 
. display _n "Saved:"

Saved:

. display "  $deriv/mtbi_2023_tagged.dta (item-level)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/mtbi_
> 2023_tagged.dta (item-level)

. display "  $deriv/cons_2023_cuq.dta (CU-quarter)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_
> 2023_cuq.dta (CU-quarter)

. display "  $deriv/cons_2023_cuy.dta (CU-year)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/cons_
> 2023_cuy.dta (CU-year)

. display "  $deriv/gini_2023_all.dta (quarterly + annual Ginis)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_
> 2023_all.dta (quarterly + annual Ginis)

. 
end of do-file

. 
. * Step 3: Append all years together
. display _n "=== Appending all years ===" _n

=== Appending all years ===


. do "$code/03_append_gini_all.do"

. ****************************************************
. * 03_append_gini_all.do
. * Append all yearly Gini files into one panel
. * with quarterly date format for merging
. ****************************************************
. 
. clear all

. set more off

. 
. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. 
. ****************************************************
. * 1. Append all yearly Gini files
. ****************************************************
. cd "$deriv"
/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived

. 
. use gini_1996_all.dta, clear

. 
. forvalues y = 1997/2023 {
  2.     capture append using gini_`y'_all.dta
  3. }

. 
. ****************************************************
. * 2. Sort and create quarterly date variable
. ****************************************************
. sort year quarter

. 
. * Create Stata quarterly date (for quarterly obs only)
. gen qdate = yq(year, quarter) if quarter != .
(27 missing values generated)

. format qdate %tq

. 
. * Create string date like "1996q1" for easy reading
. gen str8 date_str = string(year) + "q" + string(quarter) if quarter != .
(27 missing values generated)

. replace date_str = string(year) + " annual" if quarter == .
variable date_str was str8 now str11
(27 real changes made)

. 
. ****************************************************
. * 3. Order and save final panel
. ****************************************************
. order year quarter qdate date_str gini_core gini_broad gini_fincbtax gini
> _fsalaryx

. sort year quarter

. 
. label var year          "Year"

. label var quarter       "Quarter (. = annual)"

. label var qdate         "Stata quarterly date"

. label var date_str      "Date string"

. label var gini_core     "Gini coefficient - core consumption"

. label var gini_broad    "Gini coefficient - broad consumption"

. label var gini_fincbtax "Gini coefficient - income before taxes"

. label var gini_fsalaryx "Gini coefficient - salary income"

. 
. save "$deriv/gini_1996_2023.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_2023
    > .dta saved

. 
. * Also export quarterly-only version (for merging with monthly data)
. drop if quarter == .
(27 observations deleted)

. drop date_str

. order year quarter qdate gini_core gini_broad gini_fincbtax gini_fsalaryx

. save "$deriv/gini_1996_2023_quarterly.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_1996_2023
    > _quarterly.dta saved

. 
. display _n "Saved:"

Saved:

. display "  $deriv/gini_1996_2023.dta (quarterly + annual)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_
> 1996_2023.dta (quarterly + annual)

. display "  $deriv/gini_1996_2023_quarterly.dta (quarterly only)"
  /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_
> 1996_2023_quarterly.dta (quarterly only)

. 
. * Show summary
. list in 1/20

     +-------------------------------------------------------------+
  1. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1996 |       1 | 1996q1 | .55468213 | .49419832 | .48794494 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                           .4469206                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
  2. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1996 |       2 | 1996q2 | .56675941 | .50503184 | .48039882 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44027883                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
  3. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1996 |       3 | 1996q3 | .57520928 | .51438453 | .47925651 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                           .4351627                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
  4. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1996 |       4 | 1996q4 | .55639912 | .49887649 | .48211903 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44501452                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
  5. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1997 |       1 | 1997q1 | .54642597 | .48424696 | .47472963 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44305942                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
  6. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1997 |       2 | 1997q2 | .55785435 | .49735394 | .47345289 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44555976                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
  7. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1997 |       3 | 1997q3 | .56695318 | .50885453 | .47236631 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44213179                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
  8. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1997 |       4 | 1997q4 | .54984284 | .49451624 | .47498209 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44150127                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
  9. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1998 |       1 | 1998q1 | .55603067 | .49286135 | .47864468 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .43974221                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 10. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1998 |       2 | 1998q2 | .57069699 | .50973879 | .47534157 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .43696457                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 11. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1998 |       3 | 1998q3 | .56856592 |  .5095694 | .47891865 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44108099                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 12. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 1998 |       4 | 1998q4 | .55375674 |  .4987267 | .48489898 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44414738                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 13. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 2000 |       1 | 2000q1 | .56679806 | .50698114 | .49092228 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                           .4411787                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 14. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 2000 |       2 | 2000q2 | .56903703 | .50977404 | .48835974 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .43355742                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 15. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 2000 |       3 | 2000q3 | .57262391 | .51582328 | .48610998 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .43286336                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 16. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 2000 |       4 | 2000q4 | .56101712 | .50705849 | .49586488 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44692902                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 17. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 2001 |       1 | 2001q1 | .56722331 |  .5072244 |  .4964892 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44473754                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 18. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 2001 |       2 | 2001q2 | .57571294 | .51578006 | .47983586 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44222975                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 19. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 2001 |       3 | 2001q3 | .57161633 | .51590847 | .47696455 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .43975238                          |
     +-------------------------------------------------------------+

     +-------------------------------------------------------------+
 20. | year | quarter |  qdate | gini_core | gini_br~d | gini_fi~x |
     | 2001 |       4 | 2001q4 | .56907023 | .51333295 | .47492692 |
     |-------------------------------------------------------------|
     |                          gini_fs~x                          |
     |                          .44630957                          |
     +-------------------------------------------------------------+

. 
. 
end of do-file

. 
. * Step 4: Merge BH shocks
. display _n "=== Merging BH shocks ===" _n

=== Merging BH shocks ===


. do "$code/04_merge_bh_shocks.do"

. ****************************************************
. * 04_merge_bh_shocks.do
. * Import BH supply and demand shocks and merge with quarterly Gini
. ****************************************************
. 
. clear all

. set more off

. 
. global bh_shocks "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data
> /BH shocks"

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. global code "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code"

. 
. ****************************************************
. * 1. Import demand shocks
. ****************************************************
. import excel "$bh_shocks/BH2_demand_shocks.xlsx", firstrow clear
(7 vars, 605 obs)

. 
. * Drop header rows - drop if shock values are missing or non-numeric
. drop if missing(B) & missing(C)
(0 observations deleted)

. destring B, gen(demand_shock_agg) force
B: contains nonnumeric characters; demand_shock_agg generated as double
(1 missing value generated)

. destring C, gen(demand_shock_oil) force
C: contains nonnumeric characters; demand_shock_oil generated as double
(1 missing value generated)

. * Keep rows where at least one shock is valid
. drop if missing(demand_shock_agg) & missing(demand_shock_oil)
(1 observation deleted)

. 
. * Parse date string like "Jun-76" to year and month
. * Convert A to string if it's numeric
. capture confirm string variable A

. if _rc {
.     * A is numeric, convert to string
.     gen date_str = string(A, "%tdMon-YY")
. }

. else {
.     * A is already string
.     gen date_str = A
. }

. gen month_str = substr(date_str, 1, 3)

. gen year_str = substr(date_str, 5, 2)

. 
. * Convert month abbreviation to number
. gen month = .
(604 missing values generated)

. replace month = 1 if month_str == "Jan"
(50 real changes made)

. replace month = 2 if month_str == "Feb"
(51 real changes made)

. replace month = 3 if month_str == "Mar"
(51 real changes made)

. replace month = 4 if month_str == "Apr"
(51 real changes made)

. replace month = 5 if month_str == "May"
(51 real changes made)

. replace month = 6 if month_str == "Jun"
(50 real changes made)

. replace month = 7 if month_str == "Jul"
(50 real changes made)

. replace month = 8 if month_str == "Aug"
(50 real changes made)

. replace month = 9 if month_str == "Sep"
(50 real changes made)

. replace month = 10 if month_str == "Oct"
(50 real changes made)

. replace month = 11 if month_str == "Nov"
(50 real changes made)

. replace month = 12 if month_str == "Dec"
(50 real changes made)

. 
. * Convert 2-digit year to 4-digit (handle both 1900s and 2000s)
. destring year_str, gen(year_2digit)
year_str: all characters numeric; year_2digit generated as byte

. gen year = 1900 + year_2digit if year_2digit >= 50
(305 missing values generated)

. replace year = 2000 + year_2digit if year_2digit < 50
(305 real changes made)

. 
. * Create quarter from month
. gen quarter = ceil(month/3)

. 
. * Create quarterly date for merging
. gen qdate = yq(year, quarter)

. format qdate %tq

. 
. * Clean up temporary variables
. drop date_str month_str year_str year_2digit

. 
. * Collapse to quarterly (average monthly shocks within quarter)
. collapse (mean) demand_shock_agg demand_shock_oil, by(qdate year quarter)

. 
. * Save temporary file
. tempfile demand

. save `demand'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000001
    saved as .dta format

. 
. ****************************************************
. * 2. Import supply shocks
. ****************************************************
. import excel "$bh_shocks/BH2_supply_shocks.xlsx", firstrow clear
(5 vars, 605 obs)

. 
. * Drop header rows - drop if shock value (B) is missing or non-numeric
. drop if missing(B)
(0 observations deleted)

. destring B, gen(supply_shock) force
B: contains nonnumeric characters; supply_shock generated as double
(1 missing value generated)

. drop if missing(supply_shock)
(1 observation deleted)

. 
. * Parse date string like "Feb-75" to year and month
. * Convert A to string if it's numeric
. capture confirm string variable A

. if _rc {
.     * A is numeric, convert to string
.     gen date_str = string(A, "%tdMon-YY")
. }

. else {
.     * A is already string
.     gen date_str = A
. }

. gen month_str = substr(date_str, 1, 3)

. gen year_str = substr(date_str, 5, 2)

. 
. gen month = .
(604 missing values generated)

. replace month = 1 if month_str == "Jan"
(50 real changes made)

. replace month = 2 if month_str == "Feb"
(51 real changes made)

. replace month = 3 if month_str == "Mar"
(51 real changes made)

. replace month = 4 if month_str == "Apr"
(51 real changes made)

. replace month = 5 if month_str == "May"
(51 real changes made)

. replace month = 6 if month_str == "Jun"
(50 real changes made)

. replace month = 7 if month_str == "Jul"
(50 real changes made)

. replace month = 8 if month_str == "Aug"
(50 real changes made)

. replace month = 9 if month_str == "Sep"
(50 real changes made)

. replace month = 10 if month_str == "Oct"
(50 real changes made)

. replace month = 11 if month_str == "Nov"
(50 real changes made)

. replace month = 12 if month_str == "Dec"
(50 real changes made)

. 
. destring year_str, gen(year_2digit)
year_str: all characters numeric; year_2digit generated as byte

. gen year = 1900 + year_2digit if year_2digit >= 50
(305 missing values generated)

. replace year = 2000 + year_2digit if year_2digit < 50
(305 real changes made)

. 
. * Create quarter from month
. gen quarter = ceil(month/3)

. 
. * Create quarterly date for merging
. gen qdate = yq(year, quarter)

. format qdate %tq

. 
. * Clean up temporary variables
. drop date_str month_str year_str year_2digit

. 
. * Collapse to quarterly (average monthly shocks within quarter)
. collapse (mean) supply_shock, by(qdate year quarter)

. 
. * Save temporary file
. tempfile supply

. save `supply'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. 
. ****************************************************
. * 3. Merge supply and demand shocks
. ****************************************************
. use `demand', clear

. merge 1:1 qdate using `supply'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               202  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Save combined shocks
. save "$deriv/bh_shocks_quarterly.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/bh_shocks_quar
    > terly.dta saved

. 
. ****************************************************
. * 4. Merge with quarterly Gini data
. ****************************************************
. use "$deriv/gini_1996_2023_quarterly.dta", clear

. 
. * Diagnostic: Check Gini data date range
. display _n "=== GINI DATA DIAGNOSTICS ==="

=== GINI DATA DIAGNOSTICS ===

. count
  108

. summarize qdate

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
       qdate |        108    201.0556    32.02593        144        255

. display "First 5 dates:"
First 5 dates:

. list qdate year quarter in 1/5

     +-------------------------+
     |  qdate   year   quarter |
     |-------------------------|
  1. | 1996q1   1996         1 |
  2. | 1996q2   1996         2 |
  3. | 1996q3   1996         3 |
  4. | 1996q4   1996         4 |
  5. | 1997q1   1997         1 |
     +-------------------------+

. display "Last 5 dates:"
Last 5 dates:

. count
  108

. local n_gini = r(N)

. list qdate year quarter in `=`n_gini'-4'/`n_gini'

     +-------------------------+
     |  qdate   year   quarter |
     |-------------------------|
104. | 2022q4   2022         4 |
105. | 2023q1   2023         1 |
106. | 2023q2   2023         2 |
107. | 2023q3   2023         3 |
108. | 2023q4   2023         4 |
     +-------------------------+

. 
. * Diagnostic: Check BH shocks date range
. preserve

. use "$deriv/bh_shocks_quarterly.dta", clear

. display _n "=== BH SHOCKS DATA DIAGNOSTICS ==="

=== BH SHOCKS DATA DIAGNOSTICS ===

. count
  202

. summarize qdate

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
       qdate |        202       160.5    58.45654         60        261

. display "First 5 dates:"
First 5 dates:

. list qdate year quarter in 1/5

     +-------------------------+
     |  qdate   year   quarter |
     |-------------------------|
  1. | 1975q1   1975         1 |
  2. | 1975q2   1975         2 |
  3. | 1975q3   1975         3 |
  4. | 1975q4   1975         4 |
  5. | 1976q1   1976         1 |
     +-------------------------+

. display "Last 5 dates:"
Last 5 dates:

. count
  202

. local n_shocks = r(N)

. list qdate year quarter in `=`n_shocks'-4'/`n_shocks'

     +-------------------------+
     |  qdate   year   quarter |
     |-------------------------|
198. | 2024q2   2024         2 |
199. | 2024q3   2024         3 |
200. | 2024q4   2024         4 |
201. | 2025q1   2025         1 |
202. | 2025q2   2025         2 |
     +-------------------------+

. restore

. 
. * Now merge
. merge 1:1 qdate using "$deriv/bh_shocks_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                            94
        from master                         0  (_merge==1)
        from using                         94  (_merge==2)

    Matched                               108  (_merge==3)
    -----------------------------------------

. display _n "=== MERGE RESULTS ==="

=== MERGE RESULTS ===

. tab _merge

   Matching result from |
                  merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
         Using only (2) |         94       46.53       46.53
            Matched (3) |        108       53.47      100.00
------------------------+-----------------------------------
                  Total |        202      100.00

. display _n "Sample of matched observations:"

Sample of matched observations:

. list qdate year quarter if _merge == 3 in 1/10

     +-------------------------+
     |  qdate   year   quarter |
     |-------------------------|
  1. | 1996q1   1996         1 |
  2. | 1996q2   1996         2 |
  3. | 1996q3   1996         3 |
  4. | 1996q4   1996         4 |
  5. | 1997q1   1997         1 |
     |-------------------------|
  6. | 1997q2   1997         2 |
  7. | 1997q3   1997         3 |
  8. | 1997q4   1997         4 |
  9. | 1998q1   1998         1 |
 10. | 1998q2   1998         2 |
     +-------------------------+

. display _n "Sample of Gini-only (unmatched):"

Sample of Gini-only (unmatched):

. list qdate year quarter if _merge == 1 in 1/10

. display _n "Sample of shocks-only (unmatched):"

Sample of shocks-only (unmatched):

. list qdate year quarter if _merge == 2 in 1/10

. 
. keep if _merge == 3  // Keep only matched observations
(94 observations deleted)

. drop _merge

. 
. * Sort and save final merged dataset
. sort qdate

. order qdate year quarter gini_core gini_broad demand_shock_agg demand_sho
> ck_oil supply_shock

. 
. label var demand_shock_agg "BH aggregate demand shock (economic activity)
> "

. label var demand_shock_oil "BH oil consumption demand shock (oil market)"

. label var supply_shock "BH supply shock"

. 
. save "$deriv/gini_bh_shocks_merged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_bh_shocks
    > _merged.dta saved

. 
. display _n "Saved: $deriv/gini_bh_shocks_merged.dta"

Saved: /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/
> gini_bh_shocks_merged.dta

. display _n "=== FINAL MERGED DATASET SUMMARY ==="

=== FINAL MERGED DATASET SUMMARY ===

. describe

Contains data from /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/
> CEX/derived/gini_bh_shocks_merged.dta
 Observations:           108                  
    Variables:            10                  12 Dec 2025 18:51
---------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------
qdate           float   %tq                   Stata quarterly date
year            float   %8.0g                 Year
quarter         float   %8.0g                 Quarter (. = annual)
gini_core       double  %10.0g                Gini coefficient - core
                                                consumption
gini_broad      double  %10.0g                Gini coefficient - broad
                                                consumption
demand_shock_~g double  %10.0g                BH aggregate demand shock
                                                (economic activity)
demand_shock_~l double  %10.0g                BH oil consumption demand
                                                shock (oil market)
supply_shock    double  %10.0g                BH supply shock
gini_fincbtax   double  %10.0g                Gini coefficient - income
                                                before taxes
gini_fsalaryx   double  %10.0g                Gini coefficient - salary
                                                income
---------------------------------------------------------------------------
Sorted by: qdate

. count
  108

. local n_final = r(N)

. display _n "First 10 observations:"

First 10 observations:

. list in 1/10

     +--------------------------------------------------------------+
  1. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1996q1 | 1996 |       1 | .55468213 | .49419832 | -.22148647 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |   .46885808   |  -.32788254   |  .48794494   |    .4469206   |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
  2. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1996q2 | 1996 |       2 | .56675941 | .50503184 |  .12724921 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |  -.83489113   |  -.01555055   |  .48039882   |   .44027883   |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
  3. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1996q3 | 1996 |       3 | .57520928 | .51438453 |   .1036368 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |   2.4496306   |  -.46768384   |  .47925651   |    .4351627   |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
  4. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1996q4 | 1996 |       4 | .55639912 | .49887649 |  .15237911 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |   .80256418   |   .15828993   |  .48211903   |   .44501452   |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
  5. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1997q1 | 1997 |       1 | .54642597 | .48424696 |  .33321874 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |  -4.4526498   |    .3023814   |  .47472963   |   .44305942   |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
  6. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1997q2 | 1997 |       2 | .55785435 | .49735394 |  .19591498 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |  -.53291956   |  -.07923579   |  .47345289   |   .44555976   |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
  7. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1997q3 | 1997 |       3 | .56695318 | .50885453 |  .14971218 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |   .57474204   |  -.12677552   |  .47236631   |   .44213179   |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
  8. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1997q4 | 1997 |       4 | .54984284 | .49451624 | -.22458995 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |  -2.5309945   |   -.2951791   |  .47498209   |   .44150127   |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
  9. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1998q1 | 1998 |       1 | .55603067 | .49286135 |  .04669203 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |  -1.7266199   |   1.4935128   |  .47864468   |   .43974221   |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
 10. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 1998q2 | 1998 |       2 | .57069699 | .50973879 | -.35200908 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |  -.43573239   |   .15393381   |  .47534157   |   .43696457   |
     +--------------------------------------------------------------+

. if `n_final' > 10 {
.     display _n "Last 10 observations:"

Last 10 observations:
.     list in `=`n_final'-9'/`n_final'

     +--------------------------------------------------------------+
 99. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2021q3 | 2021 |       3 | .58081106 | .51128158 | -.27989836 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |   2.5936906   |  -.71784132   |  .48531073   |   .45746486   |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
100. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2021q4 | 2021 |       4 | .56104589 |  .4941321 |  .91520046 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |   .05333804   |    .1080382   |  .48100253   |   .45328173   |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
101. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2022q1 | 2022 |       1 | .56151048 |  .4920461 | -.37518262 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |     5.75685   |  -.81347367   |  .47879043   |   .45564455   |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
102. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2022q2 | 2022 |       2 | .55958433 | .49410154 | -.03607096 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |   1.6260728   |  -.83130764   |  .48527403   |   .45941147   |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
103. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2022q3 | 2022 |       3 | .56590725 | .49909802 |  .16599138 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |  -1.1559269   |   .57953785   |  .48338702   |   .46019374   |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
104. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2022q4 | 2022 |       4 |  .5648933 | .49522039 | -.46528938 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |  -.56327645   |   -.5842276   |  .47741898   |   .45103259   |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
105. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2023q1 | 2023 |       1 |  .5637275 | .49166846 |  .42797086 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |   -1.471965   |   .09826106   |  .48617877   |   .45274866   |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
106. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2023q2 | 2023 |       2 | .57187048 | .50254818 | -.25151829 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |    .6693601   |  -.23768009   |  .47275295   |   .44480244   |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
107. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2023q3 | 2023 |       3 | .58067498 | .50861322 | -.28728549 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |   2.5030403   |  -1.0854051   |  .48360981   |    .4459636   |
     +--------------------------------------------------------------+

     +--------------------------------------------------------------+
108. |  qdate | year | quarter | gini_core | gini_br~d | demand_s~g |
     | 2023q4 | 2023 |       4 | .56300383 | .49200142 |  .03643316 |
     |---------------+----------------------------------------------|
     |  demand_s~l   |  supply_s~k   |  gini_fi~x   |   gini_fs~x   |
     |  -2.9591179   |   .24835329   |  .49226489   |   .45652635   |
     +--------------------------------------------------------------+
. }

. 
. 
. 
end of do-file

. 
. * Step 5: Merge FRED data
. display _n "=== Merging FRED data ===" _n

=== Merging FRED data ===


. do "$code/05_merge_fred_data.do"

. ****************************************************
. * 05_merge_fred_data.do
. * Import FRED data (industrial production, inflation, treasury yields)
. * Convert to quarterly and merge with Gini-BH shocks dataset
. ****************************************************
. 
. clear all

. set more off

. 
. global fred "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/FRED
> "

. global deriv "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX
> /derived"

. global code "/Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code"

. 
. ****************************************************
. * 1. Import 1-year Treasury yield (GS1)
. ****************************************************
. import delimited "$fred/GS1.csv", clear
(encoding automatically selected: ISO-8859-1)
(2 vars, 336 obs)

. 
. * Parse date and create quarterly date
. gen date = date(observation_date, "YMD")

. format date %td

. gen year = year(date)

. gen month = month(date)

. gen quarter = ceil(month/3)

. gen qdate = yq(year, quarter)

. format qdate %tq

. 
. * Rename variable (Stata converts CSV headers to lowercase)
. rename gs1 treasury_1yr

. 
. * Collapse to quarterly (average monthly rates)
. collapse (mean) treasury_1yr, by(qdate year quarter)

. 
. * Save temporary file
. tempfile gs1

. save `gs1'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000001
    saved as .dta format

. 
. display "Imported GS1: " _N " quarterly observations"
Imported GS1: 112 quarterly observations

. 
. ****************************************************
. * 2. Import Industrial Production (INDPRO)
. ****************************************************
. import delimited "$fred/INDPRO.csv", clear
(encoding automatically selected: ISO-8859-1)
(2 vars, 336 obs)

. 
. * Parse date and create quarterly date
. gen date = date(observation_date, "YMD")

. format date %td

. gen year = year(date)

. gen month = month(date)

. gen quarter = ceil(month/3)

. gen qdate = yq(year, quarter)

. format qdate %tq

. 
. * Rename variable and take log (Stata converts CSV headers to lowercase)
. rename indpro indpro_raw

. gen log_indpro = log(indpro_raw)

. drop indpro_raw

. 
. * Collapse to quarterly (average of log levels)
. collapse (mean) log_indpro, by(qdate year quarter)

. 
. * Save temporary file
. tempfile indpro

. save `indpro'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000002
    saved as .dta format

. 
. display "Imported INDPRO: " _N " quarterly observations"
Imported INDPRO: 112 quarterly observations

. 
. ****************************************************
. * 3. Import Headline CPI (CPIAUCSL)
. ****************************************************
. import delimited "$fred/CPIAUCSL.csv", clear
(encoding automatically selected: ISO-8859-1)
(2 vars, 336 obs)

. 
. * Parse date and create quarterly date
. gen date = date(observation_date, "YMD")

. format date %td

. gen year = year(date)

. gen month = month(date)

. gen quarter = ceil(month/3)

. gen qdate = yq(year, quarter)

. format qdate %tq

. 
. * Rename variable and take log (Stata converts CSV headers to lowercase)
. rename cpiaucsl cpi_headline_raw

. gen log_cpi_headline = log(cpi_headline_raw)

. drop cpi_headline_raw

. 
. * Collapse to quarterly (average of log levels)
. collapse (mean) log_cpi_headline, by(qdate year quarter)

. 
. * Compute quarterly inflation as log difference
. sort qdate

. gen infl_headline = log_cpi_headline - log_cpi_headline[_n-1]
(1 missing value generated)

. 
. * Save temporary file
. tempfile cpi_headline

. save `cpi_headline'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000003
    saved as .dta format

. 
. display "Imported CPIAUCSL: " _N " quarterly observations"
Imported CPIAUCSL: 112 quarterly observations

. 
. ****************************************************
. * 4. Import Core CPI (CPILFESL)
. ****************************************************
. import delimited "$fred/CPILFESL.csv", clear
(encoding automatically selected: ISO-8859-1)
(2 vars, 336 obs)

. 
. * Parse date and create quarterly date
. gen date = date(observation_date, "YMD")

. format date %td

. gen year = year(date)

. gen month = month(date)

. gen quarter = ceil(month/3)

. gen qdate = yq(year, quarter)

. format qdate %tq

. 
. * Rename variable and take log (Stata converts CSV headers to lowercase)
. rename cpilfesl cpi_core_raw

. gen log_cpi_core = log(cpi_core_raw)

. drop cpi_core_raw

. 
. * Collapse to quarterly (average of log levels)
. collapse (mean) log_cpi_core, by(qdate year quarter)

. 
. * Compute quarterly inflation as log difference
. sort qdate

. gen infl_core = log_cpi_core - log_cpi_core[_n-1]
(1 missing value generated)

. 
. * Save temporary file
. tempfile cpi_core

. save `cpi_core'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000004
    saved as .dta format

. 
. display "Imported CPILFESL: " _N " quarterly observations"
Imported CPILFESL: 112 quarterly observations

. 
. ****************************************************
. * 5. Import Unemployment Rate (UNRATE)
. ****************************************************
. import delimited "$fred/UNRATE.csv", clear
(encoding automatically selected: ISO-8859-1)
(2 vars, 336 obs)

. 
. * Parse date and create quarterly date
. gen date = date(observation_date, "YMD")

. format date %td

. gen year = year(date)

. gen month = month(date)

. gen quarter = ceil(month/3)

. gen qdate = yq(year, quarter)

. format qdate %tq

. 
. * Variable is already lowercase (no rename needed)
. * unrate is the variable name
. 
. * Collapse to quarterly (average monthly rates)
. collapse (mean) unrate, by(qdate year quarter)

. 
. * Save temporary file
. tempfile unrate

. save `unrate'
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_37588.000005
    saved as .dta format

. 
. display "Imported UNRATE: " _N " quarterly observations"
Imported UNRATE: 112 quarterly observations

. 
. ****************************************************
. * 6. Merge all FRED data together
. ****************************************************
. use `gs1', clear

. 
. merge 1:1 qdate using `indpro'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               112  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. merge 1:1 qdate using `cpi_headline'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               112  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. merge 1:1 qdate using `cpi_core'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               112  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. merge 1:1 qdate using `unrate'

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               112  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. * Save combined FRED data
. save "$deriv/fred_quarterly.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/fred_quarterly
    > .dta saved

. 
. display _n "=== FRED DATA SUMMARY ==="

=== FRED DATA SUMMARY ===

. describe

Contains data from /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/
> CEX/derived/fred_quarterly.dta
 Observations:           112                  
    Variables:            10                  12 Dec 2025 18:51
---------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------
year            float   %9.0g                 
quarter         float   %9.0g                 
qdate           float   %tq                   
treasury_1yr    float   %9.0g                 (mean) treasury_1yr
log_indpro      float   %9.0g                 (mean) log_indpro
log_cpi_headl~e float   %9.0g                 (mean) log_cpi_headline
infl_headline   float   %9.0g                 
log_cpi_core    float   %9.0g                 (mean) log_cpi_core
infl_core       float   %9.0g                 
unrate          float   %9.0g                 (mean) unrate
---------------------------------------------------------------------------
Sorted by: qdate

. summarize qdate

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
       qdate |        112       199.5    32.47563        144        255

. list in 1/10

     +----------------------------------------------------------+
  1. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1996 |       1 | 1996q1 | 5.123333 | 4.294415 | 5.043853 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |         .   |   5.100068   |          .   |   5.533333   |
     +----------------------------------------------------------+

     +----------------------------------------------------------+
  2. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1996 |       2 | 1996q2 | 5.663333 | 4.315837 | 5.052416 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |   .008563   |   5.105944   |   .0058756   |        5.5   |
     +----------------------------------------------------------+

     +----------------------------------------------------------+
  3. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1996 |       3 | 1996q3 | 5.783333 | 4.329019 | 5.058153 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |  .0057373   |   5.112387   |   .0064435   |   5.266666   |
     +----------------------------------------------------------+

     +----------------------------------------------------------+
  4. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1996 |       4 | 1996q4 |     5.48 | 4.343401 | 5.066803 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |  .0086498   |   5.118791   |   .0064034   |   5.333333   |
     +----------------------------------------------------------+

     +----------------------------------------------------------+
  5. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1997 |       1 | 1997q1 | 5.646667 | 4.362312 | 5.072879 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |  .0060759   |   5.124558   |   .0057673   |   5.233333   |
     +----------------------------------------------------------+

     +----------------------------------------------------------+
  6. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1997 |       2 | 1997q2 |     5.85 | 4.376868 | 5.075173 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |  .0022945   |   5.130884   |   .0063257   |          5   |
     +----------------------------------------------------------+

     +----------------------------------------------------------+
  7. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1997 |       3 | 1997q3 |     5.54 | 4.399949 | 5.080159 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |  .0049858   |   5.135209   |   .0043254   |   4.866667   |
     +----------------------------------------------------------+

     +----------------------------------------------------------+
  8. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1997 |       4 | 1997q4 | 5.483334 | 4.424819 | 5.085536 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |  .0053773   |   5.140882   |   .0056734   |   4.666667   |
     +----------------------------------------------------------+

     +----------------------------------------------------------+
  9. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1998 |       1 | 1998q1 | 5.313333 | 4.435836 | 5.087596 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |  .0020599   |   5.146912   |   .0060296   |   4.633333   |
     +----------------------------------------------------------+

     +----------------------------------------------------------+
 10. | year | quarter |  qdate | treasu~r | log_in~o | log_c~ne |
     | 1998 |       2 | 1998q2 |     5.41 | 4.442409 | 5.090882 |
     |----------------------------------------------------------|
     |  infl_h~e   |   log_c~re   |   infl_c~e   |     unrate   |
     |  .0032854   |   5.152519   |   .0056071   |        4.4   |
     +----------------------------------------------------------+

. 
. ****************************************************
. * 7. Merge with existing Gini-BH shocks dataset
. ****************************************************
. use "$deriv/gini_bh_shocks_merged.dta", clear

. 
. display _n "=== GINI-BH SHOCKS DATA ==="

=== GINI-BH SHOCKS DATA ===

. count
  108

. summarize qdate

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
       qdate |        108    201.0556    32.02593        144        255

. 
. * Merge with FRED data
. merge 1:1 qdate using "$deriv/fred_quarterly.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             4
        from master                         0  (_merge==1)
        from using                          4  (_merge==2)

    Matched                               108  (_merge==3)
    -----------------------------------------

. 
. display _n "=== MERGE RESULTS ==="

=== MERGE RESULTS ===

. tab _merge

   Matching result from |
                  merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
         Using only (2) |          4        3.57        3.57
            Matched (3) |        108       96.43      100.00
------------------------+-----------------------------------
                  Total |        112      100.00

. 
. * Keep only matched observations (or adjust as needed)
. keep if _merge == 3
(4 observations deleted)

. drop _merge

. 
. * Sort and order variables
. sort qdate

. order qdate year quarter gini_core gini_broad demand_shock_agg demand_sho
> ck_oil supply_shock ///
>     treasury_1yr log_indpro log_cpi_headline log_cpi_core infl_headline i
> nfl_core unrate

. 
. * Add variable labels
. label var treasury_1yr "1-year Treasury yield (%)"

. label var log_indpro "Log Industrial Production (quarterly average)"

. label var log_cpi_headline "Log Headline CPI (quarterly average)"

. label var log_cpi_core "Log Core CPI (quarterly average)"

. label var infl_headline "Headline inflation (quarterly, log difference)"

. label var infl_core "Core inflation (quarterly, log difference)"

. label var unrate "Unemployment rate (%)"

. 
. * Save final merged dataset
. save "$deriv/gini_bh_shocks_fred_merged.dta", replace
file /Volumes/SSD
    PRO/Github-forks/Chp3-EnergyIneq/Code/Data/CEX/derived/gini_bh_shocks
    > _fred_merged.dta saved

. 
. display _n "=== FINAL MERGED DATASET ==="

=== FINAL MERGED DATASET ===

. describe

Contains data from /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Data/
> CEX/derived/gini_bh_shocks_fred_merged.dta
 Observations:           108                  
    Variables:            17                  12 Dec 2025 18:51
---------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------
qdate           float   %tq                   Stata quarterly date
year            float   %8.0g                 Year
quarter         float   %8.0g                 Quarter (. = annual)
gini_core       double  %10.0g                Gini coefficient - core
                                                consumption
gini_broad      double  %10.0g                Gini coefficient - broad
                                                consumption
demand_shock_~g double  %10.0g                BH aggregate demand shock
                                                (economic activity)
demand_shock_~l double  %10.0g                BH oil consumption demand
                                                shock (oil market)
supply_shock    double  %10.0g                BH supply shock
treasury_1yr    float   %9.0g                 1-year Treasury yield (%)
log_indpro      float   %9.0g                 Log Industrial Production
                                                (quarterly average)
log_cpi_headl~e float   %9.0g                 Log Headline CPI (quarterly
                                                average)
log_cpi_core    float   %9.0g                 Log Core CPI (quarterly
                                                average)
infl_headline   float   %9.0g                 Headline inflation
                                                (quarterly, log difference)
infl_core       float   %9.0g                 Core inflation (quarterly,
                                                log difference)
unrate          float   %9.0g                 Unemployment rate (%)
gini_fincbtax   double  %10.0g                Gini coefficient - income
                                                before taxes
gini_fsalaryx   double  %10.0g                Gini coefficient - salary
                                                income
---------------------------------------------------------------------------
Sorted by: qdate

. count
  108

. local n_final = r(N)

. display _n "First 10 observations:"

First 10 observations:

. list in 1/10

     +-------------------------------------------------------------------+
  1. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 1996q1 | 1996  |       1  | .55468213  | .49419832  | -.22148647  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     |  .46885808  |  -.32788254  |  5.123333  |  4.294415  |  5.043853  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.100068 |        . |        . | 5.533333 | .48794494 |  .4469206 |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
  2. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 1996q2 | 1996  |       2  | .56675941  | .50503184  |  .12724921  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     | -.83489113  |  -.01555055  |  5.663333  |  4.315837  |  5.052416  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.105944 |  .008563 | .0058756 |      5.5 | .48039882 | .44027883 |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
  3. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 1996q3 | 1996  |       3  | .57520928  | .51438453  |   .1036368  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     |  2.4496306  |  -.46768384  |  5.783333  |  4.329019  |  5.058153  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.112387 | .0057373 | .0064435 | 5.266666 | .47925651 |  .4351627 |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
  4. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 1996q4 | 1996  |       4  | .55639912  | .49887649  |  .15237911  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     |  .80256418  |   .15828993  |      5.48  |  4.343401  |  5.066803  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.118791 | .0086498 | .0064034 | 5.333333 | .48211903 | .44501452 |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
  5. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 1997q1 | 1997  |       1  | .54642597  | .48424696  |  .33321874  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     | -4.4526498  |    .3023814  |  5.646667  |  4.362312  |  5.072879  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.124558 | .0060759 | .0057673 | 5.233333 | .47472963 | .44305942 |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
  6. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 1997q2 | 1997  |       2  | .55785435  | .49735394  |  .19591498  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     | -.53291956  |  -.07923579  |      5.85  |  4.376868  |  5.075173  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.130884 | .0022945 | .0063257 |        5 | .47345289 | .44555976 |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
  7. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 1997q3 | 1997  |       3  | .56695318  | .50885453  |  .14971218  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     |  .57474204  |  -.12677552  |      5.54  |  4.399949  |  5.080159  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.135209 | .0049858 | .0043254 | 4.866667 | .47236631 | .44213179 |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
  8. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 1997q4 | 1997  |       4  | .54984284  | .49451624  | -.22458995  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     | -2.5309945  |   -.2951791  |  5.483334  |  4.424819  |  5.085536  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.140882 | .0053773 | .0056734 | 4.666667 | .47498209 | .44150127 |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
  9. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 1998q1 | 1998  |       1  | .55603067  | .49286135  |  .04669203  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     | -1.7266199  |   1.4935128  |  5.313333  |  4.435836  |  5.087596  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.146912 | .0020599 | .0060296 | 4.633333 | .47864468 | .43974221 |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
 10. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 1998q2 | 1998  |       2  | .57069699  | .50973879  | -.35200908  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     | -.43573239  |   .15393381  |      5.41  |  4.442409  |  5.090882  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.152519 | .0032854 | .0056071 |      4.4 | .47534157 | .43696457 |
     +-------------------------------------------------------------------+

. if `n_final' > 10 {
.     display _n "Last 10 observations:"

Last 10 observations:
.     list in `=`n_final'-9'/`n_final'

     +-------------------------------------------------------------------+
 99. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 2021q3 | 2021  |       3  | .58081106  | .51128158  | -.27989836  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     |  2.5936906  |  -.71784132  |  .0766667  |  4.602325  |  5.609051  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.631673 | .0159225 | .0128717 | 5.066667 | .48531073 | .45746486 |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
100. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 2021q4 | 2021  |       4  | .56104589  |  .4941321  |  .91520046  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     |  .05333804  |    .1080382  |  .1966667  |  4.610566  |  5.630186  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.646942 | .0211349 | .0152688 |      4.2 | .48100253 | .45328173 |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
101. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 2022q1 | 2022  |       1  | .56151048  |  .4920461  | -.37518262  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     |    5.75685  |  -.81347367  |  .9633334  |  4.613069  |  5.651919  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     |  5.66307 | .0217333 | .0161281 | 3.833333 | .47879043 | .45564455 |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
102. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 2022q2 | 2022  |       2  | .55958433  | .49410154  | -.03607096  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     |  1.6260728  |  -.83130764  |       2.2  |  4.617728  |  5.675516  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.677337 | .0235972 | .0142674 | 3.633333 | .48527403 | .45941147 |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
103. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 2022q3 | 2022  |       3  | .56590725  | .49909802  |  .16599138  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     | -1.1559269  |   .57953785  |  3.396667  |  4.617135  |  5.688692  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.692535 |  .013176 | .0151982 | 3.533333 | .48338702 | .46019374 |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
104. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 2022q4 | 2022  |       4  |  .5648933  | .49522039  | -.46528938  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     | -.56327645  |   -.5842276  |  4.613333  |   4.61171  |  5.698764  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.705033 | .0100718 | .0124979 | 3.566667 | .47741898 | .45103259 |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
105. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 2023q1 | 2023  |       1  |  .5637275  | .49166846  |  .42797086  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     |  -1.471965  |   .09826106  |  4.766666  |  4.612366  |  5.707746  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.716918 | .0089817 | .0118847 | 3.533333 | .48617877 | .45274866 |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
106. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 2023q2 | 2023  |       2  | .57187048  | .50254818  | -.25151829  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     |   .6693601  |  -.23768009  |  4.943333  |  4.612801  |  5.715131  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.728368 | .0073853 | .0114503 | 3.533333 | .47275295 | .44480244 |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
107. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 2023q3 | 2023  |       3  | .58067498  | .50861322  | -.28728549  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     |  2.5030403  |  -1.0854051  |  5.393333  |  4.614351  |  5.723717  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.735732 | .0085859 | .0073638 | 3.666667 | .48360981 |  .4459636 |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
108. |  qdate | year  | quarter  | gini_core  | gini_br~d  | demand_s~g  |
     | 2023q4 | 2023  |       4  | .56300383  | .49200142  |  .03643316  |
     |-------------------------------------------------------------------|
     | demand_s~l  |  supply_s~k  |  treasu~r  |  log_in~o  |  log_c~ne  |
     | -2.9591179  |   .24835329  |      5.22  |  4.611601  |  5.730613  |
     |-------------------------------------------------------------------|
     | log_c~re | infl_h~e | infl_c~e |   unrate | gini_fi~x | gini_fs~x |
     | 5.744107 |  .006896 | .0083747 |      3.8 | .49226489 | .45652635 |
     +-------------------------------------------------------------------+
. }

. 
. display _n "Final dataset saved: $deriv/gini_bh_shocks_fred_merged.dta"

Final dataset saved: /Volumes/SSD PRO/Github-forks/Chp3-EnergyIneq/Code/Dat
> a/CEX/derived/gini_bh_shocks_fred_merged.dta

. 
. 
end of do-file

. 
. display _n "=== DONE ===" _n

=== DONE ===


. display "Final output: gini_bh_shocks_fred_merged.dta"
Final output: gini_bh_shocks_fred_merged.dta

. 
. 
end of do-file

. exit
